<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Buffer Overflow Examples, Overwriting a function pointer - protostar stack3 - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Buffer-Overflow-Examples-Overwriting-a-function-pointer-protostar-stack3"><a href="#Buffer-Overflow-Examples-Overwriting-a-function-pointer-protostar-stack3" class="headerlink" title="Buffer Overflow Examples, Overwriting a function pointer - protostar stack3"></a>Buffer Overflow Examples, Overwriting a function pointer - protostar stack3</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Hey I’m back again with another article , today I’m going to solve protostar stack3 but this time it’s going to be a bit different , In the last two articles I solved stack0 , stack1 and stack2 and I used the source code of the binaries to identify where the buffer overflow happens and what exploit to use. Now with stack3 we are given the source code but We are not going to use it, Instead of that we will use some practical techniques to solve this challenge. Because in a real situation we won’t have the source of the program right ? Let’s see<br><img src="/images/binary-exploitation/BOF3/0.png" alt=""></p>
<p>If you haven’t read my <a href="/binary-exploitation/bof2/">previous articles</a> about buffer overflow I recommend reading them first</p>
<h2 id="Stack3"><a href="#Stack3" class="headerlink" title="./Stack3"></a>./Stack3</h2><p>Let’s first look at the program and see what does it do.<br><code>./stack3</code><br><img src="/images/binary-exploitation/BOF3/1.png" alt=""><br>We don’t see any output so we should give it an argument. We need to confirm that the program is vulnerable to a buffer overflow so we can pass an argument of 100 chars and see what happens<br><code>python -c &quot;print &#39;A&#39; * 100&quot; | ./stack3</code><br><img src="/images/binary-exploitation/BOF3/2.png" alt=""><br>And we see a segfault which confirms that a buffer overflow happened , we also see this line : “calling function pointer , jumping to 0x41414141”<br>So now we have an idea about what’s happening here, There’s a function pointer that executes a function based on the given memory address of that function. That memory address is stored in a variable and we can overwrite that variable when we exceed the buffer. We see that the function pointer was calling the address <code>0x41414141</code> and <code>0x41</code> is the hex of “A”. Now we have to do two things. The first thing is to know where the buffer overflow happens, Because here we have given the program an argument of 100 chars but we don’t know exactly the size of the buffer. The second thing is to find the memory address of the function that we need to execute. Let’s see how to do that.</p>
<h2 id="Finding-the-size-of-the-buffer"><a href="#Finding-the-size-of-the-buffer" class="headerlink" title="Finding the size of the buffer"></a>Finding the size of the buffer</h2><p>To make things easier I compiled the program on my kali box to start testing there.<br>Metasploit has two scripts called <code>pattern_create</code> and <code>pattern_offset</code> , you can find them on kali in <code>/usr/share/metasploit-framework/tools/exploit</code><br><code>pattern_create</code> creats a unique string of a defined length so we will create a pattern of 100 chars.<br><code>./pattern_create.rb -l 100</code><br><img src="/images/binary-exploitation/BOF3/3.png" alt=""><br>Now let’s run the program in gdb , I’m using <a href="https://github.com/longld/peda" target="_blank" rel="noopener">gdb-peda</a><br>First we set a break point in <code>main</code>.<br><code>break *main</code><br>This makes the program break after the first instruction of the function main()<br><img src="/images/binary-exploitation/BOF3/4.png" alt=""><br>Then we <code>run</code> the program.<br><img src="/images/binary-exploitation/BOF3/5.png" alt=""><br>It stops at the break point. We do <code>c</code> to make it continue then pass our argument<br><img src="/images/binary-exploitation/BOF3/6.png" alt=""><br>The segfault happens and we see where it happened: <code>0x63413163</code><br><img src="/images/binary-exploitation/BOF3/7.png" alt=""><br>Now we will use <code>pattern_offset</code> to know what is the location of <code>0x63413163</code><br><code>./pattern_offset -l 100 -q 63413163</code><br><img src="/images/binary-exploitation/BOF3/8.png" alt=""><br>And we get exact match at offset 64 , This means that the buffer size is 64 chars and after that the overflow happens.</p>
<h2 id="Finding-the-memory-address-of-the-function"><a href="#Finding-the-memory-address-of-the-function" class="headerlink" title="Finding the memory address of the function"></a>Finding the memory address of the function</h2><p>If we do <code>info functions</code> from gdb it will list all the functions and their memory addresses , we can also do that with objdump. But what is the function we’re looking for ?<br><code>info functions</code><br><img src="/images/binary-exploitation/BOF3/9.png" alt=""><br>We see a lot of functions but the most interesting one is called “win” , but the address on my kali box will be different from the address on the protostar machine. We will return to protostar and use objdump to find it.<br><code>objdump -d stack3</code><br><img src="/images/binary-exploitation/BOF3/10.png" alt=""></p>
<p><img src="/images/binary-exploitation/BOF3/11.png" alt=""><br>And we got the address <code>0x08048424</code> </p>
<h2 id="Applying-the-exploit"><a href="#Applying-the-exploit" class="headerlink" title="Applying the exploit"></a>Applying the exploit</h2><p>Now we can easily build our exploit , we know that the buffer is 64 chars after that we can pass the address of the function and the function pointer will execute it.<br><code>python -c &quot;print &#39;A&#39; * 64 + &#39;\x24\x84\x04\x08&#39;&quot; | ./stack3</code><br><img src="/images/binary-exploitation/BOF3/12.png" alt=""><br>And we get the output “code flow changed successfully”<br>We solved it without the source , now let’s look at the source </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">win</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"code flow successfully changed\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">volatile</span> <span class="title">int</span> <span class="params">(*fp)</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line"> fp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> gets(<span class="built_in">buffer</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(fp) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"calling function pointer, jumping to 0x%08x\n"</span>, fp);</span><br><span class="line">  fp();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We see function <code>win()</code> is defined at the top then after that the function <code>main()</code> which defines the function pointer , sets a buffer of 64 chars to it , then sets its value to 0. After that it takes our argument and stores it in the buffer. The last thing is an if statement that checks if the function pointer value is changed from 0 then it calls the address of that new value.</p>
<p>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous articles</a> , Tweet about the article if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Binary Exploitation article : <a href="/binary-exploitation/bof2/">Buffer Overflow Examples, Overwriting a variable value on the stack - Protostar Stack1 , Stack2</a><br>Next Binary Exploitation article : <a href="/binary-exploitation/bof4/">Buffer Overflow Examples, Taking control of the instruction pointer - protostar stack4</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-01-08</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/binary-exploitation/">binary-exploitation</a>

      <a class="tag-link" href="/tags/binary-exploitation/" rel="tag">#binary-exploitation</a> <a class="tag-link" href="/tags/buffer-overflow/" rel="tag">#buffer-overflow</a> <a class="tag-link" href="/tags/c/" rel="tag">#c</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
